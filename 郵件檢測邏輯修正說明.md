# 郵件檢測邏輯修正說明

## 問題描述

用戶回報了一個問題：當用戶上傳包含 YouTube 連結的 LINE 聊天截圖時，系統錯誤地將其識別為「郵件詐騙」進行分析，而不是進行一般的圖片內容分析。

## 問題根因分析

通過分析日誌和程式碼，發現問題出現在 `image_handler.py` 和 `anti_fraud_clean_app.py` 中的郵件檢測邏輯：

### 原始問題
1. **過於寬鬆的時間關鍵詞**：原始邏輯將「週一」、「上午」、「下午」、「月」、「日」等時間相關詞彙都視為郵件特徵
2. **缺乏上下文判斷**：沒有區分 LINE 聊天截圖和真實郵件的上下文差異
3. **關鍵詞衝突**：LINE 聊天中的時間戳記格式與郵件時間格式相似，導致誤判

### 具體案例
用戶的 LINE 聊天截圖包含：
```
12:49
< Tristan 瑋璘 トリスタン
4月7日 週一
上午11:14
嗨
https://www.youtube.com/watch?v=YYKswtMRu5Y
```

其中「週一」和「上午」被錯誤識別為郵件特徵。

## 修正方案

### 1. 重新定義郵件特徵關鍵詞

**強郵件特徵**（必須包含才認為是郵件）：
- `"寄件者", "發信者", "主旨", "收件者", "From:", "To:", "Subject:"`
- `"發送時間", "收信時間", "回覆", "轉寄", "附件", "信箱"`

**弱郵件特徵**（在非聊天環境中可能表示郵件）：
- `"郵件", "email"`

### 2. 增加 LINE 聊天檢測

**LINE 聊天指標**：
- `"< ", "> "` - LINE 聊天中的用戶名稱格式
- `"上午11:", "下午", "上午", "PM", "AM"` - 時間格式但沒有郵件上下文
- `"https://www.youtube.com", "https://youtu.be"` - YouTube 連結
- `"https://line.me", "https://lin.ee"` - LINE 相關連結

### 3. 分層判斷邏輯

```python
if has_line_chat_indicators:
    # 如果是 LINE 聊天，只有在同時包含強郵件特徵和郵件地址時才認為是郵件
    return (has_strong_email_features and has_email_address is not None)
else:
    # 非 LINE 聊天的情況，包含強郵件特徵、弱郵件特徵、郵件地址或服務格式時，才認為是郵件
    return (has_strong_email_features or 
            has_weak_email_features or
            has_email_address is not None or 
            has_service_pattern)
```

## 修正文件

1. **image_handler.py**
   - 修正 `_contains_email_keywords()` 方法
   - 增加 LINE 聊天檢測邏輯
   - 實施分層判斷機制

2. **anti_fraud_clean_app.py**
   - 修正 `detect_fraud_with_chatgpt()` 函數中的郵件檢測邏輯
   - 同步應用相同的判斷標準

## 測試驗證

創建了四個測試案例來驗證修正效果：

1. ✅ **LINE聊天截圖**：包含時間戳記和 YouTube 連結 → 不應被識別為郵件
2. ✅ **真實郵件**：包含寄件者、收件者、主旨 → 應被識別為郵件  
3. ✅ **包含郵件地址的LINE聊天**：用戶在聊天中提到郵件地址 → 不應被識別為郵件
4. ✅ **包含郵件地址的真實郵件**：標準郵件格式 → 應被識別為郵件

所有測試案例均通過驗證。

## 效果

修正後的邏輯能夠：
- ✅ 正確識別 LINE 聊天截圖，避免誤判為郵件詐騙
- ✅ 保持對真實郵件的準確檢測能力
- ✅ 區分聊天中提到的郵件地址和真實郵件內容
- ✅ 提高整體檢測精確度，減少誤報

## 後續建議

1. **持續監控**：觀察修正後的實際運行效果，收集用戶反饋
2. **擴展指標**：根據實際使用情況，可能需要增加更多的聊天平台檢測指標
3. **機器學習**：考慮使用機器學習方法來更智能地區分不同類型的內容

---
*修正完成時間：2025年6月12日*
*修正人員：AI Assistant* 