#!/usr/bin/env python3
"""
é˜²è©é¨™çŸ¥è­˜åº«æ¨¡çµ„
åŒ…å«è©é¨™é¡å‹åˆ†é¡ã€é˜²ç¯„æªæ–½å’Œå°çŸ¥è­˜
"""

import json
import os
import logging
from typing import List

logger = logging.getLogger(__name__)

def load_fraud_tactics():
    """è¼‰å…¥è©é¨™æ‰‹æ³•è³‡æ–™"""
    try:
        with open('fraud_tactics.json', 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        logger.warning("fraud_tactics.json æª”æ¡ˆä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­è³‡æ–™")
        return get_default_fraud_tactics()
    except Exception as e:
        logger.error(f"è¼‰å…¥ fraud_tactics.json æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return get_default_fraud_tactics()

def get_default_fraud_tactics():
    """å–å¾—é è¨­çš„è©é¨™æ‰‹æ³•è³‡æ–™"""
    return {
        "å‡äº¤å‹æŠ•è³‡è©é¨™": {
            "description": "é€éäº¤å‹è»Ÿé«”æˆ–ç¤¾ç¾¤åª’é«”å»ºç«‹æ„Ÿæƒ…é—œä¿‚ï¼Œå†èª˜å°æŠ•è³‡è™›å‡å¹³å°",
            "keywords": ["æŠ•è³‡", "ç²åˆ©", "ç©©è³º", "å…§ç·š", "è€å¸«", "å¸¶å–®", "è·Ÿå–®", "äº¤å‹", "æ„Ÿæƒ…"],
            "risk_level": "æ¥µé«˜",
            "sop": [
                "ğŸš« çµ•å°ä¸è¦ç›¸ä¿¡ç¶²è·¯ä¸Šèªè­˜çš„äººæ¨è–¦çš„æŠ•è³‡",
                "ğŸ” ä»»ä½•æŠ•è³‡éƒ½è¦å…ˆæŸ¥è­‰å¹³å°æ˜¯å¦åˆæ³•",
                "ğŸŒ å¯åˆ°é‡‘ç®¡æœƒç¶²ç«™æŸ¥è©¢åˆæ³•æŠ•è³‡å¹³å°",
                "ğŸ›¡ï¸ ä¸è¦ä¸‹è¼‰ä¾†è·¯ä¸æ˜çš„æŠ•è³‡APP",
                "ğŸ’¡ è¨˜ä½ï¼šå¤©ä¸‹æ²’æœ‰ç©©è³ºä¸è³ çš„æŠ•è³‡"
            ]
        },
        "å‡ç¶²è³¼è©é¨™": {
            "description": "å»ºç«‹å‡çš„è³¼ç‰©ç¶²ç«™æˆ–åœ¨ç¤¾ç¾¤åª’é«”åˆŠç™»å‡å•†å“å»£å‘Š",
            "keywords": ["é™æ™‚å„ªæƒ ", "è¶…ä½åƒ¹", "æ¸…å€‰", "å…é‹", "è²¨åˆ°ä»˜æ¬¾", "ç§è¨Šä¸‹å–®"],
            "risk_level": "é«˜",
            "sop": [
                "ğŸš« é¿å…åœ¨ä¾†è·¯ä¸æ˜çš„ç¶²ç«™è³¼ç‰©",
                "ğŸ” è³¼è²·å‰å…ˆæŸ¥çœ‹è³£å®¶è©•åƒ¹å’Œå•†åº—è³‡è¨Š",
                "ğŸŒ ä½¿ç”¨æœ‰ä¿éšœçš„ä»˜æ¬¾æ–¹å¼",
                "ğŸ›¡ï¸ åƒ¹æ ¼éä½çš„å•†å“è¦ç‰¹åˆ¥å°å¿ƒ",
                "ğŸ’¡ è¨˜ä½ï¼šä¾¿å®œæ²’å¥½è²¨ï¼Œå¥½è²¨ä¸ä¾¿å®œ"
            ]
        },
        "å‡å†’æ©Ÿæ§‹è©é¨™": {
            "description": "å†’å……æ”¿åºœæ©Ÿé—œã€éŠ€è¡Œã€é›»ä¿¡å…¬å¸ç­‰è¦æ±‚æä¾›å€‹è³‡æˆ–è½‰å¸³",
            "keywords": ["å¥ä¿", "åœ‹ç¨…å±€", "æ³•é™¢", "æª¢å¯Ÿå®˜", "è­¦å¯Ÿ", "éŠ€è¡Œ", "ä¿¡ç”¨å¡", "å¸³æˆ¶ç•°å¸¸"],
            "risk_level": "æ¥µé«˜",
            "sop": [
                "ğŸš« æ”¿åºœæ©Ÿé—œä¸æœƒé›»è©±è¦æ±‚è½‰å¸³æˆ–æä¾›å¯†ç¢¼",
                "ğŸ” æ¥åˆ°å¯ç–‘é›»è©±è¦æ›æ–·å¾Œä¸»å‹•å›æ’¥å®˜æ–¹é›»è©±ç¢ºèª",
                "ğŸŒ å¯æ’¥æ‰“165åè©é¨™å°ˆç·šæŸ¥è­‰",
                "ğŸ›¡ï¸ ä¸è¦é€éœ²å€‹äººè³‡æ–™å’Œå¸³æˆ¶è³‡è¨Š",
                "ğŸ’¡ è¨˜ä½ï¼šçœŸçš„å…¬å‹™å“¡ä¸æœƒè¦ä½ è½‰å¸³"
            ]
        },
        "å‡è¦ªå‹æ€¥é›£è©é¨™": {
            "description": "å†’å……è¦ªå‹è²ç¨±é‡åˆ°ç·Šæ€¥ç‹€æ³éœ€è¦é‡‘éŒ¢å”åŠ©",
            "keywords": ["æ€¥ç”¨éŒ¢", "å‡ºè»Šç¦", "ä½é™¢", "è¢«é—œ", "æ‰‹æ©Ÿå£äº†", "æ›è™Ÿç¢¼"],
            "risk_level": "é«˜",
            "sop": [
                "ğŸš« ä¸è¦ç«‹å³åŒ¯æ¬¾ï¼Œå…ˆç¢ºèªå°æ–¹èº«ä»½",
                "ğŸ” ç”¨å…¶ä»–æ–¹å¼è¯çµ¡ç•¶äº‹äººç¢ºèª",
                "ğŸŒ è©¢å•åªæœ‰çœŸæ­£è¦ªå‹æ‰çŸ¥é“çš„äº‹æƒ…",
                "ğŸ›¡ï¸ è¦æ±‚è¦–è¨Šé€šè©±æˆ–ç•¶é¢ç¢ºèª",
                "ğŸ’¡ è¨˜ä½ï¼šçœŸæ­£çš„è¦ªå‹ä¸æœƒåªç”¨è¨Šæ¯è¦éŒ¢"
            ]
        },
        "å‡æ±‚è·è©é¨™": {
            "description": "åˆŠç™»å‡çš„é«˜è–ªå·¥ä½œæ©Ÿæœƒï¼Œè¦æ±‚å…ˆç¹³è²»æˆ–æä¾›å€‹è³‡",
            "keywords": ["é«˜è–ª", "åœ¨å®¶å·¥ä½œ", "è¼•é¬†è³ºéŒ¢", "ä¿è­‰éŒ„å–", "å…ˆç¹³è²»", "ä¿è­‰é‡‘"],
            "risk_level": "ä¸­é«˜",
            "sop": [
                "ğŸš« æ­£ç•¶å·¥ä½œä¸æœƒè¦æ±‚å…ˆç¹³éŒ¢",
                "ğŸ” æŸ¥è­‰å…¬å¸æ˜¯å¦çœŸå¯¦å­˜åœ¨",
                "ğŸŒ åˆ°å‹å‹•éƒ¨ç¶²ç«™æŸ¥è©¢åˆæ³•è·ç¼º",
                "ğŸ›¡ï¸ é¢è©¦åœ°é»è¦é¸åœ¨æ­£ç•¶å ´æ‰€",
                "ğŸ’¡ è¨˜ä½ï¼šå¤©ä¸‹æ²’æœ‰å…è²»çš„åˆé¤"
            ]
        }
    }

def get_fraud_features(fraud_type, fraud_message):
    """å–å¾—ç‰¹å®šè©é¨™é¡å‹çš„ç‰¹å¾µå’Œå»ºè­°"""
    fraud_tactics = load_fraud_tactics()
    
    if fraud_type in fraud_tactics:
        fraud_info = fraud_tactics[fraud_type]
        return {
            "type": fraud_type,
            "description": fraud_info["description"],
            "risk_level": fraud_info["risk_level"],
            "prevention_tips": fraud_info["sop"],
            "keywords": fraud_info["keywords"]
        }
    
    # å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šé¡å‹ï¼Œè¿”å›é€šç”¨å»ºè­°
    return {
        "type": "ä¸€èˆ¬è©é¨™",
        "description": "å¯ç–‘çš„è©é¨™è¨Šæ¯",
        "risk_level": "ä¸­",
        "prevention_tips": [
            "ğŸš« ä¸è¦è¼•æ˜“ç›¸ä¿¡é™Œç”Ÿäººçš„è¨Šæ¯",
            "ğŸ” é‡åˆ°å¯ç–‘è¨Šæ¯è¦å¤šæ–¹æŸ¥è­‰",
            "ğŸŒ å¯æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢",
            "ğŸ›¡ï¸ ä¿è­·å€‹äººè³‡æ–™ä¸å¤–æ´©",
            "ğŸ’¡ è¨˜ä½ï¼šå°å¿ƒé§›å¾—è¬å¹´èˆ¹"
        ],
        "keywords": []
    }

def get_anti_fraud_tips():
    """å–å¾—é˜²è©é¨™å°çŸ¥è­˜"""
    tips = [
        "ğŸ’¡ è¨˜ä½165åè©é¨™å°ˆç·šï¼Œé‡åˆ°å¯ç–‘ç‹€æ³ç«‹å³æ’¥æ‰“ï¼",
        "ğŸš« ä»»ä½•è¦æ±‚å…ˆä»˜éŒ¢çš„å·¥ä½œæ©Ÿæœƒéƒ½è¦å°å¿ƒï¼Œæ­£ç•¶å·¥ä½œä¸æœƒè¦æ±‚å…ˆç¹³è²»ï¼",
        "ğŸ” ç¶²è·¯è³¼ç‰©æ™‚è¦é¸æ“‡æœ‰ä¿éšœçš„ä»˜æ¬¾æ–¹å¼ï¼Œé¿å…ä½¿ç”¨ä¾†è·¯ä¸æ˜çš„ç¶²ç«™ï¼",
        "ğŸŒ æ”¿åºœæ©Ÿé—œä¸æœƒé€éé›»è©±è¦æ±‚æä¾›å¯†ç¢¼æˆ–è½‰å¸³ï¼Œæ¥åˆ°é€™ç¨®é›»è©±è¦ç«‹å³æ›æ–·ï¼",
        "ğŸ›¡ï¸ æŠ•è³‡ç†è²¡è¦é€éåˆæ³•ç®¡é“ï¼Œå¯åˆ°é‡‘ç®¡æœƒç¶²ç«™æŸ¥è©¢åˆæ³•æ¥­è€…ï¼",
        "ğŸ’° å¤©ä¸‹æ²’æœ‰ç©©è³ºä¸è³ çš„æŠ•è³‡ï¼Œé«˜å ±é…¬å¿…å®šä¼´éš¨é«˜é¢¨éšªï¼",
        "ğŸ“± ä¸è¦éš¨æ„ä¸‹è¼‰ä¾†è·¯ä¸æ˜çš„APPï¼Œç‰¹åˆ¥æ˜¯æŠ•è³‡æˆ–å€Ÿè²¸ç›¸é—œçš„ï¼",
        "ğŸ‘¥ é‡åˆ°è¦ªå‹æ€¥éœ€ç”¨éŒ¢çš„è¨Šæ¯ï¼Œè¦ç”¨å…¶ä»–æ–¹å¼ç¢ºèªèº«ä»½å†è¡Œå‹•ï¼",
        "ğŸ¯ ä¾¿å®œæ²’å¥½è²¨ï¼Œåƒ¹æ ¼éä½çš„å•†å“è¦ç‰¹åˆ¥å°å¿ƒæ˜¯å¦ç‚ºè©é¨™ï¼",
        "ğŸ” å€‹äººè³‡æ–™è¦å¦¥å–„ä¿ç®¡ï¼Œä¸è¦éš¨æ„æä¾›çµ¦é™Œç”Ÿäººï¼"
    ]
    
    return tips

def get_random_anti_fraud_tip():
    """å–å¾—éš¨æ©Ÿçš„é˜²è©é¨™å°çŸ¥è­˜"""
    tips = get_anti_fraud_tips()
    import random
    return random.choice(tips)

def analyze_fraud_keywords(message: str) -> List[str]:
    """
    åˆ†æè¨Šæ¯ä¸­çš„è©é¨™é—œéµè©
    
    Args:
        message: è¦åˆ†æçš„è¨Šæ¯
        
    Returns:
        åŒ¹é…çš„è©é¨™é¡å‹åˆ—è¡¨
    """
    if not message:
        return []
    
    message_lower = message.lower()
    matched_types = []
    
    # è©é¨™é—œéµè©å­—å…¸
    fraud_keywords = {
        "æŠ•è³‡è©é¨™": ["æŠ•è³‡", "ç©©è³º", "ä¿è­‰ç²åˆ©", "é«˜å ±é…¬", "é›¶é¢¨éšª", "å…§ç·šæ¶ˆæ¯", "é£†è‚¡"],
        "è³¼ç‰©è©é¨™": ["é™æ™‚å„ªæƒ ", "è¶…ä½åƒ¹", "å…è²»è´ˆé€", "å…ˆä»˜æ¬¾", "è²¨åˆ°ä»˜æ¬¾"],
        "äº¤å‹è©é¨™": ["äº¤å‹", "èªè­˜", "å¯‚å¯", "é™ªä¼´", "å€ŸéŒ¢", "æ€¥ç”¨"],
        "å‡å†’è©é¨™": ["éŠ€è¡Œ", "å®¢æœ", "å¸³æˆ¶ç•°å¸¸", "å‡çµ", "é©—è­‰", "èº«åˆ†è­‰"],
        "ä¸­çè©é¨™": ["ä¸­ç", "æ­å–œ", "ç²å¾—", "çé‡‘", "æ‰‹çºŒè²»", "ç¨…é‡‘"],
        "é‡£é­šè©é¨™": ["é»æ“Šé€£çµ", "ç«‹å³è™•ç†", "é¦¬ä¸Š", "ç·Šæ€¥", "é©—è­‰ç¢¼"]
    }
    
    # æª¢æŸ¥æ¯ç¨®è©é¨™é¡å‹çš„é—œéµè©
    for fraud_type, keywords in fraud_keywords.items():
        for keyword in keywords:
            if keyword in message_lower:
                if fraud_type not in matched_types:
                    matched_types.append(fraud_type)
                break
    
    return matched_types

def get_risk_level_color(risk_level):
    """æ ¹æ“šé¢¨éšªç­‰ç´šå–å¾—å°æ‡‰é¡è‰²"""
    color_map = {
        "æ¥µé«˜": "#FF0000",  # ç´…è‰²
        "é«˜": "#FF6600",    # æ©™è‰²  
        "ä¸­é«˜": "#FF9900",  # æ©™é»ƒè‰²
        "ä¸­": "#FFCC00",    # é»ƒè‰²
        "ä½": "#00CC00",    # ç¶ è‰²
        "æ¥µä½": "#00FF00"   # äº®ç¶ è‰²
    }
    return color_map.get(risk_level, "#FFCC00")  # é è¨­é»ƒè‰²

def get_risk_level_emoji(risk_level):
    """æ ¹æ“šé¢¨éšªç­‰ç´šå–å¾—å°æ‡‰emoji"""
    emoji_map = {
        "æ¥µé«˜": "ğŸš¨",
        "é«˜": "âš ï¸", 
        "ä¸­é«˜": "âš ï¸",
        "ä¸­": "âš¡",
        "ä½": "âœ…",
        "æ¥µä½": "âœ…"
    }
    return emoji_map.get(risk_level, "âš¡")  # é è¨­è­¦å‘Šç¬¦è™Ÿ 