# -*- coding: utf-8 -*-
import os
import json
from flask import Flask, request, abort, render_template, jsonify
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError, LineBotApiError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage, FlexSendMessage,
    QuickReply, QuickReplyButton, MessageAction, PostbackEvent, PostbackAction,
    BubbleContainer, BoxComponent, ButtonComponent, TextComponent,
    CarouselContainer, URIAction, SeparatorComponent, 
    ImageSendMessage, Sender, SendMessage
)
from dotenv import load_dotenv
import openai
import logging
from firebase_manager import FirebaseManager
import random
import datetime  # å°å…¥datetimeç”¨æ–¼æ™‚é–“æ¯”è¼ƒ
import re
import time
import requests
from urllib.parse import urlparse

# æŒ‡å®š .env æ–‡ä»¶çš„è·¯å¾‘
# å‡è¨­ anti-fraud-clean å’Œ linebot-anti-fraud æ˜¯åŒç´šç›®éŒ„
dotenv_path = os.path.join(os.path.dirname(__file__), '..', 'linebot-anti-fraud', '.env')
load_dotenv(dotenv_path=dotenv_path)

# çŸ­ç¶²å€æœå‹™çš„åŸŸååˆ—è¡¨
SHORT_URL_DOMAINS = [
    'bit.ly', 'tinyurl.com', 'goo.gl', 'is.gd', 'buff.ly', 
    'ow.ly', 't.co', 'rebrand.ly', 'cutt.ly', 'shorturl.at',
    'urls.tw', 'ppt.cc', 'reurl.cc', 'lihi.vip', 'lihi1.com', 
    'lihi2.cc', 'lihi3.cc', 'tny.im', 'tinyurl.app'
]

# å°ç£å¸¸ç”¨çš„å¯é ç¶²ç«™åŸŸåç™½åå–®
SAFE_DOMAINS = {
    # æ”¿åºœæ©Ÿé—œ
    "gov.tw": "å°ç£æ”¿åºœæ©Ÿé—œé€šç”¨ç¶²åŸŸ",
    "president.gov.tw": "ç¸½çµ±åºœå®˜æ–¹ç¶²ç«™",
    "ey.gov.tw": "è¡Œæ”¿é™¢å®˜æ–¹ç¶²ç«™",
    "mof.gov.tw": "è²¡æ”¿éƒ¨å®˜æ–¹ç¶²ç«™",
    "moi.gov.tw": "å…§æ”¿éƒ¨å®˜æ–¹ç¶²ç«™",
    "moea.gov.tw": "ç¶“æ¿Ÿéƒ¨å®˜æ–¹ç¶²ç«™",
    "most.gov.tw": "ç§‘æŠ€éƒ¨å®˜æ–¹ç¶²ç«™ (ç¾ç‚ºåœ‹å®¶ç§‘å­¸åŠæŠ€è¡“å§”å“¡æœƒ nstc.gov.tw)",
    "mohw.gov.tw": "è¡›ç”Ÿç¦åˆ©éƒ¨å®˜æ–¹ç¶²ç«™",
    "moe.gov.tw": "æ•™è‚²éƒ¨å®˜æ–¹ç¶²ç«™",
    "mol.gov.tw": "å‹å‹•éƒ¨å®˜æ–¹ç¶²ç«™",
    "coa.gov.tw": "è¾²æ¥­å§”å“¡æœƒå®˜æ–¹ç¶²ç«™ (ç¾ç‚ºè¾²æ¥­éƒ¨ moa.gov.tw)",
    "motc.gov.tw": "äº¤é€šéƒ¨å®˜æ–¹ç¶²ç«™",
    "mnd.gov.tw": "åœ‹é˜²éƒ¨å®˜æ–¹ç¶²ç«™",
    "mac.gov.tw": "å¤§é™¸å§”å“¡æœƒå®˜æ–¹ç¶²ç«™",
    "ocac.gov.tw": "åƒ‘å‹™å§”å“¡æœƒå®˜æ–¹ç¶²ç«™",
    "ndc.gov.tw": "åœ‹å®¶ç™¼å±•å§”å“¡æœƒå®˜æ–¹ç¶²ç«™",
    "dgpa.gov.tw": "è¡Œæ”¿é™¢äººäº‹è¡Œæ”¿ç¸½è™•å®˜æ–¹ç¶²ç«™",
    "cec.gov.tw": "ä¸­å¤®é¸èˆ‰å§”å“¡æœƒå®˜æ–¹ç¶²ç«™",
    "cy.gov.tw": "ç›£å¯Ÿé™¢å®˜æ–¹ç¶²ç«™",
    "judicial.gov.tw": "å¸æ³•é™¢å®˜æ–¹ç¶²ç«™",

    # éŠ€è¡Œé‡‘è
    "bot.com.tw": "è‡ºç£éŠ€è¡Œ",
    "landbank.com.tw": "åœŸåœ°éŠ€è¡Œ",
    "tcb-bank.com.tw": "åˆä½œé‡‘åº«éŠ€è¡Œ",
    "hncb.com.tw": "è¯å—éŠ€è¡Œ",
    "firstbank.com.tw": "ç¬¬ä¸€éŠ€è¡Œ",
    "hua-nan.com.tw": "è¯å—éŠ€è¡Œ (åŒhncb.com.tw)",  # å¯èƒ½æ˜¯èˆŠç¶²åŸŸæˆ–ç‰¹å®šæœå‹™
    "megabank.com.tw": "å…†è±åœ‹éš›å•†æ¥­éŠ€è¡Œ",
    "ctbcbank.com": "ä¸­åœ‹ä¿¡è¨—éŠ€è¡Œ",
    "fubon.com": "å¯Œé‚¦é‡‘æ§/å¯Œé‚¦éŠ€è¡Œ",
    "esunbank.com.tw": "ç‰å±±éŠ€è¡Œ",
    "taishinbank.com.tw": "å°æ–°éŠ€è¡Œ",
    "sinopac.com": "æ°¸è±éŠ€è¡Œ/æ°¸è±é‡‘æ§",
    "cathaybk.com.tw": "åœ‹æ³°ä¸–è¯éŠ€è¡Œ",  # ä¿®æ­£: cathaybank -> cathaybk (æ›´å¸¸è¦‹)
    "skbank.com.tw": "æ–°å…‰éŠ€è¡Œ",
    "sunnybank.com.tw": "é™½ä¿¡éŠ€è¡Œ",
    "kgibank.com": "å‡±åŸºéŠ€è¡Œ",
    "yuantabank.com.tw": "å…ƒå¤§éŠ€è¡Œ",
    "jihsunbank.com.tw": "æ—¥ç››éŠ€è¡Œ (å·²ä½µå…¥å¯Œé‚¦)",
    "entiebank.com.tw": "å®‰æ³°éŠ€è¡Œ",

    # é›»å•†è³¼ç‰©
    "pchome.com.tw": "PChome ç·šä¸Šè³¼ç‰©å…¥å£",
    "24h.pchome.com.tw": "PChome 24h è³¼ç‰©",
    "shopping.pchome.com.tw": "PChome å•†åº—è¡—",
    "ruten.com.tw": "éœ²å¤©æ‹è³£ (C2Cæ‹è³£å¹³å°)",
    "momoshop.com.tw": "momo è³¼ç‰©ç¶²",
    "books.com.tw": "åšå®¢ä¾† (ç¶²è·¯æ›¸åº—ã€ç™¾è²¨)",
    "eslite.com": "èª å“ç·šä¸Š (æ›¸åº—ã€æ–‡å‰µã€ç”Ÿæ´»)",
    "shopee.tw": "è¦çš®è³¼ç‰©",
    "yahoo.com.tw": "Yahooå¥‡æ‘©å…¥å£ç¶²ç«™",
    "bid.yahoo.com.tw": "Yahooå¥‡æ‘©æ‹è³£",
    "buy.yahoo.com.tw": "Yahooå¥‡æ‘©è³¼ç‰©ä¸­å¿ƒ",
    "carrefour.com.tw": "å®¶æ¨‚ç¦ç·šä¸Šè³¼ç‰©/é–€å¸‚è³‡è¨Š",
    "costco.com.tw": "å¥½å¸‚å¤šç·šä¸Šè³¼ç‰©/æœƒå“¡è³‡è¨Š",
    "ikea.com.tw": "IKEA å®œå®¶å®¶å±…ç·šä¸Šè³¼ç‰©/ç”¢å“è³‡è¨Š",
    "hola.com.tw": "HOLA ç‰¹åŠ›å’Œæ¨‚ (å®¶å±…ç”¨å“)",
    "friday.tw": "friDayè³¼ç‰© (é å‚³æ——ä¸‹é›»å•†)",
    "etmall.com.tw": "æ±æ£®è³¼ç‰©ç¶²",
    "rakuten.com.tw": "æ¨‚å¤©å¸‚å ´ (æ—¥æœ¬é›»å•†å°ç£ç«™)",
    "gohappy.com.tw": "GoHappy å¿«æ¨‚è³¼ç‰©ç¶² (é æ±é›†åœ˜æ——ä¸‹, ç¾å¤šæ•´åˆè‡³SOGOç™¾è²¨ç­‰)",

    # æ–°èåª’é«”
    "udn.com": "è¯åˆæ–°èç¶²",
    "chinatimes.com": "ä¸­æ™‚æ–°èç¶²",
    "ltn.com.tw": "è‡ªç”±æ™‚å ±é›»å­å ±",
    "appledaily.com.tw": "è˜‹æœæ–°èç¶² (å°ç£)",  # æ³¨æ„ï¼šå¯èƒ½å·²åœæ­¢ç‡Ÿé‹æˆ–è½‰å‹
    "tvbs.com.tw": "TVBS æ–°èç¶²",
    "cts.com.tw": "è¯è¦–æ–°èç¶²",
    "ftv.com.tw": "æ°‘è¦–æ–°èç¶²",
    "settv.com.tw": "ä¸‰ç«‹æ–°èç¶²",
    "ettoday.net": "ETtoday æ–°èé›²",
    "nownews.com": "NOWnews ä»Šæ—¥æ–°è",
    "storm.mg": "é¢¨å‚³åª’ (ç¶²è·¯åª’é«”)",
    "thenewslens.com": "é—œéµè©•è«–ç¶² (ç¶²è·¯åª’é«”)",
    "cna.com.tw": "ä¸­å¤®é€šè¨Šç¤¾",
    "rti.org.tw": "ä¸­å¤®å»£æ’­é›»è‡º (Radio Taiwan International)",
    "pts.org.tw": "å…¬å…±é›»è¦–",
    "bcc.com.tw": "ä¸­å»£æ–°èç¶² (ä¸­åœ‹å»£æ’­å…¬å¸)",

    # ç§‘æŠ€å…¬å¸
    "asus.com": "è¯ç¢© (é›»è…¦ç¡¬é«”ã€æ‰‹æ©Ÿ)",
    "acer.com": "å®ç¢ (é›»è…¦ç¡¬é«”)",
    "msi.com": "å¾®æ˜Ÿç§‘æŠ€ (é›»è…¦ç¡¬é«”ã€é›»ç«¶)",
    "gigabyte.com": "æŠ€å˜‰ç§‘æŠ€ (é›»è…¦ç¡¬é«”)",
    "asrock.com": "è¯æ“ç§‘æŠ€ (ä¸»æ©Ÿæ¿ã€é›»è…¦ç¡¬é«”)",
    "htc.com": "HTC (æ‰‹æ©Ÿã€VRè£ç½®)",
    "mediatek.com": "è¯ç™¼ç§‘ (æ™¶ç‰‡è¨­è¨ˆ)",
    "tsmc.com": "å°ç©é›» (æ™¶åœ“ä»£å·¥)",
    "foxconn.com": "é´»æµ·/å¯Œå£«åº· (é›»å­ä»£å·¥)",
    "quanta.com": "å»£é”é›»è…¦ (ç­†é›»ä»£å·¥ã€é›²ç«¯ç¡¬é«”)",
    "wistron.com": "ç·¯å‰µè³‡é€š (è³‡è¨ŠåŠé€šè¨Šç”¢å“ä»£å·¥)",
    "inventec.com": "è‹±æ¥­é” (ç­†é›»ä»£å·¥ã€ä¼ºæœå™¨)",
    "compal.com": "ä»å¯¶é›»è…¦ (ç­†é›»ä»£å·¥)",
    "pegatron.com": "å’Œç¢©è¯åˆç§‘æŠ€ (é›»å­ä»£å·¥)",
    "technews.tw": "ç§‘æŠ€æ–°å ± (ç§‘æŠ€æ–°èç¶²ç«™)",

    # é›»ä¿¡æ¥­è€…
    "cht.com.tw": "ä¸­è¯é›»ä¿¡",  # ä¿®æ­£ï¼šchunghwa.com.tw -> cht.com.tw (æ›´å¸¸ç”¨)
    "taiwanmobile.com": "å°ç£å¤§å“¥å¤§",
    "fetnet.net": "é å‚³é›»ä¿¡",
    "aptg.com.tw": "äºå¤ªé›»ä¿¡ (å·²è¢«é å‚³åˆä½µ)",
    "gt.com.tw": "Gtæ™ºæ…§ç”Ÿæ´» (äºå¤ªé›»ä¿¡æ——ä¸‹å“ç‰Œ, å·²è¢«é å‚³åˆä½µ)",
    "so-net.net.tw": "So-net (ISP, å°ç£ç¢©ç¶²)",
    "seed.net.tw": "Seednet (ISP, é å‚³æ——ä¸‹)",  # ä¿®æ­£ï¼šseednet.net -> seed.net.tw
    "hinet.net": "HiNet (ä¸­è¯é›»ä¿¡ç¶²è·¯æœå‹™)",

    # äº¤é€šé‹è¼¸
    "railway.gov.tw": "è‡ºç£éµè·¯ç®¡ç†å±€ (å°éµ) å®˜æ–¹ç¶²ç«™",
    "thsrc.com.tw": "å°ç£é«˜éµå®˜æ–¹ç¶²ç«™",
    "taoyuan-airport.com": "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´å®˜æ–¹ç¶²ç«™",
    "ksf.gov.tw": "äº¤é€šéƒ¨èˆªæ¸¯å±€ (æµ·é‹ç›¸é—œ)",  # ä¿®æ­£: å‡è¨­ KSF æŒ‡ Kaohsiung Shipping & Ferry, ä½†æ›´å¯èƒ½æ˜¯èˆªæ¸¯å±€
    "klcg.gov.tw": "åŸºéš†å¸‚æ”¿åºœ (å¯èƒ½åŒ…å«äº¤é€šè³‡è¨Š)",
    "trtc.com.tw": "å°åŒ—æ·é‹å…¬å¸",
    "krtc.com.tw": "é«˜é›„æ·é‹å…¬å¸",
    "kmrt.com.tw": "é«˜é›„æ·é‹ (åŒä¸Š, å¯èƒ½æ˜¯ä¸åŒç¶²åŸŸæˆ–ç‰¹å®šæœå‹™)",
    "ubus.com.tw": "çµ±è¯å®¢é‹",
    "ebus.gov.tw": "å…¬è·¯å®¢é‹å³æ™‚å‹•æ…‹è³‡è¨Šç¶² (iBus)",
    "motc.gov.tw": "äº¤é€šéƒ¨å®˜æ–¹ç¶²ç«™ (å·²åˆ—æ–¼æ”¿åºœæ©Ÿé—œ)",  # é‡è¤‡ï¼Œå¯åˆªé™¤æˆ–è¨»è¨˜

    # æ•™è‚²æ©Ÿæ§‹
    "ntu.edu.tw": "å°ç£å¤§å­¸",
    "nctu.edu.tw": "é™½æ˜äº¤é€šå¤§å­¸ (åŸäº¤é€šå¤§å­¸)",
    "nthu.edu.tw": "æ¸…è¯å¤§å­¸",
    "nchu.edu.tw": "ä¸­èˆˆå¤§å­¸",
    "ncku.edu.tw": "æˆåŠŸå¤§å­¸",
    "nsysu.edu.tw": "ä¸­å±±å¤§å­¸",
    "ncu.edu.tw": "ä¸­å¤®å¤§å­¸",
    "ccu.edu.tw": "ä¸­æ­£å¤§å­¸",
    "ntnu.edu.tw": "å°ç£å¸«ç¯„å¤§å­¸",
    "ncue.edu.tw": "å½°åŒ–å¸«ç¯„å¤§å­¸",
    "ntust.edu.tw": "å°ç£ç§‘æŠ€å¤§å­¸ (å°ç§‘å¤§)",
    "nkust.edu.tw": "é«˜é›„ç§‘æŠ€å¤§å­¸ (é«˜ç§‘å¤§)",
    "accupass.com": "æ´»å‹•é€š (æ´»å‹•ç¥¨å‹™)",

    # ç”Ÿæ´»æœå‹™
    "7-eleven.com.tw": "7-ELEVEN ä¾¿åˆ©å•†åº—",
    "family.com.tw": "å…¨å®¶ä¾¿åˆ©å•†åº—",
    "hilife.com.tw": "èŠçˆ¾å¯Œä¾¿åˆ©å•†åº—",
    "okmart.com.tw": "OKä¾¿åˆ©å•†åº—",
    "cplife.com.tw": "ä¸­ä¿ç„¡é™+ (ä¿å…¨ã€ç”Ÿæ´»æœå‹™)",
    "dominos.com.tw": "é”ç¾æ¨‚æŠ«è–©",
    "kfc.com.tw": "è‚¯å¾·åŸºé€Ÿé£Ÿ",
    "mcdonalds.com.tw": "éº¥ç•¶å‹é€Ÿé£Ÿ",
    "starbucks.com.tw": "æ˜Ÿå·´å…‹å’–å•¡",
    "85cafe.com": "85åº¦C å’–å•¡è›‹ç³•çƒ˜ç„™",
    "comebuy.com.tw": "COMEBUY (æ‰‹æ–é£²æ–™)",

    # è™›æ“¬è³‡ç”¢äº¤æ˜“æ‰€
    "twex.tw": "TWEX æ•¸ä½è³‡ç”¢äº¤æ˜“æ‰€",
    "max.maicoin.com": "MaiCoin MAX æ•¸ä½è³‡ç”¢äº¤æ˜“æ‰€",
    "bitopro.com": "BitoPro å¹£è¨—æ•¸ä½è³‡ç”¢äº¤æ˜“æ‰€",

    # å…¶ä»–çŸ¥åç¶²ç«™
    "104.com.tw": "104 äººåŠ›éŠ€è¡Œ (æ±‚è·)",
    "1111.com.tw": "1111 äººåŠ›éŠ€è¡Œ (æ±‚è·)",
    "518.com.tw": "518 ç†Šç­ (æ±‚è·ï¼ŒåŸ518äººåŠ›éŠ€è¡Œ)",
    "yes123.com.tw": "yes123 æ±‚è·ç¶²",
    "591.com.tw": "591 æˆ¿å±‹äº¤æ˜“ç¶² (ç§Ÿå±‹ã€å”®å±‹)",
    "sinyi.com.tw": "ä¿¡ç¾©æˆ¿å±‹ (æˆ¿ä»²)",
    "cthouse.com.tw": "ä¸­ä¿¡æˆ¿å±‹ (æˆ¿ä»²)",
    "housefun.com.tw": "å¥½æˆ¿ç¶² (æˆ¿åœ°ç”¢è³‡è¨Š)",
    "mobile01.com": "Mobile01 (3Cã€ç”Ÿæ´»ç¶œåˆè«–å£‡)",
    "ptt.cc": "PTT æ‰¹è¸¢è¸¢å¯¦æ¥­åŠ (é›»å­ä½ˆå‘Šæ¬„ç³»çµ±)",
    "dcard.tw": "Dcard (å¤§å­¸ç”Ÿã€å¹´è¼•æ—ç¾¤ç¤¾ç¾¤è«–å£‡)",
    "pixnet.net": "ç—å®¢é‚¦ (éƒ¨è½æ ¼ã€ç¤¾ç¾¤å¹³å°)",
    "blogspot.com": "Blogger (Google æ——ä¸‹éƒ¨è½æ ¼å¹³å°)",
    "wordpress.com": "WordPress.com (éƒ¨è½æ ¼/ç¶²ç«™æ¶è¨­å¹³å°)",
    "facebook.com": "Facebook (ç¤¾ç¾¤åª’é«”)",
    "instagram.com": "Instagram (åœ–ç‰‡å½±éŸ³ç¤¾ç¾¤åª’é«”)",
    "youtube.com": "YouTube (å½±éŸ³åˆ†äº«å¹³å°)",
    "google.com": "Google (æœå°‹å¼•æ“ã€ç¶²è·¯æœå‹™)",
    "microsoft.com": "å¾®è»Ÿ (è»Ÿé«”ã€ä½œæ¥­ç³»çµ±ã€é›²ç«¯æœå‹™)",
    "apple.com": "è˜‹æœå…¬å¸ (é›»å­ç”¢å“ã€è»Ÿé«”æœå‹™)",

    # è´ŠåŠ©ç¶²ç«™ (é€šå¸¸ç‚ºå‰µä½œè€…æˆ–å°ˆæ¡ˆæä¾›å°é¡è´ŠåŠ©çš„å¹³å°)
    "buymeacoffee.com/todao_antifruad": "Buy Me a Coffee (å‰µä½œè€…è´ŠåŠ©å¹³å° - ToDAO é˜²è©å°ˆæ¡ˆ)",
    "buymeacoffee.com/todao": "Buy Me a Coffee (å‰µä½œè€…è´ŠåŠ©å¹³å° - ToDAO)",
    "ko-fi.com/todao": "Ko-fi (å‰µä½œè€…è´ŠåŠ©å¹³å° - ToDAO)",
    "patreon.com/todao": "Patreon (å‰µä½œè€…è¨‚é–±è´ŠåŠ©å¹³å° - ToDAO)"
}

# å–®ç¨å®šç¾©è´ŠåŠ©ç¶²ç«™åˆ—è¡¨
DONATION_DOMAINS = [
    "buymeacoffee.com/todao_antifruad", "buymeacoffee.com/todao",
    "ko-fi.com/todao", "patreon.com/todao"
]

app = Flask(__name__)

# Line API è¨­å®š
line_bot_api = LineBotApi(os.environ.get('LINE_CHANNEL_ACCESS_TOKEN', ''))
handler = WebhookHandler(os.environ.get('LINE_CHANNEL_SECRET', ''))

# OpenAIè¨­å®š
openai.api_key = os.environ.get('OPENAI_API_KEY', '')

# è¨­ç½®æ—¥èªŒ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# åˆå§‹åŒ–Firebaseç®¡ç†å™¨
firebase_manager = FirebaseManager.get_instance()

# ç”¨æˆ¶éŠæˆ²ç‹€æ…‹
user_game_state = {}

# ç”¨æˆ¶æœ€å¾ŒèŠå¤©æ™‚é–“è¨˜éŒ„
user_last_chat_time = {}
user_pending_analysis = {} # ç”¨æ–¼è¿½è¹¤ç­‰å¾…ç”¨æˆ¶æ¾„æ¸…çš„åˆ†æè«‹æ±‚
first_time_chatters = set()  # è¿½è¹¤é¦–æ¬¡èŠå¤©çš„ç”¨æˆ¶

CHAT_TIP_PROBABILITY = 0.3 # é–’èŠæ™‚å›è¦†é˜²è©å°çŸ¥è­˜çš„æ©Ÿç‡

# å®šç¾©é—œéµè©å’Œæ¨¡å¼
function_inquiry_keywords = ["åŠŸèƒ½", "å¹«åŠ©", "æœƒä»€éº¼", "èƒ½åšä»€éº¼", "ä½¿ç”¨èªªæ˜", "ä½ æ˜¯èª°"]
follow_up_patterns = ["è¢«é¨™", "è©é¨™", "å¯ç–‘", "ä¸ç¢ºå®š", "å¹«æˆ‘çœ‹çœ‹", "é€™æ˜¯è©é¨™å—", "é€™æ˜¯çœŸçš„å—"]
potato_game_trigger_keywords = ["é¸å“ªé¡†åœŸè±†", "ç©éŠæˆ²", "åœŸè±†éŠæˆ²", "é¸åœŸè±†", "é¸åœŸè±†éŠæˆ²", "é–‹å§‹éŠæˆ²"]
bot_trigger_keyword = "å—¨åœŸè±†" # ç¾¤çµ„ä¸­è§¸ç™¼æ©Ÿå™¨äººæœå‹™çš„é—œéµè©

# å®šç¾©åˆ†ææç¤ºè©
analysis_prompts = ["è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š", "å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯", "åˆ†æé€™å‰‡è¨Šæ¯", "å¹«æˆ‘åˆ†æè¨Šæ¯", "è«‹å¹«æˆ‘åˆ†æè©é¨™ç¶²ç«™", "å¹«æˆ‘åˆ†æè©é¨™ç¶²ç«™"]

def expand_short_url(url):
    """
    å˜—è©¦å±•é–‹çŸ­ç¶²å€ï¼Œè¿”å›åŸå§‹URLå’Œå±•é–‹å¾Œçš„URL
    
    Args:
        url: å¯èƒ½çš„çŸ­ç¶²å€
    
    Returns:
        tuple: (åŸå§‹URL, å±•é–‹å¾Œçš„URL, æ˜¯å¦ç‚ºçŸ­ç¶²å€, æ˜¯å¦æˆåŠŸå±•é–‹)
    """
    # æª¢æŸ¥æ˜¯å¦ç‚ºçŸ­ç¶²å€
    parsed_url = urlparse(url)
    is_short_url = False
    for domain in SHORT_URL_DOMAINS:
        if domain in parsed_url.netloc:
            is_short_url = True
            break
    
    if not is_short_url:
        return url, url, False, False
    
    # å˜—è©¦å±•é–‹çŸ­ç¶²å€
    try:
        session = requests.Session()
        response = session.head(url, allow_redirects=True, timeout=5)
        expanded_url = response.url
        
        if expanded_url != url:
            logger.info(f"æˆåŠŸå±•é–‹çŸ­ç¶²å€: {url} -> {expanded_url}")
            return url, expanded_url, True, True
        else:
            logger.warning(f"URLå¯èƒ½ä¸æ˜¯çŸ­ç¶²å€æˆ–ç„¡æ³•å±•é–‹: {url}")
            return url, url, True, False
    except Exception as e:
        logger.error(f"å±•é–‹çŸ­ç¶²å€æ™‚å‡ºéŒ¯: {e}")
        return url, url, True, False

# å®šç¾©é˜²è©å°çŸ¥è­˜
anti_fraud_tips = [
    "ğŸ” æ”¶åˆ°ä¸æ˜é€£çµï¼Ÿå…ˆç¢ºèªç™¼ä¿¡äººèº«åˆ†ï¼Œå†ä¸‰æ€è€Œå¾Œè¡Œã€‚é»æ“Šå‰å•è‡ªå·±ï¼šé€™çœŸçš„å¿…è¦å—ï¼Ÿ",
    "ğŸ” è«‹å®šæœŸæ›´æ›å¯†ç¢¼ï¼Œä¸¦é¿å…åœ¨ä¸åŒå¹³å°ä½¿ç”¨ç›¸åŒçš„å¯†ç¢¼çµ„åˆã€‚å»ºè­°ä½¿ç”¨å¯†ç¢¼ç®¡ç†å·¥å…·ï¼",
    "ğŸ“± æ¥åˆ°è‡ªç¨±éŠ€è¡Œã€è­¦æ–¹çš„é›»è©±ï¼Ÿæ›æ–·å¾Œï¼Œä¸»å‹•æ’¥æ‰“å®˜æ–¹é›»è©±ç¢ºèªï¼Œä¸è¦å›æ’¥å°æ–¹æä¾›çš„è™Ÿç¢¼ã€‚",
    "ğŸ’° æŠ•è³‡å ±é…¬ç‡é«˜å¾—ä¸åˆç†ï¼Ÿè¨˜ä½ï¼šå¤©ä¸‹æ²’æœ‰ç™½åƒçš„åˆé¤ï¼Œé«˜å ±é…¬å¿…æœ‰é«˜é¢¨éšªï¼",
    "ğŸ¤ ç¶²è·¯äº¤å‹è¦è¬¹æ…ï¼ŒçŸ­æ™‚é–“å…§å°±è«‡åŠé‡‘éŒ¢å¾€ä¾†çš„ã€Œå¥½å‹ã€å¾ˆå¯èƒ½æ˜¯è©é¨™é›†åœ˜ã€‚",
    "ğŸ¦ çœŸæ­£çš„éŠ€è¡Œçµ•ä¸æœƒè«‹ä½ æ“ä½œATMã€Œè§£é™¤è¨­å®šã€ã€ã€Œå‡ç´šç³»çµ±ã€æˆ–ã€Œç¢ºèªèº«åˆ†ã€ã€‚",
    "ğŸ›’ ç¶²è³¼åªç”¨æ­£è¦å¹³å°ï¼Œäº¤æ˜“æ™‚ç•™åœ¨å¹³å°å…§å®Œæˆï¼Œåˆ‡å‹¿ç§ä¸‹äº¤æ˜“æˆ–æå‰ä»˜æ¬¾ã€‚",
    "ğŸ® è³¼è²·éŠæˆ²é»æ•¸å‰ï¼Œå…ˆç¢ºèªç”¨é€”ï¼Œè‹¥æ˜¯çµ¦é™Œç”Ÿäººæˆ–è§£å‡å¸³æˆ¶ä½¿ç”¨ï¼Œæ¥µå¯èƒ½æ˜¯è©é¨™ï¼"
]

# è©é¨™é¡å‹åˆ†é¡
fraud_types = {
    "ç¶²è·¯è³¼ç‰©è©é¨™": {
        "description": "æ¶‰åŠå‡å†’è³¼ç‰©ç¶²ç«™ã€è™›å‡å•†å“æˆ–ä¸å¯¦å»£å‘Šçš„è©é¨™",
        "examples": [
            "ğŸ›’ å‡è²·å®¶é¨™è³£å®¶è©é¨™æ¡ˆä¾‹ ğŸ›’\n\nè©é¨™é›†åœ˜å‡æ‰®è²·å®¶æ¥è§¸äºŒæ‰‹å•†å“è³£å®¶ï¼Œè²ç¨±é€éè¦çš®ç­‰å¹³å°äº¤æ˜“ï¼Œå¼•å°è³£å®¶åŠ å…¥å‡å†’å®¢æœLINEå¸³è™Ÿï¼Œä»¥ã€Œç°½ç½²ä¿è­‰æ›¸ã€ã€ã€ŒéŠ€è¡Œèªè­‰ã€ç­‰è—‰å£èª˜å°è³£å®¶é€²è¡Œç¶²è·¯éŠ€è¡Œè½‰å¸³æˆ–LINE Payä»˜æ¬¾ï¼Œå°è‡´å—å®³è€…è²¡ç”¢æå¤±ã€‚\n\nğŸ“Š è³‡æ–™ä¾†æºï¼š165æ‰“è©å„€è¡¨æ¿"
        ],
        "sop": [
            "âš ï¸ é˜²ç¯„ç¶²è·¯è³¼ç‰©è©é¨™æ³¨æ„äº‹é … âš ï¸",
            "1ï¸âƒ£ æœ‰ç¶²è·¯äº¤æ˜“å•é¡Œï¼Œè«‹æ´½äº¤æ˜“å¹³è‡ºå…¬å‘Šçš„å®˜æ–¹å®¢æœè¯ç¹«æ–¹å¼ï¼Œä¸è¦ä½¿ç”¨é™Œç”Ÿäººæä¾›çš„è¯ç¹«æ–¹å¼",
            "2ï¸âƒ£ å …å®ˆå¹³å°å…§éƒ¨äº¤æ˜“ï¼Œä¸è¦è·³å‡ºè¦çš®ã€éœ²å¤©æˆ–å…¶ä»–å¹³å°çš„å°è©±ç³»çµ±",
            "3ï¸âƒ£ éŠ€è¡ŒåŠè¦çš®ç­‰å¹³å°ä¸æœƒä»¥ç§äººLINEå¸³è™Ÿè¯ç¹«å®¢æˆ¶",
            "4ï¸âƒ£ é‡åˆ°è¦æ±‚ã€Œç°½ç½²ä¿è­‰æ›¸ã€ã€ã€ŒéŠ€è¡Œèªè­‰ã€ç­‰æ“ä½œæ™‚ï¼Œè«‹æé«˜è­¦è¦º",
            "5ï¸âƒ£ çµ•å°ä¸è¦ä¾ç…§ä»–äººæŒ‡ç¤ºæ“ä½œç¶²è·¯éŠ€è¡Œæˆ–é€²è¡Œè½‰å¸³",
            "6ï¸âƒ£ æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹ç«‹å³æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "å‡äº¤å‹æŠ•è³‡è©é¨™": {
        "description": "é€éç¶²è·¯äº¤å‹å¹³å°æˆ–ç¤¾ç¾¤åª’é«”ï¼Œå‡æ‰®æœ‰å¥½æ„Ÿçš„ç•°æ€§å»ºç«‹æ„Ÿæƒ…é€£çµï¼Œæœ€çµ‚ä»¥å„ç¨®ç†ç”±é¨™å–é‡‘éŒ¢",
        "examples": [
            "ğŸ’” ç¶²è·¯äº¤å‹è©é¨™æ¡ˆä¾‹ ğŸ’”\n\nè©é¨™è€…å‡æ‰®é«˜ç¤¾ç¶“åœ°ä½äººå£«ï¼ˆå¦‚é†«ç”Ÿã€è»å®˜ã€æ©Ÿé•·ç­‰ï¼‰èˆ‡è¢«å®³è€…åœ¨ç¶²è·¯ä¸Šèªè­˜ä¸¦å»ºç«‹æƒ…æ„Ÿé€£çµï¼Œé•·æœŸå™“å¯’å•æš–å¾Œï¼Œä»¥ç”Ÿç—…éœ€è¦é†«è—¥è²»ã€å¯„é€æµ·å¤–ç¦®ç‰©éœ€ç¹³ç´é—œç¨…ç­‰å„ç¨®ç†ç”±ï¼Œèª˜é¨™è¢«å®³è€…è½‰å¸³æˆ–é¢äº¤é‡‘éŒ¢ã€‚æ­¤é¡è©é¨™ç‰¹åˆ¥é‡å°å¯¡å±…æˆ–æƒ…æ„Ÿç”Ÿæ´»è¼ƒç‚ºå­¤å–®çš„ä¸­è€å¹´äººã€‚\n\nğŸ“Š è³‡æ–™ä¾†æºï¼š165æ‰“è©å„€è¡¨æ¿"
        ],
        "sop": [
            "âš ï¸ é˜²ç¯„äº¤å‹æŠ•è³‡è©é¨™æ³¨æ„äº‹é … âš ï¸",
            "1ï¸âƒ£ ç¶²å‹è¦‹éƒ½æ²’è¦‹éå»è«‡åŠé‡‘éŒ¢ï¼Œé«˜åº¦å¯èƒ½æ˜¯è©é¨™",
            "2ï¸âƒ£ å°æ–¹è‡ªç¨±é•·æœŸåœ¨åœ‹å¤–å·¥ä½œï¼ˆå¦‚è»é†«ã€æ©Ÿé•·ç­‰ï¼‰ä¸”ç„¡æ³•è¦‹é¢ï¼Œä½†å¾ˆå¿«ç™¼å±•æ„Ÿæƒ…é—œä¿‚ï¼Œæ‡‰æé«˜è­¦è¦º",
            "3ï¸âƒ£ æ‹’çµ•ä»»ä½•ä»¥ç·Šæ€¥é†«ç™‚è²»ã€é‹è²»ã€ç¨…é‡‘ç­‰åç¾©è¦æ±‚çš„é‡‘éŒ¢å¾€ä¾†",
            "4ï¸âƒ£ ä¸è¦è½ä¿¡éœ€è¦å”åŠ©é–‹é€šå¤–å¹£å¸³æˆ¶ã€å€Ÿç”¨å¸³æˆ¶çš„èªªæ³•",
            "ç¶²å‹è¦‹éƒ½æ²’è¦‹éå»è«‡åŠé‡‘éŒ¢ï¼Œé«˜åº¦å¯èƒ½æ˜¯è©é¨™",
            "å°æ–¹è‡ªç¨±é•·æœŸåœ¨åœ‹å¤–å·¥ä½œï¼ˆå¦‚è»é†«ã€æ©Ÿé•·ç­‰ï¼‰ä¸”ç„¡æ³•è¦‹é¢ï¼Œä½†å¾ˆå¿«ç™¼å±•æ„Ÿæƒ…é—œä¿‚ï¼Œæ‡‰æé«˜è­¦è¦º",
            "æ‹’çµ•ä»»ä½•ä»¥ç·Šæ€¥é†«ç™‚è²»ã€é‹è²»ã€ç¨…é‡‘ç­‰åç¾©è¦æ±‚çš„é‡‘éŒ¢å¾€ä¾†",
            "ä¸è¦è½ä¿¡éœ€è¦å”åŠ©é–‹é€šå¤–å¹£å¸³æˆ¶ã€å€Ÿç”¨å¸³æˆ¶çš„èªªæ³•",
            "é¿å…å”åŠ©é™Œç”Ÿç¶²å‹ç”³è¾¦æ‰‹æ©Ÿé–€è™Ÿæˆ–æä¾›SIMå¡",
            "å°æ–¼ç¶²å‹æ‰€æä¾›çš„èº«ä»½è³‡è¨Šï¼Œå˜—è©¦å¤šæ–¹æŸ¥è­‰",
            "æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹ç«‹å³æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢",
            "å¤šèˆ‡å®¶äººæœ‹å‹åˆ†äº«äº¤å‹æƒ…æ³ï¼Œé¿å…å–®ç¨åšå‡ºè²¡å‹™æ±ºå®š"
        ]
    },
    "å‡ä¸­çé€šçŸ¥è©é¨™": {
        "description": "å†’å……å®˜æ–¹å–®ä½æˆ–çŸ¥åä¼æ¥­ï¼Œå®£ç¨±ä¸­çä½†éœ€ç¹³ç´æ‰‹çºŒè²»ç­‰è²»ç”¨æ‰èƒ½é ˜ççš„è©é¨™",
        "examples": [],
        "sop": []
    },
    "å‡å€ŸéŠ€è¡Œè²¸æ¬¾è©é¨™": {
        "description": "å‡å†’é‡‘èæ©Ÿæ§‹äººå“¡ï¼Œå®£å‚³ä½åˆ©å¿«é€Ÿè²¸æ¬¾ï¼Œä½†è¦æ±‚å…ˆæ”¯ä»˜æ‰‹çºŒè²»æˆ–è³¼è²·é»æ•¸",
        "examples": [
            "ä¸€åæ€¥éœ€è³‡é‡‘å„Ÿé‚„å®¶åº­å‚µå‹™çš„æ°‘çœ¾åœ¨Facebookçœ‹åˆ°åç‚ºã€Œæ•¸ä½é€Ÿeè²¸ã€çš„å»£å‘Šï¼Œæ¨™æ¦œè²¸æ¬¾å¿«é€Ÿã€åˆ©æ¯ä½ä¸”æ‰‹çºŒç°¡å–®ã€‚æ–¼æ˜¯åŠ å…¥äº†ä¸€å€‹åç‚ºã€Œå°åŒ—å¯Œé‚¦éŠ€è¡Œä¿¡è²¸ã€çš„LINEå¸³è™Ÿã€‚åœ¨ç”³è«‹è²¸æ¬¾30è¬å…ƒä¸¦é€šéåˆå¯©å¾Œï¼Œå°æ–¹è¡¨ç¤ºéœ€è¦è³¼è²·ä¸€ä»½é‡‘èè²¸æ¬¾ä¿éšªï¼Œæ‰èƒ½æé«˜ä¿¡ç”¨è©•åˆ†ã€‚å—å®³è€…åŒ¯äº†1è¬5åƒå…ƒåˆ°æŒ‡å®šå¸³æˆ¶å¾Œï¼Œå°æ–¹åˆè¦æ±‚è³¼è²·é»æ•¸å¡ä»¥å¢åŠ ä¿¡è²¸è©•åˆ†ã€‚å—å®³è€…å¤šæ¬¡è³¼è²·é»æ•¸å¡ä¸¦æä¾›çµ¦å°æ–¹ã€‚ä¸ä¹…å¾Œï¼Œå—å®³è€…ç™¼ç¾ç¶²è·¯éŠ€è¡Œå¸³æˆ¶ç„¡æ³•ä½¿ç”¨ï¼Œè¯ç¹«å°æ–¹ä¹Ÿå·²å¤±è¯ã€‚å‘éŠ€è¡Œå®¢æœæŸ¥è©¢å¾Œï¼Œç¢ºèªå¸³æˆ¶å·²è¢«åˆ—å…¥è­¦ç¤ºåå–®ï¼Œä¸”é€™æ ¹æœ¬ä¸æ˜¯å°åŒ—å¯Œé‚¦éŠ€è¡Œçš„æ¥­å‹™ã€‚"
        ],
        "sop": [
            "è²¸æ¬¾è«‹æ‰¾åˆæ³•çš„é‡‘èæ©Ÿæ§‹ã€ä¿éšªå…¬å¸è¾¦ç†",
            "åˆæ³•è²¸æ¬¾æ©Ÿæ§‹ä¸æœƒè¦æ±‚äº‹å…ˆæ”¯ä»˜æ‰‹çºŒè²»æˆ–ä¿è­‰é‡‘",
            "éŠ€è¡Œè¾¦ç†ä¿¡è²¸ï¼Œçµ•ä¸æœƒè¦æ±‚è³¼è²·é»æ•¸å¡æˆ–é å…ˆåŒ¯æ¬¾",
            "åˆæ˜¯è²¸æ¬¾ã€åˆæ˜¯é»æ•¸å¡ï¼Œçµ•å°æ˜¯è©é¨™",
            "ç›´æ¥å‰å¾€éŠ€è¡Œåˆ†è¡Œæˆ–é€éå®˜æ–¹ç¶²ç«™ç”³è«‹è²¸æ¬¾",
            "ä¸è¦é»æ“Šä¸æ˜ä¾†æºçš„è²¸æ¬¾å»£å‘Šé€£çµ",
            "ä¸è¦è¼•ä¿¡ã€Œå…è¯å¾µã€å¿«é€Ÿæ ¸è²¸ã€ç­‰å®£å‚³",
            "ä¿è­·å€‹äººè³‡æ–™ï¼Œä¸è¼•æ˜“æä¾›èº«åˆ†è­‰å½±æœ¬",
            "æœ‰è²¸æ¬¾éœ€æ±‚æ‡‰å‘åˆæ³•é‡‘èæ©Ÿæ§‹è«®è©¢",
            "å°æ–¼è¦æ±‚å…ˆåŒ¯æ¬¾æ‰èƒ½è²¸æ¬¾çš„æœå‹™è¦ç‰¹åˆ¥è­¦è¦º",
            "ç¢ºèªè²¸æ¬¾æ©Ÿæ§‹æ˜¯å¦ç‚ºé‡‘ç®¡æœƒæ ¸å‡†çš„åˆæ³•æ©Ÿæ§‹",
            "è‹¥æœ‰ç–‘æ…®ï¼Œè«‹æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "å‡å»£å‘Šè©é¨™": {
        "description": "é€éç¶²è·¯å¹³å°ç™¼å¸ƒè™›å‡çš„å»£å‘Šè³‡è¨Šï¼Œå¦‚ç§Ÿå±‹ã€ç¥¨åˆ¸ä»£è³¼ã€å·¥ä½œæ©Ÿæœƒç­‰ï¼Œè¦æ±‚é ä»˜è¨‚é‡‘å¾Œæ¶ˆå¤±",
        "examples": [
            "ä¸€åå¤§å­¸ä¸‰å¹´ç´šå­¸ç”Ÿå› ç‚ºæ²’æœ‰æŠ½ä¸­å­¸æ ¡å®¿èˆï¼Œåœ¨Facebookçš„ç§Ÿå±‹ç‰ˆç¤¾åœ˜çœ‹åˆ°æˆ¿æ±ã€ŒJoyceã€ç™¼ä½ˆçš„ç§Ÿå±‹è¨Šæ¯ã€‚ç…§ç‰‡ä¸­æˆ¿é–“å±‹æ³è‰¯å¥½ï¼Œå‘¨é­ç”Ÿæ´»æ©Ÿèƒ½ä¾¿åˆ©ï¼Œç§Ÿé‡‘åˆç†ä¸”å¯ç”³è«‹ç§Ÿå±‹è£œåŠ©ã€‚å­¸ç”ŸåŠ äº†æˆ¿æ±çš„LINEï¼Œæˆ¿æ±è¡¨ç¤ºå­¸ç”Ÿæ’åœ¨ç¬¬5çµ„çœ‹æˆ¿ï¼Œä½†å‰é¢å·²æœ‰å®¢äººæ‰“ç®—é ä»˜è¨‚é‡‘å„ªå…ˆçœ‹å±‹ã€‚ç‚ºäº†æ¶å…ˆçœ‹å±‹ï¼Œå­¸ç”Ÿç«‹å³åŒ¯äº†ç§Ÿé‡‘åŠ è¨‚é‡‘å…±3è¬å…ƒã€‚ä¹‹å¾Œï¼Œæˆ¿æ±è²ç¨±å…¶ä¸ˆå¤«èª¤æ”¶äº†å…¶ä»–å®¢äººè¨‚é‡‘ï¼Œè«‹å­¸ç”Ÿå…ˆåŒ¯æ¬¾çµ¦é‚£ä½å®¢äººä»¥ä¿ç•™å„ªå…ˆæ¬Šã€‚å­¸ç”Ÿæå‡ºé€€è²»è¦æ±‚å¾Œï¼Œæˆ¿æ±æ¶ˆå¤±ç„¡è¹¤ã€‚"
        ],
        "sop": [
            "ç¶²è·¯ç§Ÿå±‹ï¼Œè‹¥è½è¦‹çœ‹å±‹å„ªå…ˆæ¬Šï¼Œæ¥µå¯èƒ½æ˜¯è©é¨™",
            "ç¶²è·¯ç§Ÿå±‹æ‡‰æ´½æˆ¿å±‹ä»²ä»‹å…¬å¸æˆ–æ­£è¦ç§Ÿå±‹ç¶²ç«™",
            "æ²’æœ‰çœ‹åˆ°æˆ¿å±‹å¯¦é«”å‰ï¼Œä¸è¦æ”¯ä»˜ä»»ä½•è¨‚é‡‘æˆ–ç§Ÿé‡‘",
            "åˆæ³•çš„ç§Ÿå±‹æˆ–ç¥¨åˆ¸äº¤æ˜“ä¸æœƒè¦æ±‚é ä»˜æ¬¾é …",
            "å°æ–¼æ€¥è¿«æ¨éŠ·ã€Œé™æ™‚å„ªæƒ ã€çš„å»£å‘Šä¿æŒè­¦æƒ•",
            "æŸ¥è­‰å»£å‘Šç™¼å¸ƒè€…çš„çœŸå¯¦èº«ä»½å’Œè©•åƒ¹",
            "ä½¿ç”¨æœ‰ä¿éšœçš„ç¬¬ä¸‰æ–¹æ”¯ä»˜æˆ–äº¤æ˜“å¹³å°",
            "åˆ©ç”¨Googleåœ–ç‰‡æœå°‹åŠŸèƒ½æŸ¥è­‰ç§Ÿå±‹ç…§ç‰‡æ˜¯å¦ç‚ºç›œç”¨",
            "è«‹è¦ªå‹é™ªåŒçœ‹æˆ¿ï¼Œé¿å…ç¨è‡ªæ±ºç­–",
            "è‹¥æœ‰ç–‘æ…®ï¼Œè«‹æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "è‰²æƒ…æ‡‰å¬è©è²¡è©é¨™": {
        "description": "é€éç¶²è·¯å¹³å°å®£å‚³è‰²æƒ…æœå‹™ï¼Œè¦æ±‚æ”¯ä»˜ã€Œè¨‚é‡‘ã€ã€ã€Œä¿è­‰é‡‘ã€ç­‰è²»ç”¨ï¼Œä½†å¯¦éš›ä¸Šä¸æä¾›ä»»ä½•æœå‹™",
        "examples": [
            "ä¸€åç”·æ€§åœ¨ç¤¾ç¾¤åª’é«”ä¸Šçœ‹åˆ°æŸç²‰å°ˆæä¾›å¤–é€èŒ¶æœå‹™çš„å»£å‘Šï¼Œä¾¿ç§è¨Šè©¢å•ã€‚å°æ–¹æä¾›äº†å¤šå¼µå¥³æ€§ç…§ç‰‡ä¾›é¸æ“‡ï¼Œä¸¦èªªæ˜åƒ¹æ ¼å’Œæœå‹™å…§å®¹ã€‚è©²ç”·æ€§é¸å®šå¾Œï¼Œå°æ–¹è¡¨ç¤ºéœ€å…ˆæ”¯ä»˜5,000å…ƒçš„è¨‚é‡‘ï¼Œæ‰æœƒå®‰æ’å¥³ä¼´å‰å¾€ã€‚åŒ¯æ¬¾å¾Œï¼Œå°æ–¹åˆè¡¨ç¤ºå› ç‚ºæ˜¯é¦–æ¬¡äº¤æ˜“ï¼Œç‚ºç¢ºä¿å®‰å…¨ï¼Œéœ€å†æ”¯ä»˜5,000å…ƒã€Œä¿è­‰é‡‘ã€ï¼Œæ‰¿è«¾å¥³ä¼´æŠµé”å¾Œå¯é€€é‚„ã€‚ç”·æ€§å†æ¬¡åŒ¯æ¬¾å¾Œï¼Œå°æ–¹åˆä»¥ã€Œè»Šè³‡ã€ã€ã€Œå®‰å…¨æª¢æŸ¥è²»ã€ç­‰ç†ç”±è¦æ±‚é¡å¤–ä»˜æ¬¾ã€‚æ­¤æ™‚ç”·æ€§æ„è­˜åˆ°å¯èƒ½å—é¨™ï¼Œæ‹’çµ•å†ä»˜æ¬¾ä¸¦è¦æ±‚é€€æ¬¾ï¼Œä½†å°æ–¹å·²å°‡å…¶å°é–ï¼Œç„¡æ³•è¯ç¹«ã€‚"
        ],
        "sop": [
            "ä»»ä½•è¦æ±‚å…ˆåŒ¯æ¬¾çš„è‰²æƒ…æœå‹™å»£å‘Šï¼Œå¹¾ä¹éƒ½æ˜¯è©é¨™",
            "ä¸è¦ç›¸ä¿¡ç¶²è·¯ä¸Šé™Œç”Ÿäººæä¾›çš„è‰²æƒ…æœå‹™",
            "é¿å…åœ¨ä¸æ˜ä¾†æºçš„ç¶²ç«™æˆ–ç¤¾ç¾¤åª’é«”ä¸Šå°‹æ‰¾æ­¤é¡æœå‹™",
            "ä¿è­·å€‹äººè³‡æ–™ï¼Œé¿å…èº«ä»½è¢«ç›œç”¨æˆ–é­å‹’ç´¢",
            "ä¸è¦è¼•ä¿¡ä¸åˆç†çš„æ”¶è²»æ–¹å¼æˆ–ç†ç”±",
            "å°æ–¼åè¦†è¦æ±‚ã€Œé¡å¤–è²»ç”¨ã€çš„è¡Œç‚ºæé«˜è­¦è¦º",
            "è‰²æƒ…äº¤æ˜“åœ¨å°ç£æ˜¯é•æ³•çš„ï¼Œå¯èƒ½é¢è‡¨æ³•å¾‹é¢¨éšª",
            "è‹¥å·²é­è©é¨™ï¼Œæ‡‰ä¿ç•™æ‰€æœ‰é€šè¨Šè¨˜éŒ„ä½œç‚ºè­‰æ“š",
            "è‹¥æœ‰ç–‘æ…®ï¼Œè«‹æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "è™›æ“¬éŠæˆ²è©é¨™": {
        "description": "é€ééŠæˆ²å…§èŠå¤©æˆ–ç¤¾ç¾¤åª’é«”æ¥è§¸ç©å®¶ï¼Œæä¾›è™›å‡çš„éŠæˆ²é»æ•¸ã€å¤–æ›æˆ–æœå‹™ï¼Œé¨™å–é‡‘éŒ¢æˆ–å¸³è™Ÿ",
        "examples": [
            "ä¸€åé«˜ä¸­ç”Ÿåœ¨æŸç·šä¸ŠéŠæˆ²ä¸­èªè­˜ä¸€ä½ã€Œè³‡æ·±ç©å®¶ã€ï¼Œå°æ–¹è¡¨ç¤ºå¯ä»¥å¹«å¿™ä»£è³¼éŠæˆ²é»æ•¸ï¼Œåªéœ€è¦å¸‚åƒ¹çš„ä¸ƒæŠ˜ã€‚é«˜ä¸­ç”Ÿå¿ƒå‹•ä¸å·²ï¼Œå…ˆå¾ŒåŒ¯äº†3,000å…ƒè³¼è²·éŠæˆ²é»æ•¸ã€‚äº¤æ˜“é †åˆ©å¾Œï¼Œã€Œè³‡æ·±ç©å®¶ã€åˆæ¨è–¦ä¸€å€‹èƒ½æå‡è§’è‰²èƒ½åŠ›çš„å¤–æ›ç¨‹å¼ï¼Œè²ç¨±åªè¦å®‰è£å°±èƒ½ç²å¾—éŠæˆ²å„ªå‹¢ã€‚é«˜ä¸­ç”Ÿä¸‹è¼‰å®‰è£äº†è©²ç¨‹å¼ï¼Œä¸ä¹…å¾Œç™¼ç¾éŠæˆ²å¸³è™Ÿè¢«ç›œï¼Œæ‰€æœ‰è™›æ“¬ç‰©å“è¢«è½‰ç§»ï¼Œä¸”è©²ç¨‹å¼é‚„ç«Šå–äº†ä»–é›»è…¦ä¸­çš„å€‹äººè³‡æ–™ï¼Œå°è‡´å…¶çˆ¶æ¯çš„éŠ€è¡Œå¸³æˆ¶é­ç›œåˆ·ã€‚"
        ],
        "sop": [
            "åªé€ééŠæˆ²å®˜æ–¹ç®¡é“è³¼è²·éŠæˆ²é»æ•¸æˆ–ç‰©å“",
            "ä¸è¦ä¸‹è¼‰ä¾†è·¯ä¸æ˜çš„å¤–æ›æˆ–ä¿®æ”¹ç¨‹å¼",
            "ä¿è­·éŠæˆ²å¸³è™Ÿå¯†ç¢¼ï¼Œä¸éš¨æ„æä¾›çµ¦ä»–äºº",
            "åƒ¹æ ¼æ˜é¡¯ä½æ–¼å¸‚å ´çš„äº¤æ˜“å¤šç‚ºè©é¨™",
            "ä¸è¦ç›¸ä¿¡å¯ä»¥ç ´è§£éŠæˆ²ç³»çµ±çš„èªªæ³•",
            "éŠæˆ²å…§äº¤å‹éœ€è¬¹æ…ï¼Œä¸è¼•æ˜“é€éœ²å€‹äººè³‡è¨Š",
            "ä½¿ç”¨é›™é‡èªè­‰ä¿è­·é‡è¦éŠæˆ²å¸³è™Ÿ",
            "å®šæœŸæ›´æ›å¯†ç¢¼ä¸¦æª¢æŸ¥å¸³è™Ÿå®‰å…¨è¨­ç½®",
            "ä¸è¦ä½¿ç”¨èˆ‡å…¶ä»–å¹³å°ç›¸åŒçš„å¯†ç¢¼",
            "è‹¥æœ‰ç–‘æ…®ï¼Œè«‹æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "å‡æ±‚è·è©é¨™": {
        "description": "ä»¥è™›å‡å·¥ä½œæ©Ÿæœƒç‚ºèª˜é¤Œï¼Œé¨™å–å€‹äººéŠ€è¡Œå¸³æˆ¶æˆ–é‡‘èå¡çš„è©é¨™",
        "examples": [
            "ä¸€åèˆè€…åœ¨ç¤¾ç¾¤å¹³å°åˆ†äº«è‡ªå·±çš„è¡¨æ¼”å½±ç‰‡ï¼Œæ”¶åˆ°ç¶²å‹ã€Œå¯§éœè‡´é ã€ç§è¨Šï¼Œè¡¨ç¤ºæ¬£è³å…¶èˆè¹ˆé¢¨æ ¼ï¼Œé‚€è«‹åƒåŠ ç§äººèšæœƒè¡¨æ¼”ã€‚é›™æ–¹è½‰è‡³LINEæºé€šï¼Œå°æ–¹ä»¥æ”¯ä»˜è¨‚é‡‘ç‚ºç”±ï¼Œè¦æ±‚æä¾›éŠ€è¡Œå¸³æˆ¶ã€‚æ­¤å¾Œï¼Œå°æ–¹å¤±è¯ï¼Œä½†å—å®³è€…å¸³æˆ¶é™¸çºŒæœ‰ä¸æ˜æ¬¾é …åŒ¯å…¥ã€‚æœ€çµ‚è¢«å‘ŠçŸ¥å¸³æˆ¶å·²è¢«åˆ—ç‚ºè­¦ç¤ºå¸³æˆ¶ï¼Œè­¦æ–¹èª¿æŸ¥ç™¼ç¾é€™äº›æ¬¾é …æ¶‰åŠå…¶ä»–è©é¨™æ¡ˆä»¶ï¼Œå—å®³è€…çš„å¸³æˆ¶è¢«ç”¨ä¾†æ´—éŒ¢ã€‚"
        ],
        "sop": [
            "ä¸è¦æä¾›éŠ€è¡Œå¸³æˆ¶è³‡æ–™çµ¦é™Œç”Ÿäºº",
            "å¸³æˆ¶æœ‰ä¸æ˜åŒ¯å…¥æ¬¾é …ï¼Œè«‹è¯ç¹«é–‹æˆ¶éŠ€è¡Œä¸¦ç«‹å³å ±è­¦",
            "å°æ–¼é«˜è–ªã€ä½é–€æª»çš„å·¥ä½œé‚€ç´„ä¿æŒè­¦è¦º",
            "ä¸è¦è¼•æ˜“ç›¸ä¿¡å¯ä»¥å¿«é€Ÿè³ºéŒ¢çš„å·¥ä½œæ©Ÿæœƒ",
            "ä¸è¦å¯„å‡ºé‡‘èå¡ã€ææ¬¾å¡æˆ–å­˜ç°¿çµ¦ä»–äºº",
            "ä¸è¦å°‡å¡ç‰‡æ”¾ç½®æ–¼æŒ‡å®šç½®ç‰©æ«ƒã€éƒµç®±ä¾›ä»–äººæ”¶å–",
            "é¿å…å”åŠ©ä»–äººæ“ä½œATMæˆ–ç¶²è·¯éŠ€è¡Œ",
            "å·¥ä½œå…§å®¹è‹¥æ¶‰åŠé‡‘èäº¤æ˜“æˆ–è½‰å¸³ï¼Œå¤šåŠæ˜¯è©é¨™",
            "å¾µæ‰ç®¡é“æ‡‰ä»¥æ­£è¦æ±‚è·å¹³å°ç‚ºä¸»",
            "æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹æ’¥æ‰“165åè©é¨™å°ˆç·šè«®è©¢"
        ]
    },
    "å‡æª¢è­¦è©é¨™": {
        "description": "å†’å……åŸ·æ³•æ©Ÿé—œäººå“¡ï¼ˆè­¦å¯Ÿã€æª¢å¯Ÿå®˜ã€æ³•å®˜ç­‰ï¼‰é€²è¡Œè©é¨™ï¼Œä»¥ã€Œè­‰ä»¶é­å†’ç”¨ã€ã€ã€Œæ¶‰åŠåˆ‘æ¡ˆã€ç­‰è—‰å£ï¼Œèª˜å°è¢«å®³äººæä¾›é‡‘èè³‡è¨Šæˆ–åŒ¯æ¬¾",
        "examples": [
            "æ°‘çœ¾å°åŠ‰æ¥ç²å‡å†’é¦¬å•é†«é™¢äººå“¡é›»è©±ï¼Œå°æ–¹ä½¯ç¨±æœ‰äººæŒå°åŠ‰è­‰ä»¶ä»£é ˜ç®¡åˆ¶è—¥å“ï¼Œéœ€è¦æ ¸å¯¦èº«åˆ†ã€‚ç•¶å°åŠ‰å¦èªæœ‰å§”è¨—ä»£é ˜è—¥å“ä¸€äº‹ï¼Œå‡å†’é†«é™¢äººå“¡éš¨å³å‘ŠçŸ¥å°‡ç”±æª¢è­¦æ¥æ‰‹ã€‚éš¨å¾Œå‡å†’è­¦å¯Ÿã€æª¢å¯Ÿå®˜æ¥é€£ä¾†é›»ï¼Œç¾…ç¹”ç½ªåå¾Œï¼Œè¦æ±‚å°åŠ‰äº¤ä»˜é‡‘èå¡èˆ‡å¸³æˆ¶è³‡æ–™ã€‚å¹¸å¥½å°åŠ‰ä¿æŒè­¦è¦ºï¼Œäº‹å¾Œç«‹å³é€šå ±165æª¢èˆ‰ã€‚æ­¤æ¡ˆèˆ‡è¿‘æœŸé†«ç™‚é™¢æ‰€ç—…æ‚£å€‹è³‡å¤–æ´©æœ‰é—œï¼Œè©é¨™é›†åœ˜å¯èƒ½å–å¾—é€™äº›å¤–æ´©å€‹è³‡ï¼Œé€²è¡Œç²¾æº–è©é¨™ã€‚"
        ],
        "sop": [
            "æª¢è­¦ä¸æœƒç”¨é›»è©±é€šçŸ¥æ¶‰æ¡ˆï¼Œæœƒä»¥å…¬æ–‡å‚³å–š",
            "æª¢è­¦ä¸æœƒè¦æ±‚æä¾›é‡‘èå¸³æˆ¶ã€å­˜æ‘ºæˆ–é‡‘èå¡",
            "æª¢è­¦ä¸æœƒè¦æ±‚è§£é™¤åˆ†æœŸä»˜æ¬¾",
            "æª¢è­¦ä¸æœƒç›£ç®¡éŠ€è¡Œå¸³æˆ¶æˆ–æ“ä½œATM",
            "æª¢è­¦ä¸æœƒè¦æ±‚äº¤ä»˜ç¾é‡‘æˆ–åŒ¯æ¬¾",
            "æª¢è­¦ä¸æœƒç”¨LINEè£½ä½œç­†éŒ„",
            "æª¢è­¦ä¸æœƒä»¥é›»è©±å‚³é€å…¬æ–‡",
            "æ¥åˆ°å¯ç–‘ä¾†é›»ï¼Œæ›æ–·ä¸¦æ’¥æ‰“165åè©é¨™å°ˆç·šæŸ¥è­‰",
            "å°ä¾†é›»é¡¯ç¤º110æˆ–æ´¾å‡ºæ‰€é›»è©±ä¿æŒæ‡·ç–‘ï¼Œé€™äº›è™Ÿç¢¼å¯èƒ½è¢«å½é€ ",
            "é†«é™¢çµ•ä¸æœƒè½‰æ¥æª¢è­¦è™•ç†å†’ç”¨èº«åˆ†æˆ–ä»£é ˜è—¥å“äº‹å®œ",
            "ä¸é€éœ²å€‹äººè³‡è¨Šï¼Œä¸é»æ“Šä¸æ˜é€£çµï¼Œä¸è¼•æ˜“åŒ¯æ¬¾"
        ]
    },
    "é‡‘èå¸³æˆ¶è©é¨™": {
        "description": "é€éå„ç¨®æ‰‹æ®µé¨™å–æ°‘çœ¾é‡‘èå¸³æˆ¶ã€é‡‘èå¡æˆ–ç¶²è·¯éŠ€è¡Œå¯†ç¢¼ï¼Œç”¨æ–¼éæ³•äº¤æ˜“æˆ–æ´—éŒ¢",
        "examples": [
            "å—å®³è€…çœ‹åˆ°ä¸€å‰‡ã€Œå‡ºç§Ÿé‡‘èå¸³æˆ¶ï¼Œè¼•é¬†è³ºç§Ÿé‡‘ã€çš„å»£å‘Šå¾Œå¿ƒå‹•ï¼Œèˆ‡å°æ–¹è¯ç¹«ä¸¦æŒ‰æŒ‡ç¤ºå°‡ææ¬¾å¡å’Œå¸³æˆ¶è³‡è¨Šæ”¾ç½®åœ¨æŒ‡å®šçš„è®Šé›»ç®±ä¸­ã€‚è©é¨™è€…å–å¾—å¸³æˆ¶æ§åˆ¶æ¬Šå¾Œé€²è¡Œå¤§é‡éæ³•äº¤æ˜“ï¼Œå°è‡´å¸³æˆ¶è¢«éŠ€è¡Œå‡çµï¼Œå—å®³è€…ä¸åƒ…æœªå¾—åˆ°æ‰¿è«¾çš„ç§Ÿé‡‘ï¼Œé‚„é¢è‡¨æ³•å¾‹è¿½è¨´é¢¨éšªã€‚"
        ],
        "sop": [
            "å¸³æˆ¶ã€ææ¬¾å¡åŠå¯†ç¢¼æ˜¯å€‹äººè²¡å‹™å®‰å…¨æ ¸å¿ƒï¼Œåˆ‡å‹¿å‡ºç§Ÿæˆ–äº¤äºˆä»–äºº",
            "ä»»ä½•è²ç¨±å‡ºç§Ÿå¸³æˆ¶å¯è³ºéŒ¢çš„å»£å‘Šï¼Œéƒ½æ˜¯è©é¨™",
            "ä¸è¦å—é«˜å ±é…¬èª˜æƒ‘å‡ºå€Ÿé‡‘èå¸³æˆ¶",
            "ä¸è¦è¼•ä¿¡å¯è¼•é¬†è³ºå–é¡å¤–æ”¶å…¥çš„å»£å‘Š",
            "éŠ€è¡Œå®¢æœä¸æœƒè¦æ±‚æä¾›å®Œæ•´å¡è™Ÿæˆ–å¯†ç¢¼",
            "ç™¼ç¾å¸³æˆ¶æœ‰ç•°å¸¸æ´»å‹•ï¼Œæ‡‰ç«‹å³è¯ç¹«éŠ€è¡Œæˆ–æ’¥æ‰“165å°ˆç·š",
            "ä¸è¦åœ¨æœªç¶“ç¢ºèªçš„ç¶²ç«™è¼¸å…¥é‡‘èè³‡è¨Š",
            "ä¿è­·å€‹äººé‡‘èè³‡è¨Šï¼Œä¸è¦å‘é™Œç”Ÿäººé€éœ²"
        ]
    },
    "é‡£é­šç°¡è¨Šè©é¨™": {
        "description": "é€éå½è£æˆå®˜æ–¹æ©Ÿæ§‹æˆ–çŸ¥åä¼æ¥­çš„è¨Šæ¯ï¼Œèª˜å°é»æ“Šæƒ¡æ„é€£çµï¼Œé¨™å–å€‹äººè³‡æ–™æˆ–é‡‘èè³‡è¨Š",
        "examples": [
            "æ°‘çœ¾å°å¼µæ”¶åˆ°ä¸€å‰‡è²ç¨±ä¾†è‡ªä¸­è¯é›»ä¿¡çš„ç°¡è¨Šï¼Œå…§å®¹ç‚ºï¼šã€Œ[ä¸­è¯é›»ä¿¡]æ‚¨æ­£åœ¨ç”³è«‹çš„ç¶²è·¯æœå‹™å› å€‹è³‡é©—è­‰å¤±æ•—ï¼Œè«‹é»æ“Šä¸‹æ–¹é€£çµé‡æ–°è£œé©—...ã€ï¼Œä¸¦é™„ä¸Šä¸€ä¸²çŸ­ç¶²å€ã€‚å°å¼µä¸€æ™‚ä¸å¯Ÿé»æ“Šé€£çµï¼Œé€²å…¥ä¸€å€‹èˆ‡ä¸­è¯é›»ä¿¡å®˜ç¶²æ¥µç‚ºç›¸ä¼¼çš„é é¢ï¼Œä¸¦ä¾ç…§æŒ‡ç¤ºè¼¸å…¥äº†èº«åˆ†è­‰å­—è™Ÿã€éŠ€è¡Œå¸³è™ŸåŠä¿¡ç”¨å¡è³‡è¨Šã€‚ä¸ä¹…å¾Œï¼Œä»–ä¾¿æ”¶åˆ°éŠ€è¡Œé€šçŸ¥æœ‰å¤šç­†ä¸æ˜æ¶ˆè²»ï¼Œæ‰é©šè¦ºå—é¨™ã€‚"
        ],
        "sop": [
            "æ”¶åˆ°ä»»ä½•è¦æ±‚é»æ“Šé€£çµä¸¦è¼¸å…¥å€‹äººè³‡æ–™çš„ç°¡è¨Šï¼Œå‹™å¿…æé«˜è­¦è¦ºã€‚",
            "ä¸è¦é»æ“Šä¾†æºä¸æ˜çš„ç°¡è¨Šé€£çµã€‚",
            "å®˜æ–¹æ©Ÿæ§‹ä¸æœƒé€éç°¡è¨Šè¦æ±‚æ°‘çœ¾è¼¸å…¥æ•æ„Ÿå€‹è³‡æˆ–éŠ€è¡Œå¸³æˆ¶è³‡è¨Šã€‚",
            "ä»”ç´°æª¢æŸ¥ç¶²å€æ˜¯å¦ç‚ºå®˜æ–¹ç¶²å€ï¼Œé‡£é­šç¶²ç«™é€šå¸¸æœƒæœ‰ç´°å¾®å·®ç•°ã€‚",
            "é–‹å•Ÿç°¡è¨Šå¯¦è¯åˆ¶ï¼Œä¸¦ç¢ºèªç™¼é€è™Ÿç¢¼æ˜¯å¦ç‚ºå®˜æ–¹è™Ÿç¢¼ã€‚",
            "è‹¥ä¸ç¢ºå®šç°¡è¨ŠçœŸå½ï¼Œæ‡‰ç›´æ¥å‘å®˜æ–¹å®¢æœæŸ¥è­‰ï¼Œè€Œéé»æ“Šç°¡è¨Šä¸­é€£çµã€‚",
            "å®‰è£é˜²æ¯’è»Ÿé«”ä¸¦å®šæœŸæ›´æ–°ï¼Œå¯å”åŠ©åµæ¸¬æƒ¡æ„ç¶²ç«™ã€‚",
            "æ•™è‚²å®¶ä¸­é•·è¼©è­˜åˆ¥é‡£é­šç°¡è¨Šçš„æŠ€å·§ã€‚",
            "è‹¥å·²é»æ“Šä¸¦è¼¸å…¥è³‡æ–™ï¼Œæ‡‰ç«‹å³è¯ç¹«éŠ€è¡Œåœå¡ä¸¦å ±è­¦è™•ç†ã€‚"
        ]
    },
    "é»æ•¸è³¼è²·è©é¨™": {
        "description": "è¦æ±‚è¢«å®³äººè³¼è²·éŠæˆ²é»æ•¸ã€ç¦®å“å¡ç­‰ï¼Œä¸¦æä¾›å…¶åºè™Ÿæˆ–å¯†ç¢¼çš„è©é¨™æ‰‹æ³•",
        "examples": [
            "ğŸ® è™›æ“¬å¯¶ç‰©æ›ç¾é‡‘çš„é¨™å±€ ğŸ®\n\næˆ‘åœ¨ã€Šç†±è¡€æ±Ÿæ¹–ã€‹éŠæˆ²æ‰“åˆ°äº†ä¸€ä»¶ç›¸ç•¶ç¨€æœ‰ç½•è¦‹çš„å¯¶ç‰©ï¼Œåœ¨éŠæˆ²åœˆå…§å¸å¼•äº†ä¸å°‘ç©å®¶çš„æ³¨æ„ï¼Œæœ‰ä¸€ä½éŠæˆ²æš±ç¨±ã€Œæ—åŒ—å°èˆã€çš„å¥½å‹ç§è¨Šæˆ‘ï¼Œèªªä»–å¾ˆæƒ³æ”¶è³¼æˆ‘çš„å¯¶ç‰©ã€‚ä»–è¡¨ç¤ºå¯¶ç‰©å°ä»–çµ„è£è£å‚™éå¸¸é‡è¦ï¼Œé¡˜æ„ä»¥8,500å…ƒåƒ¹æ ¼è³¼å…¥ã€‚å› ç‚ºä¹‹å‰æˆ‘å€‘æ›¾çµ„éšŠèŠéå¥½å¹¾æ¬¡ï¼Œå°æ–¹çœ‹èµ·ä¾†ä¸åƒé¨™å­ï¼Œæˆ‘ä¾¿ç­”æ‡‰å‡ºå”®å¯¶ç‰©ã€‚\n\nä¸éï¼Œå°æ–¹èªªæœˆåº•æ‰é ˜è–ªæ°´ï¼Œç„¡æ³•é¦¬ä¸Šä»˜æ¬¾ï¼Œèƒ½å¦å…ˆäº¤ä»˜å¯¶ç‰©è®“ä»–æå‰å¢å¼·è£å‚™ï¼Œç­‰åˆ°æœˆåº•é ˜è–ªå¾Œå†åŒ¯æ¬¾ã€‚æˆ‘å¿ƒæƒ³ï¼Œå¤§å®¶éƒ½æ˜¯åŒä¸€å€‹éŠæˆ²å…¬æœƒçš„è€ç©å®¶ï¼Œæœ‰ä¸€å®šçš„ä¿¡ä»»åŸºç¤ï¼Œæ²’å¤šæƒ³å°±æŠŠå¯¶ç‰©äº¤çµ¦äº†ä»–ã€‚\n\nä¹‹å¾Œï¼Œæˆ‘å’Œã€Œæ—åŒ—å°èˆã€ä¾èˆŠæ¯å¤©åœ¨éŠæˆ²ä¸­äº’å‹•ï¼Œä»–èª‡è®šæˆ‘é‚£ä»¶å¯¶ç‰©å¹«äº†ä»–å¤§å¿™ï¼Œè®“ä»–åœ¨éŠæˆ²ä¸­å¦‚è™æ·»ç¿¼ã€‚ç„¶è€Œï¼Œåˆ°äº†ç´„å®šä»˜æ¬¾æ—¥æœŸï¼Œæˆ‘å»å§‹çµ‚æ²’æ”¶åˆ°ä»–çš„åŒ¯æ¬¾æ¶ˆæ¯ã€‚å‰›é–‹å§‹ï¼Œæˆ‘æé†’ä»–å¹¾æ¬¡ï¼Œä»–ç¸½æ˜¯å„ç¨®ç†ç”±æ¨è„«ï¼Œè¦å˜›è–ªæ°´å»¶é²ç™¼æ”¾ã€è¦å˜›å®¶è£¡è‡¨æ™‚æœ‰æ€¥ç”¨ï¼Œç•¢ç«Ÿæˆ‘å€‘ä¹Ÿç®—æ˜¯æœ‹å‹ï¼Œå°±å†å¯¬é™å¹¾å¤©å§ã€‚\n\næœ‰å¤©ï¼Œæˆ‘ç™¼ç¾ä»–ä¸å†å›æˆ‘è¨Šæ¯ï¼Œé€£éŠæˆ²è§’è‰²ä¹Ÿæ¶ˆå¤±å¾—ç„¡å½±ç„¡è¹¤ï¼Œæˆ‘é€™æ‰é©šè¦ºï¼Œè‡ªå·±è¢«é¨™äº†ï¼\n\nğŸ“Š è³‡æ–™ä¾†æºï¼š165æ‰“è©å„€è¡¨æ¿"
        ],
        "sop": [
            "âš ï¸ å¸¸è¦‹çŠ¯ç½ªæ‰‹æ³•åŠè©±è¡“ âš ï¸",
            "1ï¸âƒ£ é›™æ–¹ç´„å®šäº¤æ˜“éŠæˆ²å¸³è™Ÿ/éŠæˆ²è£å‚™/é»æ•¸",
            "2ï¸âƒ£ è¦æ±‚è‡³éŠæˆ²äº¤æ˜“å¹³å°ç¶²ç«™äº¤æ˜“ï¼Œå»è¢«ç¶²ç«™å‘ŠçŸ¥å¸³æˆ¶å‡ºéŒ¯è¦æ±‚å„²å€¼æ‰èƒ½é€€æ¬¾",
            "3ï¸âƒ£ å°æ–¹ç¨±ä¸æ˜åŸå› ç„¡æ³•äº¤æ˜“å‚³é€ä¸€åœ‹éš›æ“”ä¿å¹³å°äº¤æ˜“é€£çµï¼Œå¹³å°å®¢æœç¨±å¸³æˆ¶å‡çµï¼Œéœ€å„²å€¼æ‰èƒ½è§£å‡",
            "4ï¸âƒ£ è¦æ±‚åŒ¯æ¬¾è‡³æŒ‡å®šå¸³æˆ¶å„²å€¼",
            "5ï¸âƒ£ è¦æ±‚è³¼è²·é»æ•¸å¡å¾Œæ‹ç…§",
            "",
            "ğŸ›¡ï¸ é˜²è©å°æ’‡æ­¥ ğŸ›¡ï¸",
            "è™›æ“¬å¯¶ç‰©äº¤æ˜“ï¼Œæ‡‰é¸æ“‡å®˜æ–¹èªå¯çš„ç¬¬ä¸‰æ–¹å¹³å°ï¼Œæ‰æœ‰ä¿éšœã€‚",
            "",
            "ğŸ” è©é¨™è©±è¡“è§£æ ğŸ”",
            "1. è™›æ“¬éŠæˆ²å¥½å‹è¡¨é”è³¼è²·è™›æ“¬å¯¶ç‰©æ„é¡˜",
            "2. èª˜é¨™æå‰äº¤ä»˜è™›æ“¬å¯¶ç‰©ï¼Œå»è—‰æ•…å»¶é²ä»˜æ¬¾ï¼Œä¸¦å¤±è¯"
        ]
    }
}

# åŠ è¼‰è©é¨™è©±è¡“è³‡æ–™åº« (å¯é¸)
FRAUD_TACTICS_DB = "fraud_tactics.json"
fraud_tactics_data = {}

def load_fraud_tactics():
    global fraud_tactics_data
    try:
        with open(FRAUD_TACTICS_DB, 'r', encoding='utf-8') as f:
            fraud_tactics_data = json.load(f)
        logger.info(f"æˆåŠŸå¾ {FRAUD_TACTICS_DB} åŠ è¼‰è©é¨™è©±è¡“æ•¸æ“š")
    except FileNotFoundError:
        logger.warning(f"è©é¨™è©±è¡“æ–‡ä»¶ {FRAUD_TACTICS_DB} æœªæ‰¾åˆ°ã€‚")
        fraud_tactics_data = {} # Ensure it's an empty dict if file not found
    except json.JSONDecodeError:
        logger.error(f"è§£æè©é¨™è©±è¡“æ–‡ä»¶ {FRAUD_TACTICS_DB} å¤±æ•—ã€‚")
        fraud_tactics_data = {} # Ensure it's an empty dict on parse error
    except Exception as e:
        logger.error(f"åŠ è¼‰è©é¨™è©±è¡“æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: {e}")
        fraud_tactics_data = {}

load_fraud_tactics()

# è©é¨™è©±è¡“è³‡æ–™åº«
fraud_tactics = fraud_tactics_data

# ç²å–ç”¨æˆ¶å€‹äººè³‡æ–™
def get_user_profile(user_id):
    try:
        profile = line_bot_api.get_profile(user_id)
        return profile
    except Exception as e:
        logger.error(f"ç²å–ç”¨æˆ¶ {user_id} å€‹äººè³‡æ–™å¤±æ•—: {e}")
        return None

# åˆ†æè©é¨™é¢¨éšªä¸¦è§£æçµæœ
def parse_fraud_analysis(analysis_result):
    """
    å¾ChatGPTçš„å›æ‡‰ä¸­è§£æå‡ºè©é¨™åˆ†æçµæœã€‚
    é æœŸæ ¼å¼ï¼š
    é¢¨éšªç­‰ç´šï¼š[é«˜/ä¸­/ä½/ç„¡é¢¨éšª/ä¸ç¢ºå®š]
    å¯èƒ½è©é¨™é¡å‹ï¼š[é¡å‹1, é¡å‹2, ... æˆ– ä¸é©ç”¨]
    èªªæ˜ï¼š[å…·é«”èªªæ˜]
    å»ºè­°ï¼š[å…·é«”å»ºè­°] 
    æ–°èˆˆæ‰‹æ³•ï¼š[æ˜¯/å¦] (å¯é¸)
    """
    if not analysis_result:
        return {
            "risk_level": "ä¸ç¢ºå®š",
            "fraud_type": "æœªçŸ¥",
            "explanation": "ç„¡æ³•ç²å–åˆ†æçµæœã€‚",
            "suggestions": "è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«å®¢æœã€‚",
            "is_emerging": False
        }

    # åˆå§‹çµæœå­—å…¸ï¼ŒåŒ…å«é è¨­å€¼
    result = {
        "risk_level": "ä¸ç¢ºå®š",
        "fraud_type": "æœªçŸ¥",
        "explanation": "ç„¡æ³•è§£æåˆ†æçµæœã€‚",
        "suggestions": "è«‹ä¿æŒè­¦æƒ•ï¼Œå¦‚æœ‰ç–‘å•å¯è«®è©¢165åè©é¨™å°ˆç·šã€‚",
        "is_emerging": False
    }

    try:
        # å…ˆè™•ç†æœ€å¸¸è¦‹çš„æƒ…æ³ï¼šJSONæ ¼å¼
        if analysis_result.strip().startswith('{') and analysis_result.strip().endswith('}'):
            import json
            try:
                # å˜—è©¦è§£æJSON
                parsed_data = json.loads(analysis_result)
                
                # é¢¨éšªç­‰ç´š - è™•ç†å„ç¨®å¯èƒ½çš„éµåå’Œæ ¼å¼
                for key in ['risk_level', 'risk level', 'riskLevel', 'é¢¨éšªç­‰ç´š', 'é¢¨éšª']:
                    if key in parsed_data and parsed_data[key]:
                        result["risk_level"] = parsed_data[key]
                        break
                
                # è©é¨™é¡å‹ - è™•ç†å„ç¨®å¯èƒ½çš„éµåå’Œæ ¼å¼
                for key in ['fraud_type', 'type', 'fraudType', 'è©é¨™é¡å‹', 'å¯èƒ½è©é¨™é¡å‹', 'é¡å‹']:
                    if key in parsed_data and parsed_data[key]:
                        result["fraud_type"] = parsed_data[key]
                        break
                
                # è™•ç†"ç„¡"æˆ–"ä¸é©ç”¨"çš„è©é¨™é¡å‹
                if result["fraud_type"].lower() in ["ä¸é©ç”¨", "ç„¡", "none", "n/a"]:
                 result["fraud_type"] = "éè©é¨™ç›¸é—œ"
                
                # è§£é‡‹èªªæ˜ - è™•ç†å„ç¨®å¯èƒ½çš„éµåå’Œæ ¼å¼
                for key in ['explanation', 'explain', 'èªªæ˜', 'åˆ†æç†ç”±', 'ç†ç”±', 'åˆ†æ']:
                    if key in parsed_data and parsed_data[key]:
                        # å¦‚æœæ˜¯åˆ—è¡¨ï¼Œå°±ç”¨æ›è¡Œç¬¦åˆä½µ
                        if isinstance(parsed_data[key], list):
                            result["explanation"] = '\n'.join(parsed_data[key])
                        else:
                            result["explanation"] = parsed_data[key]
                        break
                
                # å»ºè­° - è™•ç†å„ç¨®å¯èƒ½çš„éµåå’Œæ ¼å¼
                for key in ['suggestions', 'suggestion', 'advice', 'å»ºè­°', 'é˜²ç¯„å»ºè­°']:
                    if key in parsed_data and parsed_data[key]:
                        # å¦‚æœæ˜¯åˆ—è¡¨ï¼Œå°±ç”¨æ›è¡Œç¬¦åˆä½µ
                        if isinstance(parsed_data[key], list):
                            result["suggestions"] = '\n'.join(parsed_data[key])
                        else:
                            result["suggestions"] = parsed_data[key]
                        break
                
                # æ–°èˆˆæ‰‹æ³• - è™•ç†å„ç¨®å¯èƒ½çš„éµåå’Œæ ¼å¼
                for key in ['is_emerging', 'isEmerging', 'æ–°èˆˆæ‰‹æ³•', 'æ˜¯å¦æ–°èˆˆ']:
                    if key in parsed_data:
                        # è™•ç†ä¸åŒçš„å¸ƒçˆ¾å€¼æ ¼å¼
                        val = parsed_data[key]
                        if isinstance(val, bool):
                            result["is_emerging"] = val
                        elif isinstance(val, str):
                            result["is_emerging"] = val.lower() in ['true', 'yes', 'æ˜¯', '1', 't', 'y']
                        elif isinstance(val, int):
                            result["is_emerging"] = val == 1
                        break
                
                # å¦‚æœä»»ä½•å¿…è¦å­—æ®µä»ç„¶ç¼ºå°‘ï¼Œæˆ‘å€‘å¯ä»¥é€šéåŸå§‹æ–‡æœ¬é€²è¡Œé€²ä¸€æ­¥è§£æ
                if result["risk_level"] == "ä¸ç¢ºå®š" or result["fraud_type"] == "æœªçŸ¥" or result["explanation"] == "ç„¡æ³•è§£æåˆ†æçµæœã€‚":
                    # ç¹¼çºŒä½¿ç”¨æ–‡æœ¬è§£ææ–¹æ³•
                    logger.info("JSONè§£æçµæœä¸å®Œæ•´ï¼Œä½¿ç”¨é¡å¤–çš„æ–‡æœ¬è§£æ")
                else:
                    return result

            except json.JSONDecodeError as e:
                # JSONè§£æå¤±æ•—ï¼Œä½¿ç”¨æ–‡æœ¬è§£æ
                logger.warning(f"JSONè§£æå¤±æ•—: {e}ï¼Œæ”¹ç”¨æ–‡æœ¬è§£æ")
        
        # æ–‡æœ¬è§£æ - å¢å¼·çš„ç‰ˆæœ¬ï¼Œå¯ä»¥è™•ç†å„ç¨®æ ¼å¼
        # ä½¿ç”¨å¤šç¨®åˆ†éš”ç¬¦è™Ÿå’Œæ¨¡å¼åŒ¹é…
        
        # 1. åˆ†æé¢¨éšªç­‰ç´š
        risk_patterns = [
            r'é¢¨éšªç­‰ç´š[ï¼š:]\s*(.+?)(?:\n|$)',
            r'risk_level[ï¼š:]\s*(.+?)(?:\n|$)',
            r'é¢¨éšª[ï¼š:]\s*(.+?)(?:\n|$)',
            r'1\.\s*(?:é¢¨éšªç­‰ç´š)?[ï¼š:]\s*(.+?)(?:\n|$)'
        ]
        for pattern in risk_patterns:
            import re
            match = re.search(pattern, analysis_result, re.IGNORECASE)
            if match:
                result["risk_level"] = match.group(1).strip()
                break
        
        # 2. åˆ†æè©é¨™é¡å‹
        fraud_patterns = [
            r'è©é¨™é¡å‹[ï¼š:]\s*(.+?)(?:\n|$)',
            r'fraud_type[ï¼š:]\s*(.+?)(?:\n|$)',
            r'å¯èƒ½è©é¨™é¡å‹[ï¼š:]\s*(.+?)(?:\n|$)',
            r'é¡å‹[ï¼š:]\s*(.+?)(?:\n|$)',
            r'2\.\s*(?:è©é¨™é¡å‹)?[ï¼š:]\s*(.+?)(?:\n|$)'
        ]
        for pattern in fraud_patterns:
            match = re.search(pattern, analysis_result, re.IGNORECASE)
            if match:
                fraud_type = match.group(1).strip()
                if fraud_type.lower() in ["ä¸é©ç”¨", "ç„¡", "none", "n/a"]:
                    fraud_type = "éè©é¨™ç›¸é—œ"
                result["fraud_type"] = fraud_type
                break
        
        # 3. åˆ†æç†ç”±/èªªæ˜
        explanation_patterns = [
            r'èªªæ˜[ï¼š:]\s*(.+?)(?=(?:å»ºè­°|suggestions|suggestion|é˜²ç¯„å»ºè­°|æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'explanation[ï¼š:]\s*(.+?)(?=(?:å»ºè­°|suggestions|suggestion|é˜²ç¯„å»ºè­°|æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'åˆ†æç†ç”±[ï¼š:]\s*(.+?)(?=(?:å»ºè­°|suggestions|suggestion|é˜²ç¯„å»ºè­°|æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'ç†ç”±[ï¼š:]\s*(.+?)(?=(?:å»ºè­°|suggestions|suggestion|é˜²ç¯„å»ºè­°|æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'3\.\s*(?:åˆ†æç†ç”±)?[ï¼š:]\s*(.+?)(?=(?:4\.|å»ºè­°|suggestions|suggestion|é˜²ç¯„å»ºè­°|æ–°èˆˆæ‰‹æ³•|is_emerging|$))'
        ]
        for pattern in explanation_patterns:
            match = re.search(pattern, analysis_result, re.IGNORECASE | re.DOTALL)
            if match:
                explanation = match.group(1).strip()
                if explanation:
                    result["explanation"] = explanation
                break
        
        # 4. é˜²ç¯„å»ºè­°
        suggestion_patterns = [
            r'å»ºè­°[ï¼š:]\s*(.+?)(?=(?:æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'suggestions[ï¼š:]\s*(.+?)(?=(?:æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'suggestion[ï¼š:]\s*(.+?)(?=(?:æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'é˜²ç¯„å»ºè­°[ï¼š:]\s*(.+?)(?=(?:æ–°èˆˆæ‰‹æ³•|is_emerging|$))',
            r'4\.\s*(?:é˜²ç¯„å»ºè­°)?[ï¼š:]\s*(.+?)(?=$)'
        ]
        for pattern in suggestion_patterns:
            match = re.search(pattern, analysis_result, re.IGNORECASE | re.DOTALL)
            if match:
                suggestions = match.group(1).strip()
                if suggestions:
                    result["suggestions"] = suggestions
                break
        
        # 5. æ–°èˆˆæ‰‹æ³•
        emerging_patterns = [
            r'æ–°èˆˆæ‰‹æ³•[ï¼š:]\s*(.+?)(?:\n|$)',
            r'is_emerging[ï¼š:]\s*(.+?)(?:\n|$)'
        ]
        for pattern in emerging_patterns:
            match = re.search(pattern, analysis_result, re.IGNORECASE)
            if match:
                emerging_text = match.group(1).strip().lower()
                result["is_emerging"] = emerging_text in ["æ˜¯", "true", "yes", "1", "t", "y"]
                break
        
        # ç¢ºä¿çµæœä¸­æ‰€æœ‰çš„æ–‡æœ¬å­—æ®µä¸ç‚ºç©º
        for key in ["risk_level", "fraud_type", "explanation", "suggestions"]:
            if not result[key] or result[key].strip() == "":
                if key == "risk_level":
                    result[key] = "ä¸ç¢ºå®š"
                elif key == "fraud_type":
                    result[key] = "æœªçŸ¥"
                elif key == "explanation":
                    result[key] = "ç„¡æ³•æå–åˆ†æç†ç”±ã€‚"
                elif key == "suggestions":
                    result[key] = "è«‹ä¿æŒè­¦æƒ•ï¼Œå¦‚æœ‰ç–‘å•å¯è«®è©¢165åè©é¨™å°ˆç·šã€‚"
        
        return result
    
    except Exception as e:
        logger.error(f"è§£æè©é¨™åˆ†æçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return {
            "risk_level": "ä¸ç¢ºå®š",
            "fraud_type": "æœªçŸ¥",
            "explanation": "ç„¡æ³•è§£æåˆ†æçµæœã€‚ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
            "suggestions": "è«‹ä¿æŒè­¦æƒ•ï¼Œå¦‚æœ‰ç–‘å•å¯è«®è©¢165åè©é¨™å°ˆç·šã€‚",
            "is_emerging": False
        }

def detect_fraud_with_chatgpt(user_message, display_name="æœ‹å‹", user_id=None):
    """ä½¿ç”¨OpenAIçš„APIæª¢æ¸¬è©é¨™ä¿¡æ¯"""
    try:
        # æª¢æŸ¥è¨Šæ¯æ˜¯å¦åŒ…å«URL
        original_url = None
        expanded_url = None
        is_short_url = False
        url_expanded_successfully = False
        
        url_pattern = re.compile(r'(https?://\S+|www\.\S+)')
        url_match = url_pattern.search(user_message)
        
        if url_match:
            original_url = url_match.group(0)
            # ç¢ºä¿URLé–‹é ­æ˜¯http://æˆ–https://
            if not original_url.startswith(('http://', 'https://')):
                original_url = 'https://' + original_url
                
            # å±•é–‹å¯èƒ½çš„çŸ­ç¶²å€
            original_url, expanded_url, is_short_url, url_expanded_successfully = expand_short_url(original_url)
            
            # å¦‚æœæ˜¯çŸ­ç¶²å€ä¸”æˆåŠŸå±•é–‹ï¼Œèª¿æ•´åˆ†æè¨Šæ¯
            if is_short_url and url_expanded_successfully:
                # å°‡åŸå§‹è¨Šæ¯ä¸­çš„çŸ­ç¶²å€æ›¿æ›ç‚ºå±•é–‹å¾Œçš„URLï¼Œä»¥ä¾¿æ–¼åˆ†æ
                analysis_message = user_message.replace(original_url, f"{original_url} (å±•é–‹å¾Œ: {expanded_url})")
                logger.info(f"å·²å±•é–‹çŸ­ç¶²å€é€²è¡Œåˆ†æ: {original_url} -> {expanded_url}")
            else:
                analysis_message = user_message
        else:
            analysis_message = user_message

        # æª¢æŸ¥è¨Šæ¯æ˜¯å¦åŒ…å«ç™½åå–®ä¸­çš„ç¶²å€
        for safe_domain in SAFE_DOMAINS.keys():  # ä¿®å¾©ï¼šä½¿ç”¨.keys()ä¾†éæ­·å­—å…¸çš„éµ
            if safe_domain in analysis_message:
                logger.info(f"æª¢æ¸¬åˆ°ç™½åå–®ä¸­çš„åŸŸå: {safe_domain}")
                # ç²å–ç¶²ç«™æè¿°ä¿¡æ¯
                site_description = SAFE_DOMAINS.get(safe_domain, "å°ç£å¸¸è¦‹çš„å¯é ç¶²ç«™")
                return {
                    "success": True,
                    "message": "åˆ†æå®Œæˆ",
                    "result": {
                        "risk_level": "ä½é¢¨éšª",
                        "fraud_type": "éè©é¨™ç›¸é—œ",
                        "explanation": f"é€™å€‹ç¶²ç«™æ˜¯ {safe_domain}ï¼Œ{site_description}ï¼Œå¯ä»¥å®‰å¿ƒä½¿ç”¨ã€‚",
                        "suggestions": "é€™æ˜¯æ­£è¦ç¶²ç«™ï¼Œä¸å¿…ç‰¹åˆ¥æ“”å¿ƒã€‚å¦‚æœ‰ç–‘æ…®ï¼Œå»ºè­°æ‚¨ç›´æ¥å¾å®˜æ–¹ç®¡é“é€²å…¥è©²ç¶²ç«™ã€‚",
                        "is_emerging": False,
                        "display_name": display_name,
                        "original_url": original_url,
                        "expanded_url": expanded_url,
                        "is_short_url": is_short_url,
                        "url_expanded_successfully": url_expanded_successfully
                    },
                    "raw_result": f"ç¶“éåˆ†æï¼Œé€™æ˜¯å·²çŸ¥çš„å¯ä¿¡ä»»ç¶²ç«™ï¼š{site_description}"
                }
            
        # å¦‚æœæ˜¯çŸ­ç¶²å€ä½†ç„¡æ³•å±•é–‹ï¼Œæé«˜é¢¨éšªè©•ä¼°
        special_notes = ""
        if is_short_url and not url_expanded_successfully:
            special_notes = "é€™æ˜¯å€‹çŸ­ç¶²å€ï¼Œä½†æˆ‘å€‘ç„¡æ³•å±•é–‹æŸ¥çœ‹çœŸæ­£çš„ç›®çš„åœ°ï¼Œé€™ç¨®æƒ…æ³è¦ç‰¹åˆ¥å°å¿ƒã€‚çŸ­ç¶²å€å¸¸è¢«è©é¨™è€…åˆ©ç”¨ä¾†éš±è—çœŸå¯¦çš„æƒ¡æ„ç¶²ç«™ã€‚é™¤éæ‚¨éå¸¸ç¢ºå®šé€™å€‹é€£çµå®‰å…¨ï¼Œå¦å‰‡ä¸å»ºè­°é»æ“Šã€‚"
            logger.warning(f"ç„¡æ³•å±•é–‹çš„çŸ­ç¶²å€: {original_url}ï¼Œå»ºè­°æé«˜è­¦è¦º")
        
        openai_prompt = f"""
        ä½ æ˜¯ä¸€å€‹è©é¨™é¢¨éšªè©•ä¼°å°ˆå®¶ï¼Œå°ˆé–€ç‚º50æ­²ä»¥ä¸Šçš„ä¸­è€å¹´äººæä¾›æ˜“æ‡‚çš„é¢¨éšªåˆ†æã€‚
        è«‹åˆ†æä»¥ä¸‹ä¿¡æ¯æ˜¯å¦åŒ…å«è©é¨™ç›¸é—œå…§å®¹ï¼Œä¸¦æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºçµæœï¼š
        
        é¢¨éšªç­‰ç´šï¼šï¼ˆä½é¢¨éšªã€ä¸­é¢¨éšªã€é«˜é¢¨éšªï¼‰
        è©é¨™é¡å‹ï¼šï¼ˆå¦‚æœæœ‰è©é¨™é¢¨éšªï¼Œè«‹æŒ‡å‡ºå…·é«”é¡å‹ï¼Œä¾‹å¦‚ï¼šå‡ç¶²è³¼ã€å‡äº¤å‹ã€å‡æŠ•è³‡ã€å‡è²¸æ¬¾ã€å‡æ±‚è·ç­‰ï¼›å¦‚æœç„¡é¢¨éšªï¼Œå¡«"ç„¡"ï¼‰
        èªªæ˜ï¼šï¼ˆè«‹ç”¨éå¸¸å£èªåŒ–ã€è¦ªåˆ‡çš„èªæ°£èªªæ˜åˆ¤æ–·ä¾æ“šï¼Œé¿å…ä½¿ç”¨å°ˆæ¥­è¡“èªï¼Œå°±åƒåœ¨è·Ÿé•·è¼©è§£é‡‹ä¸€æ¨£ã€‚ä¾‹å¦‚ä¸è¦èªªã€Œæ­¤ç¶²ç«™ä½¿ç”¨æ··æ·†æŠ€è¡“è¦é¿æª¢æ¸¬ã€ï¼Œè€Œæ˜¯èªªã€Œé€™å€‹ç¶²ç«™çœ‹èµ·ä¾†æ€ªæ€ªçš„ï¼Œç¶²å€è·Ÿæ­£å¸¸çš„ä¸ä¸€æ¨£ï¼Œå¯èƒ½æ˜¯å‡å†’çš„ã€ã€‚ä¹Ÿä¸è¦èªªã€Œæ‚¨ã€æˆ–ã€Œæˆ‘ã€ï¼Œè€Œæ˜¯ç›´æ¥èªªã€Œé€™ç¶²ç«™å¯èƒ½æœƒé¨™äººã€ã€Œå°å¿ƒä¸è¦é»é€™å€‹é€£çµã€ç­‰ï¼‰
        å»ºè­°ï¼šï¼ˆé‡å°æ½›åœ¨é¢¨éšªï¼Œç”¨ç°¡å–®æ˜“æ‡‚çš„èªè¨€æä¾›1-3é»å…·é«”å»ºè­°ï¼Œä¾‹å¦‚ã€Œä¸è¦é»é€™å€‹é€£çµã€ã€Œä¸è¦æä¾›éŠ€è¡Œå¸³è™Ÿã€ã€Œæ”¶åˆ°é€™ç¨®è¨Šæ¯æ™‚ï¼Œå…ˆæ‰“é›»è©±å•å•å®¶äººã€ç­‰ï¼‰
        æ–°èˆˆæ‰‹æ³•ï¼šæ˜¯/å¦
        
        {special_notes}
        
        ä»¥ä¸‹æ˜¯éœ€è¦åˆ†æçš„ä¿¡æ¯ï¼š
        ---
        {analysis_message}
        ---
        
        è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œé¿å…ç›´æ¥ä½¿ç”¨å•å€™èªã€‚ç›´æ¥é–‹å§‹åˆ†æã€‚å›ç­”æ‡‰ç°¡æ½”ç›´æ¥ï¼Œåƒæ˜¯å°ˆå®¶çµ¦å‡ºçš„é¢¨éšªæé†’ã€‚
        """
        
        # èª¿ç”¨OpenAI API (ä¿®æ­£ç‚ºæ–°ç‰ˆAPIæ ¼å¼)
        response = openai.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸€å€‹è©é¨™é¢¨éšªè©•ä¼°å°ˆå®¶ï¼Œè«‹ä»¥50æ­²ä»¥ä¸Šçš„é•·è¼©èƒ½ç†è§£çš„å£èªåŒ–æ–¹å¼åˆ†æè©é¨™é¢¨éšªã€‚é¿å…ä½¿ç”¨ã€Œæ‚¨ã€ã€Œæˆ‘ã€ç­‰ä¸»è§€ç”¨è©ï¼Œè€Œæ˜¯ä½¿ç”¨æ›´ç›´æ¥çš„è¡¨è¿°ã€‚æä¾›çš„å»ºè­°æ‡‰è©²å…·é«”å¯¦ç”¨ä¸”ç›´æ¥ã€‚"},
                {"role": "user", "content": openai_prompt}
            ],
            temperature=0.2,
            max_tokens=1000
        )
        
        if response and response.choices:
            analysis_result = response.choices[0].message.content.strip()
            logger.info(f"é¢¨éšªåˆ†æçµæœ: {analysis_result[:100]}...")  # åƒ…è¨˜éŒ„éƒ¨åˆ†çµæœ
            
            # å°‡çµæœè§£ææˆçµæ§‹åŒ–æ ¼å¼
            parsed_result = parse_fraud_analysis(analysis_result)
            
            # æ·»åŠ ä¸€å€‹ä½¿ç”¨è€…å¯è­˜åˆ¥çš„æ¨™è­˜
            parsed_result["display_name"] = display_name
            
            # æ·»åŠ URLç›¸é—œä¿¡æ¯
            parsed_result["original_url"] = original_url
            parsed_result["expanded_url"] = expanded_url
            parsed_result["is_short_url"] = is_short_url
            parsed_result["url_expanded_successfully"] = url_expanded_successfully
            
            # å¦‚æœæ˜¯çŸ­ç¶²å€ä½†ç„¡æ³•å±•é–‹ï¼Œæé«˜é¢¨éšªç­‰ç´š
            if is_short_url and not url_expanded_successfully:
                if parsed_result["risk_level"] == "ä½é¢¨éšª":
                    parsed_result["risk_level"] = "ä¸­é¢¨éšª"
                    parsed_result["explanation"] = f"{parsed_result['explanation']}\n\nâš ï¸ æ­¤å¤–ï¼Œé€™æ˜¯ä¸€å€‹çŸ­ç¶²å€ä½†ç„¡æ³•å±•é–‹æŸ¥çœ‹çœŸæ­£çš„ç›®çš„åœ°ï¼Œé€™é»ä¹Ÿè¦ç‰¹åˆ¥å°å¿ƒã€‚"
                
                if "çŸ­ç¶²å€" not in parsed_result["explanation"]:
                    parsed_result["explanation"] = f"{parsed_result['explanation']}\n\nâš ï¸ è¦æ³¨æ„é€™æ˜¯ä¸€å€‹çŸ­ç¶²å€(åƒæ˜¯ç¸®çŸ­éçš„ç¶²å€)ï¼Œç„¡æ³•çœ‹åˆ°çœŸæ­£è¦å»çš„ç¶²ç«™ï¼Œé€™ç¨®æƒ…æ³è¦ç‰¹åˆ¥å°å¿ƒã€‚"
                
                if "çŸ­ç¶²å€" not in parsed_result["suggestions"]:
                    parsed_result["suggestions"] = f"{parsed_result['suggestions']}\nâ€¢ é‡åˆ°çŸ­ç¶²å€æ™‚ï¼Œæœ€å¥½å…ˆè©¢å•å‚³é€é€£çµçš„äººæ˜¯ä»€éº¼å…§å®¹ï¼Œæˆ–è€…ä¹¾è„†ä¸è¦é»æ“Šã€‚"
            
            # å¦‚æœæ˜¯çŸ­ç¶²å€ä¸”æˆåŠŸå±•é–‹ï¼Œåœ¨çµæœä¸­åŠ å…¥èªªæ˜
            if is_short_url and url_expanded_successfully:
                parsed_result["explanation"] = f"{parsed_result['explanation']}\n\né€™å€‹é€£çµæ˜¯çŸ­ç¶²å€ï¼Œå·²ç¶“å¹«æ‚¨å±•é–‹æŸ¥çœ‹çœŸæ­£çš„ç›®çš„åœ°æ˜¯: {expanded_url}"
            
            # æª¢æŸ¥è§£æçµæœï¼Œç¢ºä¿æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½æœ‰å€¼
            if not parsed_result.get("explanation") or parsed_result["explanation"] == "ç„¡æ³•è§£æåˆ†æçµæœã€‚":
                # å¦‚æœç„¡æ³•æ­£ç¢ºè§£æç†ç”±ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å›æ‡‰
                logger.warning("ç„¡æ³•æ­£ç¢ºè§£æåˆ†æç†ç”±ï¼Œä½¿ç”¨åŸå§‹å›æ‡‰æ›¿ä»£")
                parsed_result["explanation"] = analysis_result.replace("é¢¨éšªç­‰ç´šï¼š", "").replace("è©é¨™é¡å‹ï¼š", "").replace("èªªæ˜ï¼š", "").replace("å»ºè­°ï¼š", "").replace("æ–°èˆˆæ‰‹æ³•ï¼š", "").strip()
                
                # ç¢ºä¿ç†ç”±ä¸ç‚ºç©º
                if not parsed_result["explanation"] or parsed_result["explanation"].strip() == "":
                    parsed_result["explanation"] = "é€™å€‹å…§å®¹çœ‹èµ·ä¾†æœ‰é»å¥‡æ€ªï¼Œå»ºè­°ä¸è¦è¼•æ˜“é»æ“Šæˆ–æä¾›å€‹äººè³‡æ–™ã€‚å¦‚æœä¸ç¢ºå®šï¼Œå¯ä»¥è«‹å®¶äººå¹«å¿™ç¢ºèªä¸€ä¸‹ã€‚"
            
            return {
                "success": True,
                "message": "åˆ†æå®Œæˆ",
                "result": parsed_result,
                "raw_result": analysis_result
            }
        else:
            logger.error("OpenAI API è¿”å›ç©ºçµæœ")
            return {
                "success": False,
                "message": "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"
            }
            
    except Exception as e:
        logger.exception(f"ä½¿ç”¨OpenAIåˆ†æè©é¨™ä¿¡æ¯æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return {
            "success": False,
            "message": f"åˆ†æéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {str(e)}"
        }

# --- Begin: Add these new functions for the game ---
def send_potato_game_question(user_id, reply_token):
    """
    Sends a new "é¸å“ªé¡†åœŸè±†" game question to the user.
    """
    global user_game_state
    
    # å„ªå…ˆå¾é è¨­é¡Œåº«é¸å–é¡Œç›®
    if potato_game_questions:
        # å¾é¡Œåº«ä¸­éš¨æ©Ÿé¸å–ä¸€é“é¡Œç›®
        question = random.choice(potato_game_questions)
        
        # è©é¨™è¨Šæ¯ï¼ˆå‡åœŸè±†ï¼‰
        false_potato_text = question['fraud_message']
        fraud_type = question['fraud_type']
        explanation = question.get('explanation', 'é€™æ˜¯ä¸€å‰‡è©é¨™è¨Šæ¯ï¼Œè«‹ä¿æŒè­¦è¦ºã€‚')
        
        # æª¢æŸ¥é¡Œç›®æ˜¯å¦å·²æœ‰é è¨­é¸é …
        if 'options' in question and question['options'] and 'correct_option' in question:
            # ä½¿ç”¨é¡Œåº«ä¸­çš„é è¨­é¸é …
            options = question['options'].copy()
            correct_option = question['correct_option']
            
            # éš¨æ©Ÿæ‰“äº‚é¸é …é †åº
            random.shuffle(options)
            
            # é‡æ–°æ˜ å°„é¸é …ID (åŸæœ¬å¯èƒ½æ˜¯A,B,Cï¼Œç¾åœ¨æ›æˆæ–°çš„é †åº)
            option_mapping = {'A': options[0], 'B': options[1], 'C': options[2] if len(options) > 2 else None}
            
            # è¨˜éŒ„æ­£ç¢ºç­”æ¡ˆçš„æ–°ä½ç½®
            for option_id, option in option_mapping.items():
                if option and option['id'] == correct_option:
                    new_correct_option = option_id
                    break
            else:
                new_correct_option = 'A'  # é è¨­å€¼ï¼Œæ‡‰è©²ä¸æœƒç™¼ç”Ÿ
                
            # é¡¯ç¤ºé¸é …çš„æ–‡æœ¬å…§å®¹
            options_display_texts = [option['text'] for option in options if option]
            if len(options_display_texts) < 3:
                # å¦‚æœé¸é …ä¸è¶³ä¸‰å€‹ï¼Œè£œå……
                while len(options_display_texts) < 3:
                    options_display_texts.append("æ­¤é¸é …ä¸é©ç”¨")
            
            # ä¿å­˜éŠæˆ²ç‹€æ…‹ï¼ŒåŒ…æ‹¬æ–°çš„é¸é …é †åºå’Œç­”æ¡ˆä½ç½®
            user_game_state[user_id] = {
                'false_potato_original': false_potato_text,
                'fraud_type_for_explanation': fraud_type,
                'custom_explanation': explanation,
                'option_A_text': options_display_texts[0],
                'option_B_text': options_display_texts[1],
                'option_C_text': options_display_texts[2] if len(options_display_texts) > 2 else "ç„¡é¸é …C",
                'correct_option': new_correct_option,
                'using_predefined_options': True
            }
        else:
            # é¡Œç›®æ²’æœ‰é è¨­é¸é …ï¼Œä½¿ç”¨åŸä¾†çš„é‚è¼¯
            # å‰µå»ºå…©å€‹æ˜é¡¯å®‰å…¨çš„è¨Šæ¯ï¼ˆçœŸåœŸè±†ï¼‰
            true_potato_texts = [
                "æé†’æ‚¨ï¼ŒéŠ€è¡Œæ¥­å‹™äººå“¡çµ•ä¸æœƒè¦æ±‚æ‚¨æä¾›ç¶²è·¯éŠ€è¡Œå¯†ç¢¼æˆ–æ˜¯ATMæ“ä½œã€‚å¦‚æœ‰ä»»ä½•ç–‘å•è«‹æ’¥æ‰“å®˜æ–¹å®¢æœé›»è©±æŸ¥è©¢ï¼Œä¸”å‹™å¿…è¦ªè‡ªæ’¥æ‰“ï¼Œä¸è¦ä½¿ç”¨å°æ–¹æä¾›çš„é›»è©±è™Ÿç¢¼ã€‚",
                "è³¼ç‰©å‰è«‹ç¢ºèªç¶²ç«™çš„å®‰å…¨æ€§ï¼Œé¸æ“‡æœ‰httpså’Œå®‰å…¨èªè­‰çš„å®˜æ–¹ç¶²ç«™ï¼Œä¸¦é€éç¬¬ä¸‰æ–¹æ”¯ä»˜æˆ–ä¿¡ç”¨å¡ä»˜æ¬¾ä»¥ç²å¾—äº¤æ˜“ä¿éšœã€‚é‡åˆ°è¦æ±‚ç§ä¸‹äº¤æ˜“æˆ–è¦æ±‚å…ˆä»˜æ¬¾çš„è³£å®¶è«‹ç‰¹åˆ¥å°å¿ƒã€‚",
                "æ¥åˆ°é™Œç”Ÿä¾†é›»å®£ç¨±æ‚¨æ¶‰åŠåˆ‘æ¡ˆã€æ´—éŒ¢ï¼Œéœ€è¦ç›£ç®¡å¸³æˆ¶æˆ–è½‰å¸³æ“ä½œï¼Œè«‹ç«‹å³æ›æ–·ã€‚å¸æ³•å–®ä½ä¸æœƒç”¨é›»è©±è¦æ±‚æ‚¨æ“ä½œATMæˆ–éŠ€è¡Œå¸³æˆ¶ã€‚è«‹æ’¥æ‰“165åè©é¨™å°ˆç·šç¢ºèªã€‚",
                "ç¶²è·¯æŠ•è³‡å‰è«‹æŸ¥è­‰å¹³å°åˆæ³•æ€§ï¼Œä»»ä½•å®£ç¨±ã€Œä¿è­‰ç²åˆ©ã€ã€ã€Œé›¶é¢¨éšªé«˜å ±é…¬ã€çš„æŠ•è³‡éƒ½æ¥µå¯èƒ½æ˜¯è©é¨™ã€‚åˆæ³•æŠ•è³‡ç®¡é“ä¸æœƒè¦æ±‚æ‚¨å®‰è£ç‰¹å®šAPPæˆ–åŠ å…¥ç‰¹å®šé€šè¨Šè»Ÿé«”ç¾¤çµ„ã€‚",
                "ä¿è­·å€‹äººè³‡æ–™å®‰å…¨ï¼Œä¸éš¨æ„æä¾›èº«åˆ†è­‰å­—è™Ÿã€éŠ€è¡Œå¸³è™Ÿç­‰è³‡è¨Šã€‚å°æ–¹å¦‚æœ‰è¦æ±‚è³¼è²·éŠæˆ²é»æ•¸ã€ç¦®å“å¡ï¼Œä¸¦è¦æ±‚æä¾›å¡è™Ÿåºè™Ÿï¼Œå¹¾ä¹éƒ½æ˜¯è©é¨™è¡Œç‚ºã€‚"
            ]
            
            # å¾å®‰å…¨è¨Šæ¯ä¸­éš¨æ©Ÿé¸æ“‡å…©å‰‡
            selected_true_potatoes = random.sample(true_potato_texts, 2)
            
            # æ‰“äº‚ä¸‰å€‹é¸é …çš„é †åº
            options_display_texts = [false_potato_text] + selected_true_potatoes
            random.shuffle(options_display_texts)

            # æ‰¾å‡ºè©é¨™è¨Šæ¯åœ¨æ‰“äº‚å¾Œçš„ä½ç½®
            correct_option = None
            for i, text in enumerate(options_display_texts):
                if text == false_potato_text:
                    if i == 0:
                        correct_option = 'A'
                    elif i == 1:
                        correct_option = 'B'
                        correct_option = 'C'
                    break

            user_game_state[user_id] = {
                'false_potato_original': false_potato_text,
                'fraud_type_for_explanation': fraud_type,
                'custom_explanation': explanation,
                'option_A_text': options_display_texts[0],
                'option_B_text': options_display_texts[1],
                'option_C_text': options_display_texts[2],
                'correct_option': correct_option,
                'using_predefined_options': False
            }
            # å¦‚æœæ²’æœ‰é è¨­é¡Œåº«ï¼Œå‰‡å›é€€åˆ°å¾Firebaseä¸­ç²å–
            logger.warning("ä½¿ç”¨Firebaseè³‡æ–™åº«ä½œç‚ºå‚™é¸é¡Œç›®ä¾†æº")
            report_data = firebase_manager.get_random_fraud_report_for_game()

            if not report_data:
                line_bot_api.reply_message(
                    reply_token,
                    TextSendMessage(text="æŠ±æ­‰ï¼Œç›®å‰é¡Œåº«è£¡æ²’æœ‰é¡Œç›®äº†ï¼Œç¨å¾Œå†è©¦è©¦å§ï¼")
                )
                return

            # è©é¨™è¨Šæ¯ï¼ˆå‡åœŸè±†ï¼‰
            false_potato_text = report_data['message']
            fraud_type = report_data['fraud_type']
            explanation = ""
            
            # å‰µå»ºå…©å€‹æ˜é¡¯å®‰å…¨çš„è¨Šæ¯ï¼ˆçœŸåœŸè±†ï¼‰
            true_potato_texts = [
                "æé†’æ‚¨ï¼ŒéŠ€è¡Œæ¥­å‹™äººå“¡çµ•ä¸æœƒè¦æ±‚æ‚¨æä¾›ç¶²è·¯éŠ€è¡Œå¯†ç¢¼æˆ–æ˜¯ATMæ“ä½œã€‚å¦‚æœ‰ä»»ä½•ç–‘å•è«‹æ’¥æ‰“å®˜æ–¹å®¢æœé›»è©±æŸ¥è©¢ï¼Œä¸”å‹™å¿…è¦ªè‡ªæ’¥æ‰“ï¼Œä¸è¦ä½¿ç”¨å°æ–¹æä¾›çš„é›»è©±è™Ÿç¢¼ã€‚",
                "è³¼ç‰©å‰è«‹ç¢ºèªç¶²ç«™çš„å®‰å…¨æ€§ï¼Œé¸æ“‡æœ‰httpså’Œå®‰å…¨èªè­‰çš„å®˜æ–¹ç¶²ç«™ï¼Œä¸¦é€éç¬¬ä¸‰æ–¹æ”¯ä»˜æˆ–ä¿¡ç”¨å¡ä»˜æ¬¾ä»¥ç²å¾—äº¤æ˜“ä¿éšœã€‚é‡åˆ°è¦æ±‚ç§ä¸‹äº¤æ˜“æˆ–è¦æ±‚å…ˆä»˜æ¬¾çš„è³£å®¶è«‹ç‰¹åˆ¥å°å¿ƒã€‚",
                "æ¥åˆ°é™Œç”Ÿä¾†é›»å®£ç¨±æ‚¨æ¶‰åŠåˆ‘æ¡ˆã€æ´—éŒ¢ï¼Œéœ€è¦ç›£ç®¡å¸³æˆ¶æˆ–è½‰å¸³æ“ä½œï¼Œè«‹ç«‹å³æ›æ–·ã€‚å¸æ³•å–®ä½ä¸æœƒç”¨é›»è©±è¦æ±‚æ‚¨æ“ä½œATMæˆ–éŠ€è¡Œå¸³æˆ¶ã€‚è«‹æ’¥æ‰“165åè©é¨™å°ˆç·šç¢ºèªã€‚",
                "ç¶²è·¯æŠ•è³‡å‰è«‹æŸ¥è­‰å¹³å°åˆæ³•æ€§ï¼Œä»»ä½•å®£ç¨±ã€Œä¿è­‰ç²åˆ©ã€ã€ã€Œé›¶é¢¨éšªé«˜å ±é…¬ã€çš„æŠ•è³‡éƒ½æ¥µå¯èƒ½æ˜¯è©é¨™ã€‚åˆæ³•æŠ•è³‡ç®¡é“ä¸æœƒè¦æ±‚æ‚¨å®‰è£ç‰¹å®šAPPæˆ–åŠ å…¥ç‰¹å®šé€šè¨Šè»Ÿé«”ç¾¤çµ„ã€‚",
                "ä¿è­·å€‹äººè³‡æ–™å®‰å…¨ï¼Œä¸éš¨æ„æä¾›èº«åˆ†è­‰å­—è™Ÿã€éŠ€è¡Œå¸³è™Ÿç­‰è³‡è¨Šã€‚å°æ–¹å¦‚æœ‰è¦æ±‚è³¼è²·éŠæˆ²é»æ•¸ã€ç¦®å“å¡ï¼Œä¸¦è¦æ±‚æä¾›å¡è™Ÿåºè™Ÿï¼Œå¹¾ä¹éƒ½æ˜¯è©é¨™è¡Œç‚ºã€‚"
            ]
            
            # å¾å®‰å…¨è¨Šæ¯ä¸­éš¨æ©Ÿé¸æ“‡å…©å‰‡
            selected_true_potatoes = random.sample(true_potato_texts, 2)
            
            # æ‰“äº‚ä¸‰å€‹é¸é …çš„é †åº
            options_display_texts = [false_potato_text] + selected_true_potatoes
            random.shuffle(options_display_texts)

            # æ‰¾å‡ºè©é¨™è¨Šæ¯åœ¨æ‰“äº‚å¾Œçš„ä½ç½®
            correct_option = None
            for i, text in enumerate(options_display_texts):
                if text == false_potato_text:
                    if i == 0:
                        correct_option = 'A'
                    elif i == 1:
                        correct_option = 'B'
                        correct_option = 'C'
                    break

            user_game_state[user_id] = {
                'false_potato_original': false_potato_text,
                'fraud_type_for_explanation': fraud_type,
                'custom_explanation': explanation,
                'option_A_text': options_display_texts[0],
                'option_B_text': options_display_texts[1],
                'option_C_text': options_display_texts[2],
                'correct_option': correct_option,
                'using_predefined_options': False
            }

    flex_message_content = BubbleContainer(
        body=BoxComponent(
            layout='vertical',
            contents=[
                TextComponent(text='é¸å“ªé¡†åœŸè±†ï¼ŸğŸ¤”', weight='bold', size='xl', align='center', margin='md'),
                TextComponent(text='è«‹æŒ‡å‡ºä¸‹åˆ—å“ªä¸€å€‹é¸é …ã€Œæ˜¯è©é¨™è¨Šæ¯ã€ï¼ˆä¹Ÿå°±æ˜¯å‡åœŸè±†ï¼‰ï¼Ÿ', wrap=True, margin='lg', size='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='é¸é … A:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_A_text'][:250] + '...' if len(user_game_state[user_id]['option_A_text']) > 250 else user_game_state[user_id]['option_A_text'], wrap=True, size='sm', margin='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='é¸é … B:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_B_text'][:250] + '...' if len(user_game_state[user_id]['option_B_text']) > 250 else user_game_state[user_id]['option_B_text'], wrap=True, size='sm', margin='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='é¸é … C:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_C_text'][:250] + '...' if len(user_game_state[user_id]['option_C_text']) > 250 else user_game_state[user_id]['option_C_text'], wrap=True, size='sm', margin='sm'),
            ]
        ),
        footer=BoxComponent(
            layout='vertical',
            spacing='sm',
            contents=[
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='é¸ A', data=f'action=potato_game_answer&chosen_option_id=A&uid={user_id}')
                ),
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='é¸ B', data=f'action=potato_game_answer&chosen_option_id=B&uid={user_id}')
                ),
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='é¸ C', data=f'action=potato_game_answer&chosen_option_id=C&uid={user_id}')
                )
            ]
        )
    )
    
    try:
        line_bot_api.reply_message(reply_token, FlexSendMessage(alt_text='é¸å“ªé¡†åœŸè±†ï¼Ÿå°éŠæˆ²', contents=flex_message_content))
    except Exception as e:
        logger.error(f"Error sending potato game question: {e}")
        line_bot_api.reply_message(reply_token, TextSendMessage(text="æŠ±æ­‰ï¼ŒéŠæˆ²è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"))


def handle_potato_game_answer(user_id, reply_token, data_params):
    """
    Handles the user's answer in the "é¸å“ªé¡†åœŸè±†" game.
    """
    global user_game_state
    chosen_option_id = data_params.get('chosen_option_id')

    if user_id not in user_game_state or 'false_potato_original' not in user_game_state[user_id]:
        line_bot_api.reply_message(reply_token, TextSendMessage(text="ç³Ÿç³•ï¼ŒéŠæˆ²ç‹€æ…‹å¥½åƒä¸è¦‹äº†ï¼Œéº»ç…©æ‚¨é‡æ–°é–‹å§‹éŠæˆ²å§ï¼"))
        return

    game_data = user_game_state[user_id]
    false_potato_original_text = game_data['false_potato_original']
    fraud_type_for_explanation = game_data['fraud_type_for_explanation']
    custom_explanation = game_data.get('custom_explanation', '')
    correct_option = game_data.get('correct_option')
    
    chosen_text = ""
    if chosen_option_id == 'A':
        chosen_text = game_data['option_A_text']
    elif chosen_option_id == 'B':
        chosen_text = game_data['option_B_text']
    elif chosen_option_id == 'C':
        chosen_text = game_data['option_C_text']
        line_bot_api.reply_message(reply_token, TextSendMessage(text="é¸æ“‡å‡ºéŒ¯äº†ï¼Œè«‹é‡æ–°ç©ä¸€æ¬¡å“¦ã€‚"))
        return

    reply_messages = []
    
    # ä½¿ç”¨è‡ªè¨‚è§£é‡‹æˆ–å¾é€šç”¨ç‰¹å¾µåº«ç²å–
    if custom_explanation:
        fraud_features = f"âš ï¸ è©é¨™ç‰¹å¾µèªªæ˜ï¼š\n{custom_explanation}"
        fraud_features = get_fraud_features(fraud_type_for_explanation, false_potato_original_text)
    
    explanation_intro = f"é€™å‰‡è¨Šæ¯å±¬æ–¼ã€{fraud_type_for_explanation}ã€‘é¡å‹çš„è©é¨™æ‰‹æ³•ã€‚"
    explanation_detail = f"è©é¨™è¨Šæ¯ï¼š\nã€Œ{false_potato_original_text[:180]}...ã€" 

    # åˆ¤æ–·ç”¨æˆ¶æ˜¯å¦é¸æ“‡äº†æ­£ç¢ºçš„é¸é …
    is_correct = chosen_option_id == correct_option
    
    if is_correct: 
        result_text = f"ğŸ‘ æ­å–œç­”å°äº†ï¼æ‚¨æˆåŠŸè­˜åˆ¥å‡ºè©é¨™è¨Šæ¯ï¼\n\n{explanation_intro}\n\n{explanation_detail}\n\n{fraud_features}\n\nè¨˜ä½ï¼šæé«˜è­¦è¦ºï¼Œä¿è­·è‡ªå·±å’Œè¦ªå‹çš„è³‡ç”¢å®‰å…¨ï¼"
        reply_messages.append(TextSendMessage(text=result_text))
    else: 
        result_text = f"âŒ è¦å°å¿ƒï¼æ‚¨é¸çš„ä¸æ˜¯è©é¨™è¨Šæ¯ã€‚\n\n{explanation_intro}\n\næ­£ç¢ºç­”æ¡ˆæ˜¯é¸é … {correct_option}ï¼š\nã€Œ{false_potato_original_text[:180]}...ã€\n\n{fraud_features}\n\nåˆ¥ç°å¿ƒï¼Œé€éç·´ç¿’æ‚¨æœƒè¶Šä¾†è¶Šæ“…é•·è­˜åˆ¥è©é¨™ï¼"
        reply_messages.append(TextSendMessage(text=result_text))

    quick_reply_items = QuickReply(items=[
        QuickReplyButton(action=PostbackAction(label="å†ç©ä¸€é¡Œ", data=f'action=start_potato_game&uid={user_id}')),
        QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text="è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š")),
        QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text="è©é¨™é¡å‹åˆ—è¡¨"))
    ])
    
    reply_messages.append(TextSendMessage(text="è¦ä¸è¦å†ä¾†ä¸€å±€ï¼Œæˆ–æ˜¯å˜—è©¦å…¶ä»–åŠŸèƒ½ï¼Ÿ", quick_reply=quick_reply_items))
    
    try:
        line_bot_api.reply_message(reply_token, messages=reply_messages)
    except Exception as e:
        logger.error(f"Error sending potato game answer reply: {e}")

def get_fraud_features(fraud_type, fraud_message):
    """
    æ ¹æ“šè©é¨™é¡å‹æä¾›å…¸å‹è©é¨™ç‰¹å¾µèªªæ˜
    """
    common_features = "âš ï¸ è©é¨™å¸¸è¦‹ç‰¹å¾µï¼š\n"
    
    # æ ¹æ“šè©é¨™é¡å‹æ·»åŠ ç‰¹å®šç‰¹å¾µ
    if "è³¼ç‰©" in fraud_type:
        features = [
            "1. è¦æ±‚ç§ä¸‹äº¤æ˜“æˆ–åŒ¯æ¬¾åˆ°ç§äººå¸³æˆ¶",
            "2. æ€¥è‘—æˆäº¤ï¼Œè£½é€ æ€¥è¿«æ„Ÿ",
            "3. åƒ¹æ ¼æ˜é¡¯ä½æ–¼å¸‚å ´è¡Œæƒ…",
            "4. è¦æ±‚ä½¿ç”¨éæ­£è¦æ”¯ä»˜æ–¹å¼",
            "5. è³£å®¶è³‡è¨Šæ¨¡ç³Šä¸æ¸…"
        ]
    elif "æŠ•è³‡" in fraud_type or "ç†è²¡" in fraud_type:
        features = [
            "1. ä¿è­‰ã€Œç©©è³ºä¸è³ ã€ã€ã€Œé«˜å ±é…¬ã€ä½é¢¨éšªã€",
            "2. è²ç¨±æœ‰ã€Œå…§éƒ¨è³‡è¨Šã€æˆ–ã€Œç¨å®¶æŠ•è³‡ç®¡é“ã€",
            "3. è¦æ±‚ä¸‹è¼‰ç‰¹å®šAPPæˆ–åŠ å…¥ç‰¹å®šç¾¤çµ„",
            "4. å‚¬ä¿ƒç«‹å³æŠ•è³‡ï¼Œè²ç¨±ã€Œæ©Ÿæœƒç¨ç¸±å³é€ã€",
            "5. è¦æ±‚å°‡è³‡é‡‘è½‰å…¥ã€ŒæŠ•è³‡å°ˆæˆ¶ã€"
        ]
    elif "äº¤å‹" in fraud_type:
        features = [
            "1. çŸ­æ™‚é–“å…§è¿…é€Ÿç™¼å±•è¦ªå¯†é—œä¿‚",
            "2. è‡ªç¨±é«˜ç¤¾ç¶“åœ°ä½ä½†ç„¡æ³•è¦‹é¢",
            "3. ç·¨é€ å„ç¨®ç†ç”±è«‹æ±‚é‡‘éŒ¢å”åŠ©",
            "4. è²ç¨±æœ‰ç·Šæ€¥é†«ç™‚è²»ç”¨æˆ–æ„å¤–äº‹ä»¶",
            "5. æ‹’çµ•è¦–è¨Šé€šè©±æˆ–è¦‹é¢"
        ]
    elif "æª¢è­¦" in fraud_type or "å…¬å‹™" in fraud_type:
        features = [
            "1. è²ç¨±æ‚¨æ¶‰åŠåˆ‘æ¡ˆæˆ–æ´—éŒ¢",
            "2. è¦æ±‚ç›£ç®¡æ‚¨çš„éŠ€è¡Œå¸³æˆ¶",
            "3. è¦æ±‚æ“ä½œATMæˆ–ç¶²éŠ€",
            "4. è¦æ±‚è³¼è²·é»æ•¸å¡æˆ–ç¦®å“å¡",
            "5. è­¦å‘Šä¸å¾—å‘ä»–äººé€éœ²"
        ]
    elif "ä¸­ç" in fraud_type:
        features = [
            "1. æœªåƒåŠ ä¹Ÿã€Œä¸­çã€",
            "2. è¦æ±‚æ”¯ä»˜æ‰‹çºŒè²»ã€ç¨…é‡‘æ‰èƒ½é ˜ç",
            "3. ä½¿ç”¨æ¨¡ç³Šçš„æ´»å‹•è¾¦æ³•",
            "4. é€šçŸ¥ç®¡é“å¯ç–‘ï¼ˆå¦‚ç°¡è¨Šï¼‰",
            "5. è¦æ±‚æä¾›éŠ€è¡Œå¸³è™Ÿæˆ–å€‹è³‡"
        ]
        # é€šç”¨è©é¨™ç‰¹å¾µ
        features = [
            "1. è£½é€ ç·Šæ€¥æ„Ÿèˆ‡ææ…Œ",
            "2. è¦æ±‚æä¾›æ•æ„Ÿå€‹äººè³‡æ–™",
            "3. æå‡ºä¸åˆç†æˆ–å¯ç–‘çš„è¦æ±‚",
            "4. èªæ³•éŒ¯èª¤æˆ–å¯ç–‘é€£çµ",
            "5. è¦æ±‚è½‰å¸³ã€åŒ¯æ¬¾æˆ–è³¼è²·é»æ•¸"
        ]
    
    return common_features + "\n".join(features)

# --- End: Add these new functions ---

# æ·»åŠ URLåˆ†æçµæœçš„Flex Messageæ ¼å¼å‡½æ•¸
def create_analysis_flex_message(analysis_data, display_name, message_to_analyze, user_id=None):
    """åˆ›å»ºåˆ†æç»“æœçš„Flexæ¶ˆæ¯"""
    try:
        risk_level = analysis_data.get("risk_level", "æœªçŸ¥é¢¨éšª")
        fraud_type = analysis_data.get("fraud_type", "æœªçŸ¥é¡å‹")
        explanation = analysis_data.get("explanation", "")
        suggestions = analysis_data.get("suggestions", "")
    
        # URLç›¸é—œä¿¡æ¯
        original_url = analysis_data.get("original_url")
        expanded_url = analysis_data.get("expanded_url")
        is_short_url = analysis_data.get("is_short_url", False)
        url_expanded_successfully = analysis_data.get("url_expanded_successfully", False)
        
        # è§£æåˆ†æç†ç”±å’Œå»ºè­°ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ŒæŒ‰è¡Œåˆ†å‰²ï¼›å¦‚æœå·²ç¶“æ˜¯åˆ—è¡¨ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
        reasons = []
        if isinstance(explanation, str) and explanation.strip():
            reasons = [explanation.strip()]
        elif isinstance(explanation, list):
            reasons = [r for r in explanation if r and r.strip()]
        
        # ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹é è¨­çš„ç†ç”±
        if not reasons:
            reasons = ["ç³»çµ±ç„¡æ³•æä¾›è©³ç´°åˆ†æç†ç”±ï¼Œè«‹è¬¹æ…åˆ¤æ–·æ­¤å…§å®¹ã€‚"]
            
        suggestion_list = []
        if isinstance(suggestions, str) and suggestions.strip():
            suggestion_list = [suggestions.strip()]
        elif isinstance(suggestions, list):
            suggestion_list = [s for s in suggestions if s and s.strip()]
            
        # ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹é è¨­çš„å»ºè­°
        if not suggestion_list:
            suggestion_list = ["ä¿æŒè­¦æƒ•ï¼Œä¸è¦é»æ“Šå¯ç–‘é€£çµæˆ–æä¾›å€‹äººæ•æ„Ÿè³‡è¨Šã€‚"]
        
        # å®šç¾©ä¸€å€‹ç„¡é™æ¬¡æ•¸çš„æŒ‡ç¤ºå€¼
        remaining_credits = "âˆ"  # ä½¿ç”¨ç„¡é™ç¬¦è™Ÿè¡¨ç¤ºç„¡é™æ¬¡æ•¸
        
        # è¨ˆç®—é¢¨éšªç­‰ç´šé¡è‰²å’Œåœ–ç¤º
        if "ä½é¢¨éšª" in risk_level:
            risk_color = "#27AE60"  # ç¶ è‰²
            risk_emoji = "âœ…"
        elif "ä¸­é¢¨éšª" in risk_level:
            risk_color = "#F39C12"  # æ©™è‰²
            risk_emoji = "âš ï¸"
        else:  # é«˜é¢¨éšª
            risk_color = "#E74C3C"  # ç´…è‰²
            risk_emoji = "ğŸ”´"
        
        # æª¢æŸ¥æ˜¯å¦æ˜¯è´ŠåŠ©éˆæ¥
        is_donation_link = False
        donation_url = ""
        for domain in DONATION_DOMAINS:  # æ”¹ç‚ºåªæª¢æŸ¥è´ŠåŠ©ç¶²ç«™
            if domain in message_to_analyze:
                is_donation_link = True
                
                # æå–å®Œæ•´URLï¼Œç¢ºä¿åŒ…å«https://
                if "http://" in message_to_analyze or "https://" in message_to_analyze:
                    # å˜—è©¦æå–å®Œæ•´URL
                    import re
                    url_match = re.search(r'(https?://[^\s]+)', message_to_analyze)
                    if url_match:
                        donation_url = url_match.group(0)
                    else:
                        donation_url = f"https://{domain}"
                else:
                    donation_url = f"https://{domain}"
                
                # ç¢ºä¿URLé–‹é ­æ˜¯https://
                if not donation_url.startswith("https://"):
                    if donation_url.startswith("http://"):
                        donation_url = "https://" + donation_url[7:]
                    else:
                        donation_url = "https://" + donation_url
                
                logger.info(f"æ‰¾åˆ°è´ŠåŠ©éˆæ¥: {donation_url}")
                break
        
        # æˆªæ–·éé•·çš„åˆ†ææ¶ˆæ¯
        if len(message_to_analyze) > 50:
            short_message = message_to_analyze[:47] + "..."
        else:
            short_message = message_to_analyze
            
        # æ§‹å»ºå…§å®¹å€åŸŸ
        contents = []
        
        # æ·»åŠ é¢¨éšªç­‰ç´š
        contents.append({
            "type": "box",
            "layout": "horizontal",
            "contents": [
                {
                    "type": "text",
                    "text": f"{risk_emoji} é¢¨éšªç­‰ç´š",
                    "size": "md",
                    "color": "#555555",
                    "flex": 0
                },
                {
                    "type": "text",
                    "text": risk_level or "æœªçŸ¥",  # ç¢ºä¿ä¸ç‚ºç©º
                    "size": "md",
                    "color": risk_color,
                    "weight": "bold",
                    "align": "end"
                }
            ]
        })
        
        # æ·»åŠ è©é¨™é¡å‹
        contents.append({
            "type": "box",
            "layout": "horizontal",
            "contents": [
                {
                    "type": "text",
                    "text": "ğŸ” è©é¨™é¡å‹",
                    "size": "md",
                    "color": "#555555",
                    "flex": 0
                },
                {
                    "type": "text",
                    "text": fraud_type or "æœªåˆ†é¡",  # ç¢ºä¿ä¸ç‚ºç©º
                    "size": "md",
                    "color": "#555555",
                    "align": "end"
                }
            ],
            "margin": "md"
        })
        
        # æ·»åŠ åˆ†éš”ç·š
        contents.append({
            "type": "separator",
            "margin": "md"
        })
        
        # é¡¯ç¤ºåˆ†æçš„URLä¿¡æ¯
        if original_url:
            contents.append({
                "type": "text",
                "text": "ğŸŒ æª¢æ¸¬çš„ç¶²å€",
                "weight": "bold",
                "margin": "lg",
                "size": "md",
                "color": "#1DB446"
            })
            
            # é¡¯ç¤ºåŸå§‹URL (å¯èƒ½æ˜¯çŸ­ç¶²å€)
            url_display = original_url
            if len(url_display) > 45:
                url_display = url_display[:42] + "..."
                
            contents.append({
                "type": "text",
                "text": url_display,
                "size": "sm",
                "margin": "md",
                "color": "#333333",
                "wrap": True
            })
            
            # å¦‚æœæ˜¯çŸ­ç¶²å€ä¸”æˆåŠŸå±•é–‹ï¼Œé¡¯ç¤ºå±•é–‹å¾Œçš„URL
            if is_short_url and url_expanded_successfully and expanded_url != original_url:
                contents.append({
                    "type": "text",
                    "text": "ğŸ‘‰ å±•é–‹å¾Œçš„å®Œæ•´ç¶²å€",
                    "weight": "bold",
                    "margin": "md",
                    "size": "sm",
                    "color": "#555555"
                })
                
                expanded_url_display = expanded_url
                if len(expanded_url_display) > 45:
                    expanded_url_display = expanded_url_display[:42] + "..."
                    
                contents.append({
                    "type": "text",
                    "text": expanded_url_display,
                    "size": "sm",
                    "margin": "sm",
                    "color": "#333333",
                    "wrap": True
                })
                
            # å¦‚æœæ˜¯çŸ­ç¶²å€ä½†ç„¡æ³•å±•é–‹ï¼Œé¡¯ç¤ºè­¦å‘Š
            elif is_short_url and not url_expanded_successfully:
                contents.append({
                    "type": "text",
                    "text": "âš ï¸ é€™æ˜¯çŸ­ç¶²å€ï¼Œä½†ç„¡æ³•æŸ¥çœ‹å®ƒæœƒé€£åˆ°å“ªè£¡",
                    "size": "sm",
                    "margin": "md",
                    "color": "#E74C3C",
                    "weight": "bold",
                    "wrap": True
                })
            
            contents.append({
                "type": "separator",
                "margin": "md"
            })
        
        # å¦‚æœæ˜¯è´ŠåŠ©éˆæ¥ï¼Œæ·»åŠ ç‰¹æ®Šæ„Ÿè¬ä¿¡æ¯
        if is_donation_link:
            contents.append({
                "type": "text",
                "text": "ğŸ™ æ„Ÿè¬æ‚¨çš„æ”¯æŒ",
                "weight": "bold",
                "margin": "md",
                "size": "md",
                "color": "#1DB446"
            })
            
            contents.append({
                "type": "text",
                "text": "æ‚¨çš„è´ŠåŠ©å°‡å¹«åŠ©æˆ‘å€‘æä¾›æ›´å„ªè³ªçš„é˜²è©é¨™æœå‹™ï¼ŒæŒçºŒæ”¹é€²AIåˆ†æèƒ½åŠ›ï¼",
                "size": "sm",
                "margin": "md",
                "color": "#333333",
                "wrap": True
            })
            
            # ç¢ºä¿URLæ ¼å¼æ­£ç¢º
            if donation_url:
                logger.info(f"è´ŠåŠ©æŒ‰éˆ•ä½¿ç”¨URL: {donation_url}")
                contents.append({
                    "type": "button",
                    "style": "primary",
                    "action": {
                        "type": "uri",
                        "label": "ç«‹å³è´ŠåŠ©",
                        "uri": donation_url
                    },
                    "margin": "md",
                    "color": "#FF8C00"
                })
            
            contents.append({
                "type": "separator",
                "margin": "md"
            })
            
        # æ·»åŠ åˆ†æç†ç”±æ¨™é¡Œ
        contents.append({
            "type": "text",
            "text": "ğŸ“‹ åˆ†æç†ç”±",
            "weight": "bold",
            "margin": "md",
            "size": "md",
            "color": "#1DB446"
        })
        
        # æ·»åŠ åˆ†æç†ç”± (ç¢ºä¿æ¯å€‹é …ç›®éƒ½ä¸ç‚ºç©º)
        for reason in reasons:
            if reason and reason.strip():  # ç¢ºä¿ç†ç”±ä¸ç‚ºç©º
                contents.append({
                    "type": "text",
                    "text": reason,
                    "size": "sm",
                    "margin": "md",
                    "color": "#333333",
                    "wrap": True
                })
        
        # æ·»åŠ é˜²ç¯„å»ºè­°æ¨™é¡Œ
        contents.append({
            "type": "text",
            "text": "ğŸ›¡ï¸ é˜²ç¯„å»ºè­°",
            "weight": "bold",
            "margin": "md",
            "size": "md",
            "color": "#1DB446"
        })
        
        # æ·»åŠ é˜²ç¯„å»ºè­° (ç¢ºä¿æ¯å€‹é …ç›®éƒ½ä¸ç‚ºç©º)
        for suggestion in suggestion_list:
            if suggestion and suggestion.strip():  # ç¢ºä¿å»ºè­°ä¸ç‚ºç©º
                contents.append({
                    "type": "text",
                    "text": suggestion,
                    "size": "sm",
                    "margin": "md",
                    "color": "#666666",
                    "wrap": True
                })
        
        # æ·»åŠ å›ºå®šçš„æç¤ºæ–‡å­—
        contents.append({
            "type": "box",
            "layout": "vertical",
            "margin": "lg",
            "contents": [
                {
                    "type": "separator",
                    "color": "#DDDDDD",
                    "margin": "md"
                },
                {
                    "type": "text",
                    "text": "âš ï¸å¦‚æœ‰ä»»ä½•ç–‘æ…®ï¼Œè«‹ç›´æ¥æ’¥æ‰“165åè©é¨™å°ˆç·š",
                    "wrap": True,
                    "size": "xs",
                    "margin": "md",
                    "color": "#999999"
                },
                {
                    "type": "text",
                    "text": "æœ¬ç³»çµ±åƒ…é‡å°å…§å®¹åšåˆæ­¥åˆ†æï¼Œè«‹è‡ªè¡Œè©•ä¼°çµæœ",
                    "wrap": True,
                    "size": "xs",
                    "margin": "sm",
                    "color": "#999999"
                }
            ]
        })
        
        # å¦‚æœæœ‰æ–°å‹è©é¨™ç‰¹å¾ï¼Œæ·»åŠ æ ‡è®°
        if "is_emerging" in analysis_data and analysis_data["is_emerging"]:
            contents.append({
                "type": "text",
                "text": "ğŸ†• å¯èƒ½æ˜¯æ–°å‹è©é¨™æ‰‹æ³•",
                "size": "sm",
                "margin": "md",
                "color": "#ffffff",
                "background": "#FF0000"
            })
        
        # é©—è­‰æ‰€æœ‰textå­—æ®µæ˜¯å¦æœ‰å…§å®¹
        for i, content in enumerate(contents):
            if content.get("type") == "text" and (not content.get("text") or content.get("text").strip() == ""):
                logger.warning(f"æª¢æ¸¬åˆ°ç¬¬{i}å€‹å…ƒç´ çš„textå­—æ®µç‚ºç©ºï¼Œè¨­ç½®ç‚ºé è¨­å€¼")
                content["text"] = "ç„¡ç›¸é—œå…§å®¹"  # è¨­ç½®é è¨­å€¼
            elif content.get("type") == "box" and "contents" in content:
                for j, sub_content in enumerate(content["contents"]):
                    if sub_content.get("type") == "text" and (not sub_content.get("text") or sub_content.get("text").strip() == ""):
                        logger.warning(f"æª¢æ¸¬åˆ°ç¬¬{i}å€‹boxçš„ç¬¬{j}å€‹å…ƒç´ çš„textå­—æ®µç‚ºç©ºï¼Œè¨­ç½®ç‚ºé è¨­å€¼")
                        sub_content["text"] = "ç„¡ç›¸é—œå…§å®¹"  # è¨­ç½®é è¨­å€¼
            # æª¢æŸ¥å…¶ä»–å¯èƒ½æœ‰URIçš„éƒ¨åˆ†
            elif content.get("type") == "button" and "action" in content:
                action = content["action"]
                if action.get("type") == "uri" and "uri" in action:
                    uri = action["uri"]
                    # ç¢ºä¿URIåŒ…å«https://
                    if not uri.startswith("https://"):
                        logger.warning(f"æª¢æ¸¬åˆ°URIä¸ç¬¦åˆè¦ç¯„: {uri}ï¼Œä¿®æ­£ç‚ºhttps://")
                        if uri.startswith("http://"):
                            action["uri"] = "https://" + uri[7:]
                        else:
                            action["uri"] = "https://" + uri
        
        # åˆ›å»ºFlexSendMessage
        flex_message = FlexSendMessage(
            alt_text=f"è©é¨™é¢¨éšªåˆ†æï¼š{risk_level}",
            contents={
                "type": "bubble",
                "size": "mega",
                "header": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": f"{risk_emoji} è©é¨™é¢¨éšªï¼š{risk_level}",
                                    "color": "#ffffff",
                                    "weight": "bold",
                                    "size": "xl"
                                }
                            ]
                        }
                    ],
                    "backgroundColor": risk_color,
                    "paddingAll": "20px"
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": contents,
                    "paddingAll": "20px"
                }
            }
        )
        
        return flex_message
    except Exception as e:
        logger.error(f"Error creating analysis flex message: {e}")
        # è¿”å›ä¸€å€‹ç°¡å–®çš„æ–‡æœ¬æ¶ˆæ¯ä½œç‚ºå‚™ç”¨
        return TextSendMessage(text=f"åˆ†æçµæœï¼š{risk_level}\n\nè©é¨™é¡å‹ï¼š{fraud_type}\n\n{explanation}\n\nè«‹æ³¨æ„é¢¨éšªï¼Œå¦‚æœ‰ç–‘æ…®è«‹æ’¥æ‰“165åè©é¨™å°ˆç·šã€‚")

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
        
    return 'OK'

@app.route("/", methods=['GET'])
def home():
    return "Line Bot Anti-Fraud is running!"

@app.route("/fraud-statistics", methods=['GET'])
def fraud_statistics():
    """é¡¯ç¤ºè©é¨™çµ±è¨ˆæ•¸æ“šé é¢"""
    stats = firebase_manager.get_fraud_statistics()
    return render_template('statistics.html', stats=stats)

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    profile = get_user_profile(user_id)
    display_name = profile.display_name if profile else "æœªçŸ¥ç”¨æˆ¶"
    text_message = event.message.text
    reply_token = event.reply_token
    current_time = datetime.datetime.now()

    logger.info(f"Received message from {display_name} ({user_id}): {text_message}")

    # æª¢æŸ¥æ˜¯å¦ç‚ºç¾¤çµ„è¨Šæ¯
    is_group_message = False
    group_id = None
    if hasattr(event.source, "type") and event.source.type in ["group", "room"]:
        is_group_message = True
        group_id = event.source.group_id if event.source.type == "group" else event.source.room_id
        logger.info(f"é€™æ˜¯ä¸€å‰‡ç¾¤çµ„è¨Šæ¯ (é¡å‹: {event.source.type}, ID: {group_id})")
        
    # æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
    current_state = user_conversation_state.get(user_id, {})
    current_state["last_time"] = current_time
    
    # æª¢æŸ¥æ˜¯å¦åŒ…å«è§¸ç™¼é—œéµè© "å—¨åœŸè±†"æˆ–è€…ç”¨æˆ¶è™•æ–¼ç­‰å¾…åˆ†æç‹€æ…‹
    waiting_for_analysis = current_state.get("waiting_for_analysis", False)
    
    # å¦‚æœæ˜¯ç¾¤çµ„è¨Šæ¯ï¼Œéœ€è¦æª¢æŸ¥æ˜¯å¦åŒ…å«è§¸ç™¼é—œéµè©ï¼Œæˆ–è€…ç”¨æˆ¶è™•æ–¼ç­‰å¾…åˆ†æç‹€æ…‹
    if is_group_message and bot_trigger_keyword not in text_message and not waiting_for_analysis:
        logger.info(f"ç¾¤çµ„è¨Šæ¯ä¸åŒ…å«è§¸ç™¼é—œéµè© '{bot_trigger_keyword}'ï¼Œä¹Ÿä¸åœ¨ç­‰å¾…åˆ†æç‹€æ…‹ï¼Œå¿½ç•¥æ­¤è¨Šæ¯")
        return

    # å¦‚æœæ˜¯ç¾¤çµ„è¨Šæ¯ä¸”åŒ…å«è§¸ç™¼é—œéµè©ï¼Œç§»é™¤é—œéµè©ä»¥è™•ç†å¯¦éš›å‘½ä»¤
    if is_group_message and bot_trigger_keyword in text_message:
        text_message = text_message.replace(bot_trigger_keyword, "").strip()
        logger.info(f"ç§»é™¤è§¸ç™¼é—œéµè©å¾Œçš„è¨Šæ¯: {text_message}")
    
    # å¦‚æœä¸Šä¸€æ¬¡çš„äº’å‹•æ˜¯è«‹æ±‚åˆ†æï¼Œå‰‡è¨­ç½®ç­‰å¾…åˆ†æç‹€æ…‹
    if any(text_message.strip() == prompt or text_message.strip() == prompt.rstrip("ï¼š") for prompt in analysis_prompts):
        current_state["waiting_for_analysis"] = True
        user_conversation_state[user_id] = current_state
        logger.info(f"ç”¨æˆ¶ {user_id} é€²å…¥ç­‰å¾…åˆ†æç‹€æ…‹")
    elif any(pattern in text_message.lower() for pattern in follow_up_patterns):
        current_state["waiting_for_analysis"] = True
        user_conversation_state[user_id] = current_state
        logger.info(f"ç”¨æˆ¶ {user_id} å¯èƒ½é‡åˆ°è©é¨™ï¼Œé€²å…¥ç­‰å¾…åˆ†æç‹€æ…‹")
    elif contains_url(text_message) and waiting_for_analysis:
        # å¦‚æœæ¶ˆæ¯åŒ…å«URLä¸”ç”¨æˆ¶è™•æ–¼ç­‰å¾…åˆ†æç‹€æ…‹ï¼Œä¿æŒç­‰å¾…åˆ†æç‹€æ…‹
        current_state["waiting_for_analysis"] = True
        user_conversation_state[user_id] = current_state
        logger.info(f"ç”¨æˆ¶ {user_id} æä¾›äº†URLï¼Œä¿æŒç­‰å¾…åˆ†æç‹€æ…‹")
    elif waiting_for_analysis and should_perform_fraud_analysis(text_message):
        # ç”¨æˆ¶è™•æ–¼ç­‰å¾…åˆ†æç‹€æ…‹ä¸”é€™å€‹æ¶ˆæ¯çœ‹èµ·ä¾†æ˜¯éœ€è¦åˆ†æçš„å…§å®¹
        current_state["waiting_for_analysis"] = False  # åˆ†æå®Œå¾Œé‡ç½®ç‹€æ…‹
        user_conversation_state[user_id] = current_state
        logger.info(f"ç”¨æˆ¶ {user_id} åœ¨ç­‰å¾…åˆ†æç‹€æ…‹ä¸‹ç™¼é€äº†éœ€è¦åˆ†æçš„å…§å®¹")
        # å…¶ä»–æƒ…æ³ï¼Œé‡ç½®ç­‰å¾…åˆ†æç‹€æ…‹
        current_state["waiting_for_analysis"] = False
        user_conversation_state[user_id] = current_state
    
    # å¦‚æœç§»é™¤é—œéµè©å¾Œè¨Šæ¯ç‚ºç©ºï¼Œå‰‡ç™¼é€åŠŸèƒ½èªªæ˜
    if not text_message:
        reply_text = f"æ‚¨å¥½ï¼æˆ‘æ˜¯é˜²è©é¨™å°å¹«æ‰‹ï¼Œæˆ‘çš„åŠŸèƒ½åŒ…æ‹¬ï¼š\n\n" \
                        f"1ï¸âƒ£ è©é¨™é¢¨éšªåˆ†æï¼šæˆ‘å¯ä»¥åˆ†ææ‚¨æ”¶åˆ°çš„å¯ç–‘è¨Šæ¯ï¼Œè©•ä¼°æ˜¯å¦ç‚ºè©é¨™\n\n" \
                        f"2ï¸âƒ£ è©é¨™é¡å‹æŸ¥è©¢ï¼šæ‚¨å¯ä»¥è¼¸å…¥ã€Œè©é¨™é¡å‹åˆ—è¡¨ã€æŸ¥çœ‹å„ç¨®å¸¸è¦‹è©é¨™\n\n" \
                        f"3ï¸âƒ£ ã€Œé¸å“ªé¡†åœŸè±†ã€å°éŠæˆ²ï¼šé€šééŠæˆ²å­¸ç¿’è¾¨è­˜è©é¨™è¨Šæ¯\n\n" \
                        f"è«‹é¸æ“‡æ‚¨æƒ³å˜—è©¦çš„åŠŸèƒ½ï¼š"
            
        # å¦‚æœåœ¨ç¾¤çµ„ä¸­ï¼ŒQuickReplyæŒ‰éˆ•éœ€è¦åŒ…å«è§¸ç™¼é—œéµè©
        if is_group_message:
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text=f"{bot_trigger_keyword} è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text=f"{bot_trigger_keyword} é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text=f"{bot_trigger_keyword} è©é¨™é¡å‹åˆ—è¡¨"))
            ])
            # åœ¨ç¾¤çµ„ä¸­ä½¿ç”¨mentionåŠŸèƒ½
            mention_message = create_mention_message(reply_text, display_name, user_id, quick_reply)
            line_bot_api.reply_message(reply_token, mention_message)
        else:
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text="è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text="é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text="è©é¨™é¡å‹åˆ—è¡¨"))
            ])
            line_bot_api.reply_message(reply_token, TextSendMessage(text=reply_text, quick_reply=quick_reply))
        
        firebase_manager.save_user_interaction(user_id, display_name, text_message, "å›è¦†åŠŸèƒ½èªªæ˜", is_fraud_related=False)
        return

    # è™•ç†ã€Œé¸å“ªé¡†åœŸè±†ã€éŠæˆ²è§¸ç™¼
    if any(keyword in text_message.lower() for keyword in potato_game_trigger_keywords):
        logger.info(f"User {user_id} triggered potato game.")
        firebase_manager.save_user_interaction(
            user_id, display_name, text_message, 
            "å•Ÿå‹•ã€Œé¸å“ªé¡†åœŸè±†ã€éŠæˆ²", is_fraud_related=False
        )
        send_potato_game_question(user_id, reply_token)
        return

    # è™•ç†è©é¨™é¡å‹åˆ—è¡¨æŸ¥è©¢
    if text_message.lower() == "è©é¨™é¡å‹åˆ—è¡¨" or text_message.lower() == "è©é¨™é¡å‹":
        logger.info(f"User {user_id} is querying fraud types list")
        types_text = "ç›®å‰å·²æ”¶é›†çš„è©é¨™é¡å‹æœ‰ï¼š\n"
        for f_type, info in fraud_types.items():
            types_text += f"\nâš ï¸ {f_type}ï¼š\n{info['description']}\n"
        
        types_text += "\næƒ³äº†è§£ç‰¹å®šé¡å‹ï¼Œå¯ä»¥å•æˆ‘ã€Œä»€éº¼æ˜¯[è©é¨™é¡å‹]ã€å–”ï¼"

        quick_reply_items = []
        for f_type in list(fraud_types.keys())[:4]:  # åªå–å‰4å€‹è©é¨™é¡å‹ä½œç‚ºå¿«é€Ÿå›è¦†
            if is_group_message:
                quick_reply_items.append(QuickReplyButton(action=MessageAction(label=f_type, text=f"{bot_trigger_keyword} ä»€éº¼æ˜¯{f_type}")))
            else:
                quick_reply_items.append(QuickReplyButton(action=MessageAction(label=f_type, text=f"ä»€éº¼æ˜¯{f_type}")))

        # åœ¨ç¾¤çµ„ä¸­å›è¦†æ™‚å‰ç¶´ç”¨æˆ¶åç¨±
        if is_group_message:
            mention_message = create_mention_message(types_text, display_name, user_id, 
                QuickReply(items=quick_reply_items) if quick_reply_items else None)
            line_bot_api.reply_message(reply_token, mention_message)
        else:
            line_bot_api.reply_message(reply_token, TextSendMessage(text=types_text, 
                quick_reply=QuickReply(items=quick_reply_items) if quick_reply_items else None))
        
        firebase_manager.save_user_interaction(user_id, display_name, text_message, "Provided list of fraud types", is_fraud_related=False)
        return
        
    # è™•ç†ç‰¹å®šè©é¨™é¡å‹è³‡è¨ŠæŸ¥è©¢ (ä¾‹å¦‚ "ä»€éº¼æ˜¯ç¶²è·¯è³¼ç‰©è©é¨™")
    specific_type_query_match = re.match(r"^(ä»€éº¼æ˜¯|æŸ¥è©¢|æˆ‘æƒ³äº†è§£|æˆ‘æƒ³çŸ¥é“)(.+è©é¨™)$", text_message.strip())
    if specific_type_query_match:
        query_type = specific_type_query_match.group(2).strip()
        logger.info(f"User {user_id} is querying about specific fraud type: {query_type}")
        
        matched_fraud_type = None
        for f_type, info in fraud_types.items():
            if query_type in f_type or f_type in query_type:
                matched_fraud_type = f_type
                break
        
        if matched_fraud_type:
            info = fraud_types[matched_fraud_type]
            response_text = f"âš ï¸ {matched_fraud_type} âš ï¸\n\n{info['description']}\n\n"
            
            if info.get('examples') and len(info['examples']) > 0:
                response_text += "ğŸ“‹ æ¡ˆä¾‹ï¼š\n" + info['examples'][0] + "\n\n"
            
            if info.get('sop') and len(info['sop']) > 0:
                response_text += "ğŸ›¡ï¸ é˜²ç¯„æ–¹æ³•ï¼š\n" + "\n".join(info['sop'][:5]) + "\n"
            
            if is_group_message:
                mention_message = create_mention_message(response_text, display_name, user_id, 
                    QuickReply(items=[
                        QuickReplyButton(action=MessageAction(label="æŸ¥çœ‹å…¶ä»–è©é¨™é¡å‹", text=f"{bot_trigger_keyword} è©é¨™é¡å‹åˆ—è¡¨")),
                        QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text=f"{bot_trigger_keyword} é¸å“ªé¡†åœŸè±†")),
                        QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text=f"{bot_trigger_keyword} è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š"))
                    ])
                )
                line_bot_api.reply_message(reply_token, mention_message)
            else:
                line_bot_api.reply_message(reply_token, TextSendMessage(text=response_text, 
                    quick_reply=QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="æŸ¥çœ‹å…¶ä»–è©é¨™é¡å‹", text="è©é¨™é¡å‹åˆ—è¡¨")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text="é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text="è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š"))
                    ])))
            
            firebase_manager.save_user_interaction(user_id, display_name, text_message, f"Provided info about {matched_fraud_type}", is_fraud_related=False)
            return
        else:
            # æœªæ‰¾åˆ°åŒ¹é…çš„è©é¨™é¡å‹ï¼Œçµ¦å‡ºä¸€èˆ¬æ€§å›è¦†
            response_text = f"æŠ±æ­‰ï¼Œæˆ‘ç›®å‰æ²’æœ‰é—œæ–¼ã€Œ{query_type}ã€çš„è©³ç´°è³‡è¨Šã€‚\n\nä»¥ä¸‹æ˜¯æˆ‘å·²æ”¶é›†çš„è©é¨™é¡å‹ï¼Œæ‚¨å¯ä»¥æŸ¥è©¢é€™äº›ï¼š"
            for f_type in fraud_types.keys():
                response_text += f"\n- {f_type}"
            
            if is_group_message:
                mention_message = create_mention_message(response_text, display_name, user_id, 
                    QuickReply(items=[
                        QuickReplyButton(action=MessageAction(label="æŸ¥çœ‹è©é¨™é¡å‹åˆ—è¡¨", text=f"{bot_trigger_keyword} è©é¨™é¡å‹åˆ—è¡¨")),
                        QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text=f"{bot_trigger_keyword} é¸å“ªé¡†åœŸè±†"))
                    ])
                )
                line_bot_api.reply_message(reply_token, mention_message)
            else:
                line_bot_api.reply_message(reply_token, TextSendMessage(text=response_text, 
                    quick_reply=QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="æŸ¥çœ‹è©é¨™é¡å‹åˆ—è¡¨", text="è©é¨™é¡å‹åˆ—è¡¨")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text="é¸å“ªé¡†åœŸè±†"))
                    ])))
            
            firebase_manager.save_user_interaction(user_id, display_name, text_message, "Responded to unknown fraud type query", is_fraud_related=False)
            return

    # æª¢æŸ¥æ˜¯å¦ç‚ºè«‹æ±‚åˆ†æçš„æç¤ºèª
    if any(text_message.strip() == prompt or text_message.strip() == prompt.rstrip("ï¼š") for prompt in analysis_prompts):
        logger.info(f"User {user_id} requested message analysis but didn't provide message content")
        
        # ä½¿ç”¨éš¨æ©Ÿå›è¦†ï¼Œè®“æ©Ÿå™¨äººå›æ‡‰æ›´åŠ å¤šæ¨£åŒ–
        prompt_replies = [
            f"{display_name}ï¼Œæ‚¨å¥½ï¼è«‹å°‡å¯ç–‘çš„è¨Šæ¯æˆ–ç¶²å€è²¼çµ¦æˆ‘ï¼Œæˆ‘æœƒé¦¬ä¸Šåˆ†ææ˜¯å¦æœ‰è©é¨™é¢¨éšªã€‚å¯ä»¥æ˜¯é™Œç”Ÿäººå‚³ä¾†çš„é€£çµã€å¯ç–‘çš„è³¼ç‰©ç¶²ç«™ï¼Œæˆ–ä»»ä½•è®“æ‚¨ä¸å®‰çš„è¨Šæ¯ã€‚",
            f"å¥½çš„ï¼Œ{display_name}ï¼æƒ³çŸ¥é“æŸå€‹ç¶²å€æˆ–è¨Šæ¯æ˜¯å¦å®‰å…¨ï¼Ÿè«‹ç›´æ¥è²¼ä¸Šä¾†ï¼Œæˆ‘æœƒç«‹åˆ»ç‚ºæ‚¨æª¢æŸ¥é¢¨éšªã€‚ç„¡è«–æ˜¯ç¤¾ç¾¤åª’é«”é€£çµã€è³¼ç‰©ç¶²ç«™é‚„æ˜¯å¥‡æ€ªçš„è¨Šæ¯éƒ½å¯ä»¥ã€‚",
            f"æ²’å•é¡Œï¼Œ{display_name}ï¼è¦åˆ†æä»€éº¼è¨Šæ¯æˆ–ç¶²å€å‘¢ï¼Ÿè«‹å®Œæ•´è¤‡è£½è²¼ä¸Šæ‚¨æƒ³æŸ¥è­‰çš„å…§å®¹ï¼Œåƒæ˜¯é™Œç”Ÿä¾†é›»è¦æ±‚çš„æ“ä½œã€å¯ç–‘ç¶²å€æˆ–ç¤¾ç¾¤åª’é«”è¨Šæ¯éƒ½å¯ä»¥ã€‚",
            f"æ”¶åˆ°ï¼{display_name}ï¼Œè«‹ç›´æ¥å°‡æ‚¨æ‡·ç–‘çš„è¨Šæ¯æˆ–ç¶²å€è¤‡è£½çµ¦æˆ‘ï¼Œç‰¹åˆ¥æ˜¯å«æœ‰é€£çµã€è¦æ±‚å€‹äººè³‡æ–™æˆ–æåˆ°éŒ¢çš„è¨Šæ¯ï¼Œæˆ‘æœƒç«‹åˆ»å¹«æ‚¨è¾¨è­˜é¢¨éšªã€‚"
        ]
        
        selected_reply = random.choice(prompt_replies)
        
        if is_group_message:
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text=f"{bot_trigger_keyword} é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text=f"{bot_trigger_keyword} è©é¨™é¡å‹åˆ—è¡¨"))
            ])
            # åœ¨ç¾¤çµ„ä¸­ä½¿ç”¨mentionåŠŸèƒ½
            mention_message = create_mention_message(selected_reply, display_name, user_id, quick_reply)
            line_bot_api.reply_message(reply_token, mention_message)
        else:
            quick_reply = QuickReply(items=[
            QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text="é¸å“ªé¡†åœŸè±†")),
            QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text="è©é¨™é¡å‹åˆ—è¡¨"))
        ])
        line_bot_api.reply_message(reply_token, TextSendMessage(text=selected_reply, quick_reply=quick_reply))
        
        firebase_manager.save_user_interaction(user_id, display_name, text_message, "Responded to analysis request prompt", is_fraud_related=False)
        return

    # é è¨­ä½¿ç”¨ChatGPTé€²è¡Œé–’èŠå›æ‡‰æˆ–è©é¨™åˆ†æ
    logger.info(f"Message from {user_id}: {text_message} - Determining if fraud analysis is needed")
    
    # åˆå§‹åŒ–è®Šé‡
    reply_text = ""
    is_fraud_related = False
    
    # åˆ¤æ–·æ˜¯å¦éœ€è¦é€²è¡Œè©é¨™åˆ†æ
    if should_perform_fraud_analysis(text_message):
        logger.info(f"Performing fraud analysis for message from {user_id}: {text_message}")
        # ä½¿ç”¨ç¾æœ‰çš„è©é¨™åˆ†æé‚è¼¯ï¼Œå‚³å…¥user_id
        analysis_result = detect_fraud_with_chatgpt(text_message, display_name, user_id)
        
        if analysis_result and analysis_result.get("success", False):
            analysis_data = analysis_result.get("result", {})
            raw_result = analysis_result.get("raw_result", "")

            risk_level = analysis_data.get("risk_level", "ä¸ç¢ºå®š")
            fraud_type = analysis_data.get("fraud_type", "æœªçŸ¥")
            explanation = analysis_data.get("explanation", "åˆ†æçµæœä¸å®Œæ•´ï¼Œè«‹è¬¹æ…åˆ¤æ–·ã€‚")
            suggestions = analysis_data.get("suggestions", "è«‹éš¨æ™‚ä¿æŒè­¦æƒ•ã€‚")
            is_emerging = analysis_data.get("is_emerging", False)

            flex_message = create_analysis_flex_message(analysis_data, display_name, text_message, user_id)
            
            # åœ¨ç¾¤çµ„ä¸­å¢åŠ å‰ç¶´æåŠç”¨æˆ¶
            if is_group_message and flex_message and isinstance(flex_message, FlexSendMessage):
                # ä½¿ç”¨å®˜æ–¹çš„mentionåŠŸèƒ½ç™¼é€å‰ç¶´é€šçŸ¥
                mention_message = create_mention_message("ä»¥ä¸‹æ˜¯æ‚¨è¦æ±‚çš„è©é¨™é¢¨éšªåˆ†æï¼š", display_name, user_id)
                line_bot_api.push_message(group_id if group_id else user_id, mention_message)
                
            # ç™¼é€Flexæ¶ˆæ¯
            if flex_message:
                line_bot_api.reply_message(reply_token, flex_message)
            else:
                # å¦‚æœFlexæ¶ˆæ¯å‰µå»ºå¤±æ•—ï¼Œç™¼é€åŸºæœ¬æ–‡æœ¬æ¶ˆæ¯
                text_response = f"é¢¨éšªç­‰ç´šï¼š{risk_level}\nè©é¨™é¡å‹ï¼š{fraud_type}\n\nåˆ†æï¼š{explanation}\n\nå»ºè­°ï¼š{suggestions}"
                if is_group_message:
                    mention_message = create_mention_message(text_response, display_name, user_id)
                    line_bot_api.reply_message(reply_token, mention_message)
                else:
                    line_bot_api.reply_message(reply_token, TextSendMessage(text=text_response))

            if is_emerging and fraud_type != "éè©é¨™ç›¸é—œ":
                # æ–°å¢è©é¨™æ‰‹æ³•è¨˜éŒ„é€šçŸ¥æ”¹ç‚ºå–®ç¨æ¨é€ï¼Œé¿å…æ··æ·†Flex Message
                emerging_text = "âš ï¸ é€™å¯èƒ½æ˜¯ä¸€ç¨®æ–°çš„è©é¨™æ‰‹æ³•ï¼Œæˆ‘å·²ç¶“è¨˜éŒ„ä¸‹ä¾†äº†ï¼Œè¬è¬æ‚¨çš„è³‡è¨Šï¼"
                if is_group_message:
                    mention_message = create_mention_message(emerging_text, display_name, user_id)
                    line_bot_api.push_message(group_id if group_id else user_id, mention_message)
                else:
                    line_bot_api.push_message(user_id, TextSendMessage(text=emerging_text))
                firebase_manager.save_emerging_fraud_report(user_id, display_name, text_message, raw_result)
                
            is_fraud_related = True if fraud_type != "éè©é¨™ç›¸é—œ" and risk_level not in ["ç„¡é¢¨éšª", "ä½"] else False
                
            # ä¿å­˜äº’å‹•è¨˜éŒ„åˆ°Firebase
            firebase_manager.save_user_interaction(
                user_id, display_name, text_message, raw_result,
                is_fraud_related=is_fraud_related,
                fraud_type=fraud_type if is_fraud_related else None,
                risk_level=risk_level if is_fraud_related else None
            )
                
            # ä»¥15%çš„æ©Ÿç‡é¡¯ç¤ºè´ŠåŠ©ä¿¡æ¯
            if random.random() < 0.15:
                logger.info(f"éš¨æ©Ÿè§¸ç™¼è´ŠåŠ©ä¿¡æ¯é¡¯ç¤ºçµ¦ç”¨æˆ¶ {user_id}")
                try:
                    # å»¶é²1ç§’ç™¼é€ï¼Œé¿å…è¨Šæ¯å †ç–Š
                    time.sleep(1)
                    donation_message = create_donation_flex_message()
                    # ä½¿ç”¨push_messageè€Œä¸æ˜¯reply_message
                    line_bot_api.push_message(group_id if is_group_message else user_id, donation_message)
                except Exception as e:
                    logger.error(f"ç™¼é€è´ŠåŠ©è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        else:
            # åˆ†æå¤±æ•—çš„æƒ…æ³ï¼Œç™¼é€éŒ¯èª¤æ¶ˆæ¯
            error_message = analysis_result.get("message", "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦") if analysis_result else "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"
            if is_group_message:
                mention_message = create_mention_message(error_message, display_name, user_id)
                line_bot_api.reply_message(reply_token, mention_message)
            else:
                line_bot_api.reply_message(reply_token, TextSendMessage(text=error_message))
            
        return
    else:
        # ä½¿ç”¨ChatGPTé€²è¡Œé–’èŠå›æ‡‰
        logger.info(f"Using chat response for message from {user_id}: {text_message}")
        
        try:
            # ç²å–ç”¨æˆ¶æœ€è¿‘çš„å°è©±æ­·å²
            recent_history = firebase_manager.get_recent_interactions(user_id, limit=5)
            
            # æº–å‚™å°è©±æ­·å²æ¶ˆæ¯åˆ—è¡¨
            chat_history = []
            
            # ç³»çµ±æç¤ºæ¶ˆæ¯
            system_message = {
                "role": "system", 
                "content": "ä½ æ˜¯ä¸€ä½åç‚ºã€ŒåœŸè±†ã€çš„AIèŠå¤©æ©Ÿå™¨äººï¼Œä½ çš„é¢¨æ ¼å‹å–„ã€æº«æš–ä¸”è²¼å¿ƒã€‚ä½ éœ€è¦æ ¹æ“šä¹‹å‰çš„å°è©±æ­·å²ä¾†å›æ‡‰ç”¨æˆ¶ï¼Œæä¾›é€£è²«ä¸”è‡ªç„¶çš„å°è©±é«”é©—ã€‚ä½ æ˜¯é˜²è©é¨™å°ˆå®¶ï¼Œç•¶ç”¨æˆ¶è¨è«–å¯ç–‘è¨Šæ¯æ™‚ï¼Œè¦ä¿æŒè­¦è¦ºã€‚"
            }
            
            # å¦‚æœæˆåŠŸç²å–åˆ°æ­·å²å°è©±ï¼Œå‰‡ä½¿ç”¨å®ƒå€‘
            if recent_history:
                # å°‡æ­·å²å°è©±è½‰æ›ç‚ºChatGPTæ ¼å¼
                for interaction in recent_history:
                    # ç”¨æˆ¶æ¶ˆæ¯
                    if 'message' in interaction and interaction['message']:
                        chat_history.append({
                            "role": "user",
                            "content": interaction['message']
                        })
                    
                    # æ©Ÿå™¨äººå›æ‡‰
                    if 'response' in interaction and interaction['response']:
                        chat_history.append({
                            "role": "assistant",
                            "content": interaction['response']
                        })
                
                logger.info(f"æˆåŠŸä½¿ç”¨ç”¨æˆ¶æ­·å²å°è©±: {len(chat_history)} æ¢æ¶ˆæ¯")
            else:
                # å¦‚æœæ²’æœ‰æ­·å²å°è©±æˆ–ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨ç©ºçš„æ­·å²
                logger.info("ç„¡æ³•ç²å–ç”¨æˆ¶æ­·å²å°è©±ï¼Œä½¿ç”¨ç©ºæ­·å²")
            
            # æ·»åŠ ç•¶å‰ç”¨æˆ¶æ¶ˆæ¯
            current_user_message = {
                "role": "user",
                "content": text_message
            }
            
            # æ§‹å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨
            messages = [system_message] + chat_history + [current_user_message]
            
            # é™åˆ¶æ¶ˆæ¯æ•¸é‡ï¼Œé¿å…è¶…å‡ºAPIé™åˆ¶
            if len(messages) > 10:
                # ä¿ç•™ç³»çµ±æ¶ˆæ¯å’Œæœ€è¿‘çš„å°è©±
                messages = [system_message] + messages[-9:]
            
            logger.info(f"ä½¿ç”¨è¨˜æ†¶åŠŸèƒ½ï¼Œç¸½å…±æä¾› {len(messages)} æ¢æ¶ˆæ¯çµ¦ChatGPT")
            
            # ä½¿ç”¨æ›´æ–°å¾Œçš„OpenAI APIæ ¼å¼
            chat_response = openai.chat.completions.create(
                model=os.environ.get('OPENAI_MODEL', 'gpt-3.5-turbo'),
                messages=messages,
                temperature=0.7,
                max_tokens=200
            )
            
            chat_reply = chat_response.choices[0].message.content.strip()
            
            # åªåœ¨é¦–æ¬¡èŠå¤©æ™‚æ·»åŠ åŠŸèƒ½ä»‹ç´¹
            is_first_time = user_id not in first_time_chatters
            if is_first_time:
                first_time_chatters.add(user_id)
                introduction = f"\n\næˆ‘æ˜¯é˜²è©é¨™æ©Ÿå™¨äººã€ŒåœŸè±†ã€ï¼Œèƒ½å¹«æ‚¨ï¼š\n1ï¸âƒ£ åˆ†æå¯ç–‘è¨Šæ¯\n2ï¸âƒ£ æ¸¬è©¦æ‚¨çš„é˜²è©é¨™èƒ½åŠ›\n3ï¸âƒ£ æŸ¥è©¢å„é¡è©é¨™æ‰‹æ³•"
                reply_text = chat_reply + introduction
            else:
                reply_text = chat_reply
            
        except Exception as e:
            logger.error(f"é–’èŠå›æ‡‰éŒ¯èª¤: {e}")
            # å¦‚æœé–’èŠå›æ‡‰å¤±æ•—ï¼Œä½¿ç”¨ç°¡å–®çš„å•å€™
            greetings = ["æ‚¨å¥½ï¼", "å—¨ï¼", "å“ˆå›‰ï¼", "å¾ˆé«˜èˆˆè¦‹åˆ°æ‚¨ï¼", "æ‚¨å¥½å‘€ï¼"]
            
            # åªåœ¨é¦–æ¬¡èŠå¤©æ™‚æ·»åŠ åŠŸèƒ½ä»‹ç´¹
            is_first_time = user_id not in first_time_chatters
            if is_first_time:
                first_time_chatters.add(user_id)
                reply_text = f"{random.choice(greetings)}æœ‰ä»€éº¼æˆ‘èƒ½å¹«æ‚¨çš„å—ï¼Ÿæ‚¨å¯ä»¥è¼¸å…¥ã€ŒåŠŸèƒ½ã€ä¾†äº†è§£æˆ‘èƒ½åšä»€éº¼ã€‚"
            else:
                reply_text = f"{random.choice(greetings)}æœ‰ä»€éº¼æˆ‘èƒ½å¹«æ‚¨çš„å—ï¼Ÿ"
        
        # æ·»åŠ åŠŸèƒ½æŒ‰éˆ•åˆ°é–’èŠå›è¦†
        if is_group_message:
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text=f"{bot_trigger_keyword} è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text=f"{bot_trigger_keyword} é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text=f"{bot_trigger_keyword} è©é¨™é¡å‹åˆ—è¡¨"))
            ])
            mention_message = create_mention_message(reply_text, display_name, user_id, quick_reply)
            line_bot_api.reply_message(reply_token, mention_message)
        else:
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="åˆ†æå¯ç–‘è¨Šæ¯", text="è«‹å¹«æˆ‘åˆ†æé€™å‰‡è¨Šæ¯ï¼š")),
                QuickReplyButton(action=MessageAction(label="é˜²è©é¨™èƒ½åŠ›æ¸¬è©¦", text="é¸å“ªé¡†åœŸè±†")),
                QuickReplyButton(action=MessageAction(label="è©é¨™é¡å‹æŸ¥è©¢", text="è©é¨™é¡å‹åˆ—è¡¨"))
            ])
            line_bot_api.reply_message(reply_token, TextSendMessage(text=reply_text, quick_reply=quick_reply))
        
        # ä¿å­˜äº’å‹•è¨˜éŒ„åˆ°Firebase
        firebase_manager.save_user_interaction(
            user_id, display_name, text_message, reply_text,
            is_fraud_related=is_fraud_related,
            fraud_type=None,
            risk_level=None
        )

@handler.add(PostbackEvent)
def handle_postback(event):
    """å¤„ç†PostbackEventï¼ˆæŒ‰é’®ç‚¹å‡»ç­‰ï¼‰"""
    try:
        data = event.postback.data
        reply_token = event.reply_token
        user_id = event.source.user_id
        
        # è·å–ç”¨æˆ·æ˜¾ç¤ºåç§°
        user_profile = get_user_profile(user_id)
        display_name = user_profile.display_name if user_profile else 'æœ‹å‹'
    
        logger.info(f"æ¥æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ {user_id} çš„ Postback: {data}")
    
        # è§£æ data å‚æ•°
        data_parts = data.split('&')
        data_params = {}
        
        for part in data_parts:
            if '=' in part:
                key, value = part.split('=', 1)
                data_params[key] = value
        
        # è·å– action å‚æ•°
        action = data_params.get('action', '')
        
        # æ ¹æ® action å‚æ•°å¤„ç†ä¸åŒçš„æŒ‰é’®ç‚¹å‡»
        
        # å¤„ç†åœŸè±†æ¸¸æˆç­”æ¡ˆ - ä¿®å¤actionåç§°ä¸åŒ¹é…é—®é¢˜
        if action == 'potato_game_answer':
            handle_potato_game_answer(user_id, reply_token, data_params)
            return
        
        # å¤„ç†æ–°æ¸¸æˆè¯·æ±‚
        elif action == 'start_potato_game':
            send_potato_game_question(user_id, reply_token)
            return
        
        # å¤„ç†è§‚çœ‹å¹¿å‘Šï¼ˆæš«æ™‚åœç”¨ï¼‰
        elif action == 'view_ad':
            # å·²æš«åœå»£å‘ŠåŠŸèƒ½ï¼Œç›´æ¥çµ¦ç”¨æˆ¶æ¬¡æ•¸
            firebase_manager.increase_user_analysis_credits(user_id, amount=5)
            current_credits = firebase_manager.get_user_analysis_credits(user_id)
            
            line_bot_api.reply_message(
                reply_token,
                TextSendMessage(text=f"æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼ç³»çµ±å·²ç‚ºæ‚¨å¢åŠ 5æ¬¡åˆ†ææ©Ÿæœƒï¼Œç›®å‰å…¨é¢é–‹æ”¾å…è²»ç„¡é™ä½¿ç”¨ã€‚")
            )
            
            # è¨˜éŒ„äº’å‹•
            firebase_manager.save_user_interaction(
                user_id, display_name, "è«‹æ±‚å…è²»åˆ†ææ¬¡æ•¸", 
                "å·²çµ¦äºˆ5æ¬¡åˆ†ææ¬¡æ•¸ï¼Œç¾å·²é–‹æ”¾å…è²»ç„¡é™ä½¿ç”¨", 
                is_fraud_related=False
        )
            return
    
        # å¤„ç†èµåŠ©
        elif action == 'donate':
            amount = data_params.get('amount', 'small')
            
            # æ ¹æ®èµåŠ©é‡‘é¢å¢åŠ ç”¨æˆ·åˆ†ææ¬¡æ•°
            credits_to_add = 0
            donation_amount = "æœªçŸ¥"
            
            if amount == 'small':
                credits_to_add = 10
                donation_amount = "NT$50"
            elif amount == 'medium':
                credits_to_add = 30
                donation_amount = "NT$100"
            elif amount == 'large':
                credits_to_add = 100
                donation_amount = "NT$250"
            
            firebase_manager.increase_user_analysis_credits(user_id, amount=credits_to_add)
            
            # è·å–ç”¨æˆ·å½“å‰åˆ†ææ¬¡æ•°
            current_credits = firebase_manager.get_user_analysis_credits(user_id)
            
            # å‘é€ç¡®è®¤æ¶ˆæ¯ (ä¿®æ”¹ç‚ºæ„Ÿè¬æ”¯æŒçš„æ¶ˆæ¯)
            line_bot_api.reply_message(
                reply_token,
                TextSendMessage(text=f"æ„Ÿè¬æ‚¨çš„{donation_amount}è´ŠåŠ©ï¼æ‚¨å·²ç²å¾—{credits_to_add}æ¬¡åˆ†ææ©Ÿæœƒã€‚æ„Ÿè¬æ”¯æŒï¼Œç›®å‰ç³»çµ±å·²é–‹æ”¾å…è²»ç„¡é™ä½¿ç”¨ã€‚")
            )
            
            # è®°å½•äº’åŠ¨
            firebase_manager.save_user_interaction(
                user_id, display_name, f"è´ŠåŠ©:{amount}", 
                f"ç”¨æˆ¶è´ŠåŠ©{donation_amount}ç²å¾—{credits_to_add}æ¬¡åˆ†ææ¬¡æ•¸", 
                is_fraud_related=False
            )
            return

    except Exception as e:
        logger.error(f"è™•ç† Postback äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        line_bot_api.reply_message(reply_token, TextSendMessage(text="æŠ±æ­‰ï¼Œè™•ç† Postback äº‹ä»¶æ™‚å‡ºç¾éŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚"))

# è¼‰å…¥è©é¨™é¡Œåº«
POTATO_GAME_QUESTIONS_DB = os.path.join(os.path.dirname(__file__), "potato_game_questions.json")
potato_game_questions = []

def load_potato_game_questions():
    global potato_game_questions
    try:
        # è¨˜éŒ„è¼‰å…¥å‰çš„è·¯å¾‘ä¿¡æ¯
        file_path = os.path.abspath(POTATO_GAME_QUESTIONS_DB)
        logger.info(f"å˜—è©¦å¾è·¯å¾‘è®€å–é¡Œåº«æ–‡ä»¶: {file_path}")
        logger.info(f"ç•¶å‰å·¥ä½œç›®éŒ„: {os.getcwd()}")
        
        # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(file_path):
            logger.error(f"æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
            potato_game_questions = []
            return
            
        with open(POTATO_GAME_QUESTIONS_DB, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
            # è™•ç†ä¸åŒçš„JSONçµæ§‹
            all_questions = []
            
            if isinstance(data, dict) and "questions" in data:
                # è™•ç†é ‚å±¤questions
                top_questions = data.get("questions", [])
                
                for q in top_questions:
                    # æª¢æŸ¥æ˜¯å¦æœ‰åµŒå¥—çš„questionsæ•¸çµ„
                    if isinstance(q, dict) and "questions" in q:
                        # å°‡åµŒå¥—çš„questionsæ·»åŠ åˆ°ç¸½é¡Œåº«
                        nested_questions = q.get("questions", [])
                        all_questions.extend(nested_questions)
                        logger.info(f"ç™¼ç¾åµŒå¥—é¡Œç›®ï¼š{len(nested_questions)}é¡Œ")
                        # å°‡é ‚å±¤é¡Œç›®æ·»åŠ åˆ°ç¸½é¡Œåº«
                        all_questions.append(q)
            
            potato_game_questions = all_questions
            
        # ç¢ºèªæ–‡ä»¶å…§å®¹
        first_three_questions = []
        for i, q in enumerate(potato_game_questions[:3]):
            first_three_questions.append(f"é¡Œç›®ID: {q.get('id')}, è©é¨™é¡å‹: {q.get('fraud_type')}")
            
        logger.info(f"æˆåŠŸå¾ {POTATO_GAME_QUESTIONS_DB} åŠ è¼‰è©é¨™é¡Œåº«ï¼Œå…± {len(potato_game_questions)} é“é¡Œç›®")
        logger.info(f"å‰ä¸‰å€‹é¡Œç›®: {', '.join(first_three_questions)}")
        logger.info(f"é¡Œåº«ä¸­é¸é …ä¿¡æ¯: æœ‰é è¨­é¸é …çš„é¡Œç›®æ•¸é‡: {sum(1 for q in potato_game_questions if 'options' in q and q['options'] and 'correct_option' in q)}")
    except FileNotFoundError:
        logger.warning(f"è©é¨™é¡Œåº«æ–‡ä»¶ {POTATO_GAME_QUESTIONS_DB} æœªæ‰¾åˆ°ã€‚")
        potato_game_questions = []
    except json.JSONDecodeError:
        logger.error(f"è§£æè©é¨™é¡Œåº«æ–‡ä»¶ {POTATO_GAME_QUESTIONS_DB} å¤±æ•—ã€‚")
        potato_game_questions = []
    except Exception as e:
        logger.error(f"åŠ è¼‰è©é¨™é¡Œåº«æ™‚ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: {e}")
        potato_game_questions = []

load_fraud_tactics()
load_potato_game_questions()  # åŠ è¼‰é¡Œåº«

if __name__ == "__main__":
    # ç¢ºä¿åœ¨æœå‹™å•Ÿå‹•æ™‚é‡æ–°åŠ è¼‰é¡Œåº«
    load_fraud_tactics()
    load_potato_game_questions()
    
    # æ‰“å°é¡Œåº«åŠ è¼‰çµæœ
    logger.info(f"æœå‹™å•Ÿå‹•æ™‚è¼‰å…¥é¡Œåº«ï¼špotato_game_questions åŒ…å« {len(potato_game_questions)} é“é¡Œç›®")
    logger.info(f"é¡Œåº«ä¸­æœ‰é¸é …çš„é¡Œç›®æ•¸é‡: {sum(1 for q in potato_game_questions if 'options' in q and q['options'] and 'correct_option' in q)}")
    if potato_game_questions:
        logger.info(f"é¡Œåº«è·¯å¾‘: {os.path.abspath(POTATO_GAME_QUESTIONS_DB)}")
        logger.info(f"å·¥ä½œç›®éŒ„: {os.getcwd()}")
        
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port) 

@app.route("/watch-ad/<user_id>", methods=['GET'])
def watch_ad(user_id):
    """æ˜¾ç¤ºUnityå¹¿å‘Šçš„é¡µé¢"""
    return render_template('watch_ad.html', user_id=user_id)

@app.route("/watch-ad", methods=['GET'])
def watch_ad_without_id():
    """å¤„ç†LIFFé‡å®šå‘è¯·æ±‚"""
    # ä»LIFFè·å–ç”¨æˆ·IDï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›é€šç”¨é¡µé¢
    return render_template('watch_ad.html')

@app.route("/ad-completed", methods=['POST'])
def ad_completed():
    """å¤„ç†å¹¿å‘Šè§‚çœ‹å®Œæˆçš„å›è°ƒ"""
    data = request.json
    user_id = data.get('user_id')
    ad_type = data.get('ad_type', 'unity')
    
    if not user_id:
        return jsonify({'success': False, 'message': 'ç¼ºå°‘ç”¨æˆ¶ID'}), 400
    
    # è®°å½•å¹¿å‘Šè§‚çœ‹
    firebase_manager.record_ad_view(user_id, ad_type)
    
    # å¢åŠ ç”¨æˆ·åˆ†ææ¬¡æ•° (æ ¹æ“šéœ€æ±‚ä¿®æ”¹ç‚ºå›ºå®šå€¼)
    firebase_manager.increase_user_analysis_credits(user_id, amount=5)  # ç›´æ¥çµ¦5æ¬¡
    
    # è·å–ç”¨æˆ·å½“å‰åˆ†ææ¬¡æ•°
    current_credits = firebase_manager.get_user_analysis_credits(user_id)
    
    # å°è¯•å‘é€LINEæ¶ˆæ¯é€šçŸ¥ç”¨æˆ· (ä¿®æ”¹æ¶ˆæ¯ï¼Œç¾åœ¨æ˜¯å…è²»ä½¿ç”¨)
    try:
        line_bot_api.push_message(
            user_id,
            TextSendMessage(text=f"æ­å–œæ‚¨ç²å¾—5æ¬¡åˆ†ææ©Ÿæœƒï¼æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼Œç›®å‰å·²é–‹æ”¾å…è²»ç„¡é™ä½¿ç”¨ã€‚")
        )
    except Exception as e:
        logger.error(f"ç„¡æ³•ç™¼é€LINEé€šçŸ¥: {e}")
    
    return jsonify({
        'success': True, 
        'message': f'æ­å–œï¼æ‚¨å·²ç²å¾—5æ¬¡åˆ†ææ©Ÿæœƒï¼Œç›®å‰å…è²»ç„¡é™ä½¿ç”¨',
        'credits': "ç„¡é™"
    })

# æ·»åŠ è´ŠåŠ©è¨Šæ¯Flex Messageå‡½æ•¸
def create_donation_flex_message():
    """å‰µå»ºè´ŠåŠ©è¨Šæ¯çš„Flex Message"""
    try:
        # ç¢ºä¿URLæ ¼å¼æ­£ç¢ºåŒ…å«https://
        donation_url = "https://buymeacoffee.com/todao_antifruad"
        logger.info(f"å‰µå»ºè´ŠåŠ©Flex Messageï¼Œä½¿ç”¨URL: {donation_url}")
        
        flex_message = FlexSendMessage(
            alt_text="å¹«åŠ©æˆ‘å€‘ç¶­æŒæœå‹™å“è³ª",
            contents={
                "type": "bubble",
                # ç§»é™¤heroéƒ¨åˆ†ï¼Œä¸å†é¡¯ç¤ºåœ–ç‰‡
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": "æ„Ÿè¬æ‚¨ä½¿ç”¨é˜²è©é¨™å°å¹«æ‰‹",
                            "weight": "bold",
                            "size": "xl",
                            "color": "#FF8C00"
                        },
                        {
                            "type": "text",
                            "text": "å”å”é˜¿å§¨ï¼Œæœ€è¿‘è©é¨™çœŸçš„å¥½å¤šå–”ï¼å¹¸å¥½æœ‰é€™å€‹å°å¹«æ‰‹å¯ä»¥å¹«å¿™æª¢æŸ¥ã€‚å®ƒå°±åƒæˆ‘å€‘æ´¾åœ¨æ‚¨èº«é‚Šçš„å°ä¿é‘£ä¸€æ¨£ï¼ğŸ‘®â€â™‚ï¸",
                            "margin": "md",
                            "wrap": True,
                            "size": "md"
                        },
                        {
                            "type": "text",
                            "text": "ä¸éé€™å€‹å°ä¿é‘£ä¹Ÿéœ€è¦è£œå……é«”åŠ›ï¼ˆç³»çµ±ç¶­è­·è²»å•¦ï½ï¼‰ã€‚å¦‚æœå”å”é˜¿å§¨è¦ºå¾—å®ƒåšå¾—ä¸éŒ¯ï¼Œé¡˜æ„è«‹å®ƒåƒå€‹ã€ä¹–ä¹–ã€ï¼ˆè®“ç³»çµ±ä¹–ä¹–é‹ä½œï¼‰ï¼Œæˆ‘å€‘æœƒè¶…ç´šæ„Ÿå‹•çš„ï¼ä¸€é»é»å¿ƒæ„ï¼Œå°±èƒ½è®“å®ƒæ›´æœ‰åŠ›æ°£ä¿è­·å¤§å®¶å–”ï¼ğŸ’ª",
                            "margin": "md",
                            "wrap": True,
                            "size": "md"
                        }
                    ]
                },
                "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "button",
                            "style": "primary",
                            "height": "sm",
                            "action": {
                                "type": "uri",
                                "label": "æˆ‘è¦è´ŠåŠ©",
                                "uri": donation_url
                            },
                            "color": "#FF8C00"
                        },
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "æ‚¨çš„æ”¯æŒæ˜¯æˆ‘å€‘æŒçºŒæ”¹é€²çš„å‹•åŠ›",
                                    "color": "#aaaaaa",
                                    "size": "sm",
                                    "align": "center"
                                }
                            ],
                            "margin": "md"
                        }
                    ],
                    "flex": 0
                }
            }
        )
        
        return flex_message
    except Exception as e:
        logger.error(f"å‰µå»ºè´ŠåŠ©Flex Messageæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        # è¿”å›ä¸€å€‹ç°¡å–®çš„æ–‡æœ¬æ¶ˆæ¯ä½œç‚ºå‚™ç”¨
        return TextSendMessage(text="æ„Ÿè¬æ‚¨çš„ä½¿ç”¨ï¼å¦‚æœè¦ºå¾—æœå‹™æœ‰å¹«åŠ©ï¼Œæ­¡è¿è´ŠåŠ©æ”¯æŒæˆ‘å€‘ï¼šhttps://buymeacoffee.com/todao_antifruad")
    logger.info(f"User {user_id} is chatting for the first time")

# ä¿®æ”¹åŸä¾†ä½¿ç”¨@å‰ç¶´çš„åœ°æ–¹ï¼Œæ”¹ç‚ºä½¿ç”¨MentionåŠŸèƒ½
def create_mention_message(text, display_name, user_id, quick_reply=None):
    """å‰µå»ºå¸¶æœ‰æ–‡æœ¬@åŠŸèƒ½çš„æ¶ˆæ¯ï¼Œå…¼å®¹èˆŠç‰ˆæœ¬SDK"""
    text_with_mention = f"@{display_name} {text}"
    return TextSendMessage(text=text_with_mention, quick_reply=quick_reply)

# å‰µå»ºä¸€å€‹å…¨å±€å­—å…¸ä¾†è·Ÿè¸ªç”¨æˆ¶ç‹€æ…‹
user_conversation_state = {}  # æ ¼å¼: {user_id: {"last_time": timestamp, "waiting_for_analysis": True/False}}

# æ”¹é€²contains_urlå‡½æ•¸ï¼Œä½¿å…¶æ›´æº–ç¢ºåœ°è­˜åˆ¥URL
def contains_url(text):
    """æ›´æº–ç¢ºåœ°æª¢æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«URL"""
    if not text:
        return False
    # ä¸€å€‹æ›´å®Œæ•´çš„URLæª¢æ¸¬æ­£å‰‡è¡¨é”å¼
    url_pattern = re.compile(
        r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'
        r'|(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\.[^\s]{2,}|'
        r'(?:www\.|(?!www))[a-zA-Z0-9]+\.[^\s]{2,}'
    )
    return bool(url_pattern.search(text))

# æ”¹é€²should_perform_fraud_analysiså‡½æ•¸ï¼Œæ›´å¥½åœ°è™•ç†ç¶²å€åˆ†æ
def should_perform_fraud_analysis(text_message):
    """åˆ¤æ–·æ˜¯å¦éœ€è¦å°æ¶ˆæ¯é€²è¡Œè©é¨™åˆ†æ"""
    if not text_message:
        return False
        
    # 1. å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯æ¬¡æ•°æŸ¥è¯¢ï¼Œé¿å…è¿™ç±»æ¶ˆæ¯è¢«åˆ†æ
    if any(keyword in text_message.lower() for keyword in ["å‰©ä½™æ¬¡æ•°", "å‰©é¤˜æ¬¡æ•¸", "æŸ¥è©¢æ¬¡æ•¸", "æŸ¥è¯¢æ¬¡æ•°", "é‚„æœ‰å¹¾æ¬¡", "è¿˜æœ‰å‡ æ¬¡", "å‰©ä¸‹å¹¾æ¬¡", "å‰©ä¸‹å‡ æ¬¡", "å¹¾æ¬¡æ©Ÿæœƒ", "å‡ æ¬¡æœºä¼š", "å¹¾æ¬¡åˆ†æ", "å‡ æ¬¡åˆ†æ"]):
        return False
    
    # 2. æª¢æŸ¥æ˜¯å¦æ˜¯è©¢å•æ©Ÿå™¨äººå·¥ä½œåŸç†æˆ–åŠŸèƒ½çš„å•é¡Œï¼ˆæ–°å¢ï¼‰
    meta_questions = ["åˆ¤æ–·.*é‚è¼¯", "å¦‚ä½•.*åˆ†æ", "æ€éº¼.*åˆ¤æ–·", "åŸç†.*ä»€éº¼", "æ€éº¼.*é‹ä½œ", "å¦‚ä½•.*é‹ä½œ", "å·¥ä½œ.*åŸç†", "åˆ†æ.*æ–¹å¼", "æª¢æ¸¬.*æ–¹æ³•"]
    if any(re.search(pattern, text_message) for pattern in meta_questions):
        logger.info(f"è¨Šæ¯æ˜¯è©¢å•æ©Ÿå™¨äººå·¥ä½œåŸç†ï¼Œä¸é€²è¡Œè©é¨™åˆ†æ")
        return False
        
    # 3. ç›´æ¥æª¢æŸ¥æ˜¯å¦å«æœ‰URLï¼Œå¦‚æœæœ‰å„ªå…ˆåˆ†æ
    if contains_url(text_message):
        logger.info(f"è¨Šæ¯ä¸­å«æœ‰URLï¼Œå°‡é€²è¡Œè©é¨™åˆ†æ")
        return True
        
    # 4. æª¢æŸ¥æ˜¯å¦åŒ…å«å¸¸è¦‹å•å€™è©å’Œç°¡çŸ­è¨Šæ¯
    common_greetings = ["ä½ å¥½", "å—¨", "å“ˆå›‰", "å˜¿", "hi", "hello", "hey", "æ—©å®‰", "åˆå®‰", "æ™šå®‰"]
    if text_message.lower() in common_greetings or (len(text_message) <= 5 and any(greeting in text_message.lower() for greeting in common_greetings)):
        return False
        
    # 5. æª¢æŸ¥æ˜¯å¦å«æœ‰æ˜ç¢ºçš„åˆ†æè«‹æ±‚é—œéµè©
    analysis_keywords = ["åˆ†æ", "è©é¨™", "å®‰å…¨", "å¯ç–‘", "é¢¨éšª", "ç¶²ç«™"]
    if any(keyword in text_message.lower() for keyword in analysis_keywords) and "å—" in text_message:
        # å¦‚æœåŒæ™‚åŒ…å«åˆ†æé—œéµè©å’Œç–‘å•è©ï¼Œå¯èƒ½æ˜¯è«‹æ±‚åˆ†æ
        logger.info(f"è¨Šæ¯åŒ…å«åˆ†æè«‹æ±‚é—œéµè©å’Œç–‘å•è©ï¼Œå°‡é€²è¡Œè©é¨™åˆ†æ")
        return True
        
    # 6. æª¢æŸ¥æ˜¯å¦èˆ‡å·²çŸ¥çš„ç¶²åŸŸç›¸é—œ
    for domain in SHORT_URL_DOMAINS + list(SAFE_DOMAINS.keys()):  # ä¿®å¾©ï¼šå°‡å­—å…¸éµè½‰æ›ç‚ºåˆ—è¡¨
        if domain.lower() in text_message.lower():
            logger.info(f"è¨Šæ¯åŒ…å«å·²çŸ¥ç¶²åŸŸ {domain}ï¼Œå°‡é€²è¡Œè©é¨™åˆ†æ")
            return True
    
    # 7. æª¢æŸ¥æ˜¯å¦æ˜¯åŠŸèƒ½ç›¸é—œæŒ‡ä»¤
    if any(keyword in text_message.lower() for keyword in function_inquiry_keywords + potato_game_trigger_keywords) or "è©é¨™é¡å‹" in text_message:
        return False
        
    # 8. æª¢æŸ¥æ˜¯å¦æ˜¯è·Ÿè¸ªæ¨¡å¼çš„å•å¥ï¼ˆä¿®æ”¹é‚è¼¯ï¼Œæ’é™¤è©¢å•æ©Ÿå™¨äººçš„å•é¡Œï¼‰
    if any(pattern in text_message.lower() for pattern in follow_up_patterns):
        # å¦‚æœåŒ…å«è©¢å•è©ï¼ˆä»€éº¼ã€å¦‚ä½•ã€æ€éº¼ç­‰ï¼‰ï¼Œå¯èƒ½æ˜¯è©¢å•è€Œééœ€è¦åˆ†æçš„å…§å®¹
        inquiry_words = ["ä»€éº¼", "å¦‚ä½•", "æ€éº¼", "ç‚ºä»€éº¼", "é‚è¼¯", "åŸç†", "æ–¹å¼", "æ–¹æ³•"]
        if any(word in text_message for word in inquiry_words):
            logger.info(f"è¨Šæ¯åŒ…å«è©¢å•è©ï¼Œåˆ¤æ–·ç‚ºè©¢å•è€Œééœ€è¦åˆ†æçš„å…§å®¹")
            return False
        return True
        
    # 9. æª¢æŸ¥æ˜¯å¦æ˜¯è«‹æ±‚åˆ†æçš„æ˜é¡¯ç‰¹å¾µ
    analysis_indicators = ["å¹«æˆ‘åˆ†æ", "å¹«å¿™çœ‹çœ‹", "é€™æ˜¯ä¸æ˜¯è©é¨™", "é€™æ˜¯çœŸçš„å—", "é€™å¯é å—", "åˆ†æä¸€ä¸‹", "é€™æ¨£æ˜¯è©é¨™å—"]
    if any(indicator in text_message for indicator in analysis_indicators):
        return True
        
    # 10. æª¢æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šè©é¨™ç›¸é—œé—œéµè©
    # åªæœ‰ä½¿ç”¨è€…æ˜ç¢ºè¡¨ç¤ºéœ€è¦åˆ†æï¼Œæˆ–è€…æ–‡æœ¬åŒ…å«å¤šå€‹è©é¨™é—œéµè©æ‰é€²è¡Œåˆ†æ
    fraud_related_keywords = ["è©é¨™", "è¢«é¨™", "é¨™å­", "å¯ç–‘", "è½‰å¸³", "åŒ¯æ¬¾", "éŠ€è¡Œå¸³è™Ÿ", "å€‹è³‡", "èº«ä»½è­‰", "å¯†ç¢¼", 
                            "é€šçŸ¥", "ä¸­ç", "è²¸æ¬¾", "æŠ•è³‡", "æ€¥éœ€", "å¹«æˆ‘è™•ç†", "æ€¥ç”¨", "è§£é™¤è¨­å®š", "ææ¬¾å¡", 
                            "ç›£ç®¡å¸³æˆ¶", "è§£å‡", "å®‰å…¨å¸³æˆ¶", "ç°½è­‰", "ä¿è­‰é‡‘", "é•æ³•", "æ´—éŒ¢", "è­¦å¯Ÿ", "æª¢å¯Ÿå®˜"]
                            
    # è¦æ±‚è‡³å°‘åŒ…å«å…©å€‹è©é¨™ç›¸é—œé—œéµè©
    keyword_count = sum(1 for keyword in fraud_related_keywords if keyword in text_message)
    if keyword_count >= 2:
        return True
        
    # 11. é è¨­ä¸é€²è¡Œè©é¨™åˆ†æï¼Œå°‡è¨Šæ¯ä½œç‚ºä¸€èˆ¬é–’èŠè™•ç†
    return False

if __name__ == "__main__":
    # ç¢ºä¿åœ¨æœå‹™å•Ÿå‹•æ™‚é‡æ–°åŠ è¼‰é¡Œåº«
    load_fraud_tactics()
    load_potato_game_questions()
    
    # æ‰“å°é¡Œåº«åŠ è¼‰çµæœ
    logger.info(f"æœå‹™å•Ÿå‹•æ™‚è¼‰å…¥é¡Œåº«ï¼špotato_game_questions åŒ…å« {len(potato_game_questions)} é“é¡Œç›®")
    logger.info(f"é¡Œåº«ä¸­æœ‰é¸é …çš„é¡Œç›®æ•¸é‡: {sum(1 for q in potato_game_questions if 'options' in q and q['options'] and 'correct_option' in q)}")
    if potato_game_questions:
        logger.info(f"é¡Œåº«è·¯å¾‘: {os.path.abspath(POTATO_GAME_QUESTIONS_DB)}")
        logger.info(f"å·¥ä½œç›®éŒ„: {os.getcwd()}")
        
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port) 