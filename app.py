# -*- coding: utf-8 -*-
import os
import json
from flask import Flask, request, abort, render_template
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import (
    MessageEvent, TextMessage, TextSendMessage, FlexSendMessage,
    QuickReply, QuickReplyButton, MessageAction, PostbackEvent, PostbackAction,
    BubbleContainer, BoxComponent, ButtonComponent, TextComponent,
    CarouselContainer, URIAction, SeparatorComponent
)
from dotenv import load_dotenv
import openai
import logging
from firebase_manager import FirebaseManager
import random
import datetime  # Â∞éÂÖ•datetimeÁî®ÊñºÊôÇÈñìÊØîËºÉ
import re

# ÊåáÂÆö .env Êñá‰ª∂ÁöÑË∑ØÂæë
# ÂÅáË®≠ anti-fraud-clean Âíå linebot-anti-fraud ÊòØÂêåÁ¥öÁõÆÈåÑ
dotenv_path = os.path.join(os.path.dirname(__file__), '..', 'linebot-anti-fraud', '.env')
load_dotenv(dotenv_path=dotenv_path)

app = Flask(__name__)

# Line API Ë®≠ÂÆö
line_bot_api = LineBotApi(os.environ.get('LINE_CHANNEL_ACCESS_TOKEN', ''))
handler = WebhookHandler(os.environ.get('LINE_CHANNEL_SECRET', ''))

# OpenAIË®≠ÂÆö
openai.api_key = os.environ.get('OPENAI_API_KEY', '')

# Ë®≠ÁΩÆÊó•Ë™å
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# ÂàùÂßãÂåñFirebaseÁÆ°ÁêÜÂô®
firebase_manager = FirebaseManager.get_instance()

# Áî®Êà∂ÈÅäÊà≤ÁãÄÊÖã
user_game_state = {}

# Áî®Êà∂ÊúÄÂæåËÅäÂ§©ÊôÇÈñìË®òÈåÑ
user_last_chat_time = {}
user_pending_analysis = {} # Áî®ÊñºËøΩËπ§Á≠âÂæÖÁî®Êà∂ÊæÑÊ∏ÖÁöÑÂàÜÊûêË´ãÊ±Ç
first_time_chatters = set()  # ËøΩËπ§È¶ñÊ¨°ËÅäÂ§©ÁöÑÁî®Êà∂

CHAT_TIP_PROBABILITY = 0.3 # ÈñíËÅäÊôÇÂõûË¶ÜÈò≤Ë©êÂ∞èÁü•Ë≠òÁöÑÊ©üÁéá

# ÂÆöÁæ©ÈóúÈçµË©ûÂíåÊ®°Âºè
function_inquiry_keywords = ["ÂäüËÉΩ", "Âπ´Âä©", "ÊúÉ‰ªÄÈ∫º", "ËÉΩÂÅö‰ªÄÈ∫º", "‰ΩøÁî®Ë™™Êòé", "‰Ω†ÊòØË™∞"]
follow_up_patterns = ["Ë¢´È®ô", "Ë©êÈ®ô", "ÂèØÁñë", "‰∏çÁ¢∫ÂÆö", "Âπ´ÊàëÁúãÁúã", "ÈÄôÊòØË©êÈ®ôÂóé", "ÈÄôÊòØÁúüÁöÑÂóé"]
potato_game_trigger_keywords = ["ÈÅ∏Âì™È°ÜÂúüË±Ü", "Áé©ÈÅäÊà≤", "ÂúüË±ÜÈÅäÊà≤", "ÈÅ∏ÂúüË±Ü", "ÈÅ∏ÂúüË±ÜÈÅäÊà≤", "ÈñãÂßãÈÅäÊà≤"]

# ÂÆöÁæ©Èò≤Ë©êÂ∞èÁü•Ë≠ò
anti_fraud_tips = [
    "üîç Êî∂Âà∞‰∏çÊòéÈÄ£ÁµêÔºüÂÖàÁ¢∫Ë™çÁôº‰ø°‰∫∫Ë∫´ÂàÜÔºåÂÜç‰∏âÊÄùËÄåÂæåË°å„ÄÇÈªûÊìäÂâçÂïèËá™Â∑±ÔºöÈÄôÁúüÁöÑÂøÖË¶ÅÂóéÔºü",
    "üîê Ë´ãÂÆöÊúüÊõ¥ÊèõÂØÜÁ¢ºÔºå‰∏¶ÈÅøÂÖçÂú®‰∏çÂêåÂπ≥Âè∞‰ΩøÁî®Áõ∏ÂêåÁöÑÂØÜÁ¢ºÁµÑÂêà„ÄÇÂª∫Ë≠∞‰ΩøÁî®ÂØÜÁ¢ºÁÆ°ÁêÜÂ∑•ÂÖ∑ÔºÅ",
    "üì± Êé•Âà∞Ëá™Á®±ÈäÄË°å„ÄÅË≠¶ÊñπÁöÑÈõªË©±ÔºüÊéõÊñ∑ÂæåÔºå‰∏ªÂãïÊí•ÊâìÂÆòÊñπÈõªË©±Á¢∫Ë™çÔºå‰∏çË¶ÅÂõûÊí•Â∞çÊñπÊèê‰æõÁöÑËôüÁ¢º„ÄÇ",
    "üí∞ ÊäïË≥áÂ†±ÈÖ¨ÁéáÈ´òÂæó‰∏çÂêàÁêÜÔºüË®ò‰ΩèÔºöÂ§©‰∏ãÊ≤íÊúâÁôΩÂêÉÁöÑÂçàÈ§êÔºåÈ´òÂ†±ÈÖ¨ÂøÖÊúâÈ´òÈ¢®Èö™ÔºÅ",
    "ü§ù Á∂≤Ë∑Ø‰∫§ÂèãË¶ÅË¨πÊÖéÔºåÁü≠ÊôÇÈñìÂÖßÂ∞±Ë´áÂèäÈáëÈå¢ÂæÄ‰æÜÁöÑ„ÄåÂ•ΩÂèã„ÄçÂæàÂèØËÉΩÊòØË©êÈ®ôÈõÜÂúò„ÄÇ",
    "üè¶ ÁúüÊ≠£ÁöÑÈäÄË°åÁµï‰∏çÊúÉË´ã‰Ω†Êìç‰ΩúATM„ÄåËß£Èô§Ë®≠ÂÆö„Äç„ÄÅ„ÄåÂçáÁ¥öÁ≥ªÁµ±„ÄçÊàñ„ÄåÁ¢∫Ë™çË∫´ÂàÜ„Äç„ÄÇ",
    "üõí Á∂≤Ë≥ºÂè™Áî®Ê≠£Ë¶èÂπ≥Âè∞Ôºå‰∫§ÊòìÊôÇÁïôÂú®Âπ≥Âè∞ÂÖßÂÆåÊàêÔºåÂàáÂãøÁßÅ‰∏ã‰∫§ÊòìÊàñÊèêÂâç‰ªòÊ¨æ„ÄÇ",
    "üéÆ Ë≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏ÂâçÔºåÂÖàÁ¢∫Ë™çÁî®ÈÄîÔºåËã•ÊòØÁµ¶ÈôåÁîü‰∫∫ÊàñËß£ÂáçÂ∏≥Êà∂‰ΩøÁî®ÔºåÊ•µÂèØËÉΩÊòØË©êÈ®ôÔºÅ"
]

# Ë©êÈ®ôÈ°ûÂûãÂàÜÈ°û
fraud_types = {
    "Á∂≤Ë∑ØË≥ºÁâ©Ë©êÈ®ô": {
        "description": "Ê∂âÂèäÂÅáÂÜíË≥ºÁâ©Á∂≤Á´ô„ÄÅËôõÂÅáÂïÜÂìÅÊàñ‰∏çÂØ¶Âª£ÂëäÁöÑË©êÈ®ô",
        "examples": [
            "üõí ÂÅáË≤∑ÂÆ∂È®ôË≥£ÂÆ∂Ë©êÈ®ôÊ°à‰æã üõí\n\nË©êÈ®ôÈõÜÂúòÂÅáÊâÆË≤∑ÂÆ∂Êé•Ëß∏‰∫åÊâãÂïÜÂìÅË≥£ÂÆ∂ÔºåËÅ≤Á®±ÈÄèÈÅéËù¶ÁöÆÁ≠âÂπ≥Âè∞‰∫§ÊòìÔºåÂºïÂ∞éË≥£ÂÆ∂Âä†ÂÖ•ÂÅáÂÜíÂÆ¢ÊúçLINEÂ∏≥ËôüÔºå‰ª•„ÄåÁ∞ΩÁΩ≤‰øùË≠âÊõ∏„Äç„ÄÅ„ÄåÈäÄË°åË™çË≠â„ÄçÁ≠âËóâÂè£Ë™òÂ∞éË≥£ÂÆ∂ÈÄ≤Ë°åÁ∂≤Ë∑ØÈäÄË°åËΩâÂ∏≥ÊàñLINE Pay‰ªòÊ¨æÔºåÂ∞éËá¥ÂèóÂÆ≥ËÄÖË≤°Áî¢ÊêçÂ§±„ÄÇ\n\nüìä Ë≥áÊñô‰æÜÊ∫êÔºö165ÊâìË©êÂÑÄË°®Êùø"
        ],
        "sop": [
            "‚ö†Ô∏è Èò≤ÁØÑÁ∂≤Ë∑ØË≥ºÁâ©Ë©êÈ®ôÊ≥®ÊÑè‰∫ãÈ†Ö ‚ö†Ô∏è",
            "1Ô∏è‚É£ ÊúâÁ∂≤Ë∑Ø‰∫§ÊòìÂïèÈ°åÔºåË´ãÊ¥Ω‰∫§ÊòìÂπ≥Ëá∫ÂÖ¨ÂëäÁöÑÂÆòÊñπÂÆ¢ÊúçËÅØÁπ´ÊñπÂºèÔºå‰∏çË¶Å‰ΩøÁî®ÈôåÁîü‰∫∫Êèê‰æõÁöÑËÅØÁπ´ÊñπÂºè",
            "2Ô∏è‚É£ Â†ÖÂÆàÂπ≥Âè∞ÂÖßÈÉ®‰∫§ÊòìÔºå‰∏çË¶ÅË∑≥Âá∫Ëù¶ÁöÆ„ÄÅÈú≤Â§©ÊàñÂÖ∂‰ªñÂπ≥Âè∞ÁöÑÂ∞çË©±Á≥ªÁµ±",
            "3Ô∏è‚É£ ÈäÄË°åÂèäËù¶ÁöÆÁ≠âÂπ≥Âè∞‰∏çÊúÉ‰ª•ÁßÅ‰∫∫LINEÂ∏≥ËôüËÅØÁπ´ÂÆ¢Êà∂",
            "4Ô∏è‚É£ ÈÅáÂà∞Ë¶ÅÊ±Ç„ÄåÁ∞ΩÁΩ≤‰øùË≠âÊõ∏„Äç„ÄÅ„ÄåÈäÄË°åË™çË≠â„ÄçÁ≠âÊìç‰ΩúÊôÇÔºåË´ãÊèêÈ´òË≠¶Ë¶∫",
            "5Ô∏è‚É£ ÁµïÂ∞ç‰∏çË¶Å‰æùÁÖß‰ªñ‰∫∫ÊåáÁ§∫Êìç‰ΩúÁ∂≤Ë∑ØÈäÄË°åÊàñÈÄ≤Ë°åËΩâÂ∏≥",
            "6Ô∏è‚É£ Êúâ‰ªª‰ΩïÁñëÂïèÔºåË´ãÁ´ãÂç≥Êí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "ÂÅá‰∫§ÂèãÊäïË≥áË©êÈ®ô": {
        "description": "ÈÄèÈÅéÁ∂≤Ë∑Ø‰∫§ÂèãÂπ≥Âè∞ÊàñÁ§æÁæ§Â™íÈ´îÔºåÂÅáÊâÆÊúâÂ•ΩÊÑüÁöÑÁï∞ÊÄßÂª∫Á´ãÊÑüÊÉÖÈÄ£ÁµêÔºåÊúÄÁµÇ‰ª•ÂêÑÁ®ÆÁêÜÁî±È®ôÂèñÈáëÈå¢",
        "examples": [
            "üíî Á∂≤Ë∑Ø‰∫§ÂèãË©êÈ®ôÊ°à‰æã üíî\n\nË©êÈ®ôËÄÖÂÅáÊâÆÈ´òÁ§æÁ∂ìÂú∞‰Ωç‰∫∫Â£´ÔºàÂ¶ÇÈÜ´Áîü„ÄÅËªçÂÆò„ÄÅÊ©üÈï∑Á≠âÔºâËàáË¢´ÂÆ≥ËÄÖÂú®Á∂≤Ë∑Ø‰∏äË™çË≠ò‰∏¶Âª∫Á´ãÊÉÖÊÑüÈÄ£ÁµêÔºåÈï∑ÊúüÂôìÂØíÂïèÊöñÂæåÔºå‰ª•ÁîüÁóÖÈúÄË¶ÅÈÜ´Ëó•Ë≤ª„ÄÅÂØÑÈÄÅÊµ∑Â§ñÁ¶ÆÁâ©ÈúÄÁπ≥Á¥çÈóúÁ®ÖÁ≠âÂêÑÁ®ÆÁêÜÁî±ÔºåË™òÈ®ôË¢´ÂÆ≥ËÄÖËΩâÂ∏≥ÊàñÈù¢‰∫§ÈáëÈå¢„ÄÇÊ≠§È°ûË©êÈ®ôÁâπÂà•ÈáùÂ∞çÂØ°Â±ÖÊàñÊÉÖÊÑüÁîüÊ¥ªËºÉÁÇ∫Â≠§ÂñÆÁöÑ‰∏≠ËÄÅÂπ¥‰∫∫„ÄÇ\n\nüìä Ë≥áÊñô‰æÜÊ∫êÔºö165ÊâìË©êÂÑÄË°®Êùø"
        ],
        "sop": [
            "‚ö†Ô∏è Èò≤ÁØÑ‰∫§ÂèãÊäïË≥áË©êÈ®ôÊ≥®ÊÑè‰∫ãÈ†Ö ‚ö†Ô∏è",
            "1Ô∏è‚É£ Á∂≤ÂèãË¶ãÈÉΩÊ≤íË¶ãÈÅéÂçªË´áÂèäÈáëÈå¢ÔºåÈ´òÂ∫¶ÂèØËÉΩÊòØË©êÈ®ô",
            "2Ô∏è‚É£ Â∞çÊñπËá™Á®±Èï∑ÊúüÂú®ÂúãÂ§ñÂ∑•‰ΩúÔºàÂ¶ÇËªçÈÜ´„ÄÅÊ©üÈï∑Á≠âÔºâ‰∏îÁÑ°Ê≥ïË¶ãÈù¢Ôºå‰ΩÜÂæàÂø´ÁôºÂ±ïÊÑüÊÉÖÈóú‰øÇÔºåÊáâÊèêÈ´òË≠¶Ë¶∫",
            "3Ô∏è‚É£ ÊãíÁµï‰ªª‰Ωï‰ª•Á∑äÊÄ•ÈÜ´ÁôÇË≤ª„ÄÅÈÅãË≤ª„ÄÅÁ®ÖÈáëÁ≠âÂêçÁæ©Ë¶ÅÊ±ÇÁöÑÈáëÈå¢ÂæÄ‰æÜ",
            "4Ô∏è‚É£ ‰∏çË¶ÅËÅΩ‰ø°ÈúÄË¶ÅÂçîÂä©ÈñãÈÄöÂ§ñÂπ£Â∏≥Êà∂„ÄÅÂÄüÁî®Â∏≥Êà∂ÁöÑË™™Ê≥ï",
            "Á∂≤ÂèãË¶ãÈÉΩÊ≤íË¶ãÈÅéÂçªË´áÂèäÈáëÈå¢ÔºåÈ´òÂ∫¶ÂèØËÉΩÊòØË©êÈ®ô",
            "Â∞çÊñπËá™Á®±Èï∑ÊúüÂú®ÂúãÂ§ñÂ∑•‰ΩúÔºàÂ¶ÇËªçÈÜ´„ÄÅÊ©üÈï∑Á≠âÔºâ‰∏îÁÑ°Ê≥ïË¶ãÈù¢Ôºå‰ΩÜÂæàÂø´ÁôºÂ±ïÊÑüÊÉÖÈóú‰øÇÔºåÊáâÊèêÈ´òË≠¶Ë¶∫",
            "ÊãíÁµï‰ªª‰Ωï‰ª•Á∑äÊÄ•ÈÜ´ÁôÇË≤ª„ÄÅÈÅãË≤ª„ÄÅÁ®ÖÈáëÁ≠âÂêçÁæ©Ë¶ÅÊ±ÇÁöÑÈáëÈå¢ÂæÄ‰æÜ",
            "‰∏çË¶ÅËÅΩ‰ø°ÈúÄË¶ÅÂçîÂä©ÈñãÈÄöÂ§ñÂπ£Â∏≥Êà∂„ÄÅÂÄüÁî®Â∏≥Êà∂ÁöÑË™™Ê≥ï",
            "ÈÅøÂÖçÂçîÂä©ÈôåÁîüÁ∂≤ÂèãÁî≥Ëæ¶ÊâãÊ©üÈñÄËôüÊàñÊèê‰æõSIMÂç°",
            "Â∞çÊñºÁ∂≤ÂèãÊâÄÊèê‰æõÁöÑË∫´‰ªΩË≥áË®äÔºåÂòóË©¶Â§öÊñπÊü•Ë≠â",
            "Êúâ‰ªª‰ΩïÁñëÂïèÔºåË´ãÁ´ãÂç≥Êí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢",
            "Â§öËàáÂÆ∂‰∫∫ÊúãÂèãÂàÜ‰∫´‰∫§ÂèãÊÉÖÊ≥ÅÔºåÈÅøÂÖçÂñÆÁç®ÂÅöÂá∫Ë≤°ÂãôÊ±∫ÂÆö"
        ]
    },
    "ÂÅá‰∏≠ÁçéÈÄöÁü•Ë©êÈ®ô": {
        "description": "ÂÜíÂÖÖÂÆòÊñπÂñÆ‰ΩçÊàñÁü•Âêç‰ºÅÊ•≠ÔºåÂÆ£Á®±‰∏≠Áçé‰ΩÜÈúÄÁπ≥Á¥çÊâãÁ∫åË≤ªÁ≠âË≤ªÁî®ÊâçËÉΩÈ†òÁçéÁöÑË©êÈ®ô",
        "examples": [],
        "sop": []
    },
    "ÂÅáÂÄüÈäÄË°åË≤∏Ê¨æË©êÈ®ô": {
        "description": "ÂÅáÂÜíÈáëËûçÊ©üÊßã‰∫∫Âì°ÔºåÂÆ£ÂÇ≥‰ΩéÂà©Âø´ÈÄüË≤∏Ê¨æÔºå‰ΩÜË¶ÅÊ±ÇÂÖàÊîØ‰ªòÊâãÁ∫åË≤ªÊàñË≥ºË≤∑ÈªûÊï∏",
        "examples": [
            "‰∏ÄÂêçÊÄ•ÈúÄË≥áÈáëÂÑüÈÇÑÂÆ∂Â∫≠ÂÇµÂãôÁöÑÊ∞ëÁúæÂú®FacebookÁúãÂà∞ÂêçÁÇ∫„ÄåÊï∏‰ΩçÈÄüeË≤∏„ÄçÁöÑÂª£ÂëäÔºåÊ®ôÊ¶úË≤∏Ê¨æÂø´ÈÄü„ÄÅÂà©ÊÅØ‰Ωé‰∏îÊâãÁ∫åÁ∞°ÂñÆ„ÄÇÊñºÊòØÂä†ÂÖ•‰∫Ü‰∏ÄÂÄãÂêçÁÇ∫„ÄåÂè∞ÂåóÂØåÈÇ¶ÈäÄË°å‰ø°Ë≤∏„ÄçÁöÑLINEÂ∏≥Ëôü„ÄÇÂú®Áî≥Ë´ãË≤∏Ê¨æ30Ëê¨ÂÖÉ‰∏¶ÈÄöÈÅéÂàùÂØ©ÂæåÔºåÂ∞çÊñπË°®Á§∫ÈúÄË¶ÅË≥ºË≤∑‰∏Ä‰ªΩÈáëËûçË≤∏Ê¨æ‰øùÈö™ÔºåÊâçËÉΩÊèêÈ´ò‰ø°Áî®Ë©ïÂàÜ„ÄÇÂèóÂÆ≥ËÄÖÂåØ‰∫Ü1Ëê¨5ÂçÉÂÖÉÂà∞ÊåáÂÆöÂ∏≥Êà∂ÂæåÔºåÂ∞çÊñπÂèàË¶ÅÊ±ÇË≥ºË≤∑ÈªûÊï∏Âç°‰ª•Â¢ûÂä†‰ø°Ë≤∏Ë©ïÂàÜ„ÄÇÂèóÂÆ≥ËÄÖÂ§öÊ¨°Ë≥ºË≤∑ÈªûÊï∏Âç°‰∏¶Êèê‰æõÁµ¶Â∞çÊñπ„ÄÇ‰∏ç‰πÖÂæåÔºåÂèóÂÆ≥ËÄÖÁôºÁèæÁ∂≤Ë∑ØÈäÄË°åÂ∏≥Êà∂ÁÑ°Ê≥ï‰ΩøÁî®ÔºåËÅØÁπ´Â∞çÊñπ‰πüÂ∑≤Â§±ËÅØ„ÄÇÂêëÈäÄË°åÂÆ¢ÊúçÊü•Ë©¢ÂæåÔºåÁ¢∫Ë™çÂ∏≥Êà∂Â∑≤Ë¢´ÂàóÂÖ•Ë≠¶Á§∫ÂêçÂñÆÔºå‰∏îÈÄôÊ†πÊú¨‰∏çÊòØÂè∞ÂåóÂØåÈÇ¶ÈäÄË°åÁöÑÊ•≠Âãô„ÄÇ"
        ],
        "sop": [
            "Ë≤∏Ê¨æË´ãÊâæÂêàÊ≥ïÁöÑÈáëËûçÊ©üÊßã„ÄÅ‰øùÈö™ÂÖ¨Âè∏Ëæ¶ÁêÜ",
            "ÂêàÊ≥ïË≤∏Ê¨æÊ©üÊßã‰∏çÊúÉË¶ÅÊ±Ç‰∫ãÂÖàÊîØ‰ªòÊâãÁ∫åË≤ªÊàñ‰øùË≠âÈáë",
            "ÈäÄË°åËæ¶ÁêÜ‰ø°Ë≤∏ÔºåÁµï‰∏çÊúÉË¶ÅÊ±ÇË≥ºË≤∑ÈªûÊï∏Âç°ÊàñÈ†êÂÖàÂåØÊ¨æ",
            "ÂèàÊòØË≤∏Ê¨æ„ÄÅÂèàÊòØÈªûÊï∏Âç°ÔºåÁµïÂ∞çÊòØË©êÈ®ô",
            "Áõ¥Êé•ÂâçÂæÄÈäÄË°åÂàÜË°åÊàñÈÄèÈÅéÂÆòÊñπÁ∂≤Á´ôÁî≥Ë´ãË≤∏Ê¨æ",
            "‰∏çË¶ÅÈªûÊìä‰∏çÊòé‰æÜÊ∫êÁöÑË≤∏Ê¨æÂª£ÂëäÈÄ£Áµê",
            "‰∏çË¶ÅËºï‰ø°„ÄåÂÖçËÅØÂæµ„ÄÅÂø´ÈÄüÊ†∏Ë≤∏„ÄçÁ≠âÂÆ£ÂÇ≥",
            "‰øùË≠∑ÂÄã‰∫∫Ë≥áÊñôÔºå‰∏çËºïÊòìÊèê‰æõË∫´ÂàÜË≠âÂΩ±Êú¨",
            "ÊúâË≤∏Ê¨æÈúÄÊ±ÇÊáâÂêëÂêàÊ≥ïÈáëËûçÊ©üÊßãË´ÆË©¢",
            "Â∞çÊñºË¶ÅÊ±ÇÂÖàÂåØÊ¨æÊâçËÉΩË≤∏Ê¨æÁöÑÊúçÂãôË¶ÅÁâπÂà•Ë≠¶Ë¶∫",
            "Á¢∫Ë™çË≤∏Ê¨æÊ©üÊßãÊòØÂê¶ÁÇ∫ÈáëÁÆ°ÊúÉÊ†∏ÂáÜÁöÑÂêàÊ≥ïÊ©üÊßã",
            "Ëã•ÊúâÁñëÊÖÆÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "ÂÅáÂª£ÂëäË©êÈ®ô": {
        "description": "ÈÄèÈÅéÁ∂≤Ë∑ØÂπ≥Âè∞ÁôºÂ∏ÉËôõÂÅáÁöÑÂª£ÂëäË≥áË®äÔºåÂ¶ÇÁßüÂ±ã„ÄÅÁ•®Âà∏‰ª£Ë≥º„ÄÅÂ∑•‰ΩúÊ©üÊúÉÁ≠âÔºåË¶ÅÊ±ÇÈ†ê‰ªòË®ÇÈáëÂæåÊ∂àÂ§±",
        "examples": [
            "‰∏ÄÂêçÂ§ßÂ≠∏‰∏âÂπ¥Á¥öÂ≠∏ÁîüÂõ†ÁÇ∫Ê≤íÊúâÊäΩ‰∏≠Â≠∏Ê†°ÂÆøËàçÔºåÂú®FacebookÁöÑÁßüÂ±ãÁâàÁ§æÂúòÁúãÂà∞ÊàøÊù±„ÄåJoyce„ÄçÁôº‰ΩàÁöÑÁßüÂ±ãË®äÊÅØ„ÄÇÁÖßÁâá‰∏≠ÊàøÈñìÂ±ãÊ≥ÅËâØÂ•ΩÔºåÂë®ÈÅ≠ÁîüÊ¥ªÊ©üËÉΩ‰æøÂà©ÔºåÁßüÈáëÂêàÁêÜ‰∏îÂèØÁî≥Ë´ãÁßüÂ±ãË£úÂä©„ÄÇÂ≠∏ÁîüÂä†‰∫ÜÊàøÊù±ÁöÑLINEÔºåÊàøÊù±Ë°®Á§∫Â≠∏ÁîüÊéíÂú®Á¨¨5ÁµÑÁúãÊàøÔºå‰ΩÜÂâçÈù¢Â∑≤ÊúâÂÆ¢‰∫∫ÊâìÁÆóÈ†ê‰ªòË®ÇÈáëÂÑ™ÂÖàÁúãÂ±ã„ÄÇÁÇ∫‰∫ÜÊê∂ÂÖàÁúãÂ±ãÔºåÂ≠∏ÁîüÁ´ãÂç≥ÂåØ‰∫ÜÁßüÈáëÂä†Ë®ÇÈáëÂÖ±3Ëê¨ÂÖÉ„ÄÇ‰πãÂæåÔºåÊàøÊù±ËÅ≤Á®±ÂÖ∂‰∏àÂ§´Ë™§Êî∂‰∫ÜÂÖ∂‰ªñÂÆ¢‰∫∫Ë®ÇÈáëÔºåË´ãÂ≠∏ÁîüÂÖàÂåØÊ¨æÁµ¶ÈÇ£‰ΩçÂÆ¢‰∫∫‰ª•‰øùÁïôÂÑ™ÂÖàÊ¨ä„ÄÇÂ≠∏ÁîüÊèêÂá∫ÈÄÄË≤ªË¶ÅÊ±ÇÂæåÔºåÊàøÊù±Ê∂àÂ§±ÁÑ°Ëπ§„ÄÇ"
        ],
        "sop": [
            "Á∂≤Ë∑ØÁßüÂ±ãÔºåËã•ËÅΩË¶ãÁúãÂ±ãÂÑ™ÂÖàÊ¨äÔºåÊ•µÂèØËÉΩÊòØË©êÈ®ô",
            "Á∂≤Ë∑ØÁßüÂ±ãÊáâÊ¥ΩÊàøÂ±ã‰ª≤‰ªãÂÖ¨Âè∏ÊàñÊ≠£Ë¶èÁßüÂ±ãÁ∂≤Á´ô",
            "Ê≤íÊúâÁúãÂà∞ÊàøÂ±ãÂØ¶È´îÂâçÔºå‰∏çË¶ÅÊîØ‰ªò‰ªª‰ΩïË®ÇÈáëÊàñÁßüÈáë",
            "ÂêàÊ≥ïÁöÑÁßüÂ±ãÊàñÁ•®Âà∏‰∫§Êòì‰∏çÊúÉË¶ÅÊ±ÇÈ†ê‰ªòÊ¨æÈ†Ö",
            "Â∞çÊñºÊÄ•Ëø´Êé®Èä∑„ÄåÈôêÊôÇÂÑ™ÊÉ†„ÄçÁöÑÂª£Âëä‰øùÊåÅË≠¶ÊÉï",
            "Êü•Ë≠âÂª£ÂëäÁôºÂ∏ÉËÄÖÁöÑÁúüÂØ¶Ë∫´‰ªΩÂíåË©ïÂÉπ",
            "‰ΩøÁî®Êúâ‰øùÈöúÁöÑÁ¨¨‰∏âÊñπÊîØ‰ªòÊàñ‰∫§ÊòìÂπ≥Âè∞",
            "Âà©Áî®GoogleÂúñÁâáÊêúÂ∞ãÂäüËÉΩÊü•Ë≠âÁßüÂ±ãÁÖßÁâáÊòØÂê¶ÁÇ∫ÁõúÁî®",
            "Ë´ãË¶™ÂèãÈô™ÂêåÁúãÊàøÔºåÈÅøÂÖçÁç®Ëá™Ê±∫Á≠ñ",
            "Ëã•ÊúâÁñëÊÖÆÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "Ëâ≤ÊÉÖÊáâÂè¨Ë©êË≤°Ë©êÈ®ô": {
        "description": "ÈÄèÈÅéÁ∂≤Ë∑ØÂπ≥Âè∞ÂÆ£ÂÇ≥Ëâ≤ÊÉÖÊúçÂãôÔºåË¶ÅÊ±ÇÊîØ‰ªò„ÄåË®ÇÈáë„Äç„ÄÅ„Äå‰øùË≠âÈáë„ÄçÁ≠âË≤ªÁî®Ôºå‰ΩÜÂØ¶Èöõ‰∏ä‰∏çÊèê‰æõ‰ªª‰ΩïÊúçÂãô",
        "examples": [
            "‰∏ÄÂêçÁî∑ÊÄßÂú®Á§æÁæ§Â™íÈ´î‰∏äÁúãÂà∞ÊüêÁ≤âÂ∞àÊèê‰æõÂ§ñÈÄÅËå∂ÊúçÂãôÁöÑÂª£ÂëäÔºå‰æøÁßÅË®äË©¢Âïè„ÄÇÂ∞çÊñπÊèê‰æõ‰∫ÜÂ§öÂºµÂ•≥ÊÄßÁÖßÁâá‰æõÈÅ∏ÊìáÔºå‰∏¶Ë™™ÊòéÂÉπÊ†ºÂíåÊúçÂãôÂÖßÂÆπ„ÄÇË©≤Áî∑ÊÄßÈÅ∏ÂÆöÂæåÔºåÂ∞çÊñπË°®Á§∫ÈúÄÂÖàÊîØ‰ªò5,000ÂÖÉÁöÑË®ÇÈáëÔºåÊâçÊúÉÂÆâÊéíÂ•≥‰º¥ÂâçÂæÄ„ÄÇÂåØÊ¨æÂæåÔºåÂ∞çÊñπÂèàË°®Á§∫Âõ†ÁÇ∫ÊòØÈ¶ñÊ¨°‰∫§ÊòìÔºåÁÇ∫Á¢∫‰øùÂÆâÂÖ®ÔºåÈúÄÂÜçÊîØ‰ªò5,000ÂÖÉ„Äå‰øùË≠âÈáë„ÄçÔºåÊâøË´æÂ•≥‰º¥ÊäµÈÅîÂæåÂèØÈÄÄÈÇÑ„ÄÇÁî∑ÊÄßÂÜçÊ¨°ÂåØÊ¨æÂæåÔºåÂ∞çÊñπÂèà‰ª•„ÄåËªäË≥á„Äç„ÄÅ„ÄåÂÆâÂÖ®Ê™¢Êü•Ë≤ª„ÄçÁ≠âÁêÜÁî±Ë¶ÅÊ±ÇÈ°çÂ§ñ‰ªòÊ¨æ„ÄÇÊ≠§ÊôÇÁî∑ÊÄßÊÑèË≠òÂà∞ÂèØËÉΩÂèóÈ®ôÔºåÊãíÁµïÂÜç‰ªòÊ¨æ‰∏¶Ë¶ÅÊ±ÇÈÄÄÊ¨æÔºå‰ΩÜÂ∞çÊñπÂ∑≤Â∞áÂÖ∂Â∞ÅÈéñÔºåÁÑ°Ê≥ïËÅØÁπ´„ÄÇ"
        ],
        "sop": [
            "‰ªª‰ΩïË¶ÅÊ±ÇÂÖàÂåØÊ¨æÁöÑËâ≤ÊÉÖÊúçÂãôÂª£ÂëäÔºåÂπæ‰πéÈÉΩÊòØË©êÈ®ô",
            "‰∏çË¶ÅÁõ∏‰ø°Á∂≤Ë∑Ø‰∏äÈôåÁîü‰∫∫Êèê‰æõÁöÑËâ≤ÊÉÖÊúçÂãô",
            "ÈÅøÂÖçÂú®‰∏çÊòé‰æÜÊ∫êÁöÑÁ∂≤Á´ôÊàñÁ§æÁæ§Â™íÈ´î‰∏äÂ∞ãÊâæÊ≠§È°ûÊúçÂãô",
            "‰øùË≠∑ÂÄã‰∫∫Ë≥áÊñôÔºåÈÅøÂÖçË∫´‰ªΩË¢´ÁõúÁî®ÊàñÈÅ≠ÂãíÁ¥¢",
            "‰∏çË¶ÅËºï‰ø°‰∏çÂêàÁêÜÁöÑÊî∂Ë≤ªÊñπÂºèÊàñÁêÜÁî±",
            "Â∞çÊñºÂèçË¶ÜË¶ÅÊ±Ç„ÄåÈ°çÂ§ñË≤ªÁî®„ÄçÁöÑË°åÁÇ∫ÊèêÈ´òË≠¶Ë¶∫",
            "Ëâ≤ÊÉÖ‰∫§ÊòìÂú®Âè∞ÁÅ£ÊòØÈÅïÊ≥ïÁöÑÔºåÂèØËÉΩÈù¢Ëá®Ê≥ïÂæãÈ¢®Èö™",
            "Ëã•Â∑≤ÈÅ≠Ë©êÈ®ôÔºåÊáâ‰øùÁïôÊâÄÊúâÈÄöË®äË®òÈåÑ‰ΩúÁÇ∫Ë≠âÊìö",
            "Ëã•ÊúâÁñëÊÖÆÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "ËôõÊì¨ÈÅäÊà≤Ë©êÈ®ô": {
        "description": "ÈÄèÈÅéÈÅäÊà≤ÂÖßËÅäÂ§©ÊàñÁ§æÁæ§Â™íÈ´îÊé•Ëß∏Áé©ÂÆ∂ÔºåÊèê‰æõËôõÂÅáÁöÑÈÅäÊà≤ÈªûÊï∏„ÄÅÂ§ñÊéõÊàñÊúçÂãôÔºåÈ®ôÂèñÈáëÈå¢ÊàñÂ∏≥Ëôü",
        "examples": [
            "‰∏ÄÂêçÈ´ò‰∏≠ÁîüÂú®ÊüêÁ∑ö‰∏äÈÅäÊà≤‰∏≠Ë™çË≠ò‰∏Ä‰Ωç„ÄåË≥áÊ∑±Áé©ÂÆ∂„ÄçÔºåÂ∞çÊñπË°®Á§∫ÂèØ‰ª•Âπ´Âøô‰ª£Ë≥ºÈÅäÊà≤ÈªûÊï∏ÔºåÂè™ÈúÄË¶ÅÂ∏ÇÂÉπÁöÑ‰∏ÉÊäò„ÄÇÈ´ò‰∏≠ÁîüÂøÉÂãï‰∏çÂ∑≤ÔºåÂÖàÂæåÂåØ‰∫Ü3,000ÂÖÉË≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏„ÄÇ‰∫§ÊòìÈ†ÜÂà©ÂæåÔºå„ÄåË≥áÊ∑±Áé©ÂÆ∂„ÄçÂèàÊé®Ëñ¶‰∏ÄÂÄãËÉΩÊèêÂçáËßíËâ≤ËÉΩÂäõÁöÑÂ§ñÊéõÁ®ãÂºèÔºåËÅ≤Á®±Âè™Ë¶ÅÂÆâË£ùÂ∞±ËÉΩÁç≤ÂæóÈÅäÊà≤ÂÑ™Âã¢„ÄÇÈ´ò‰∏≠Áîü‰∏ãËºâÂÆâË£ù‰∫ÜË©≤Á®ãÂºèÔºå‰∏ç‰πÖÂæåÁôºÁèæÈÅäÊà≤Â∏≥ËôüË¢´ÁõúÔºåÊâÄÊúâËôõÊì¨Áâ©ÂìÅË¢´ËΩâÁßªÔºå‰∏îË©≤Á®ãÂºèÈÇÑÁ´äÂèñ‰∫Ü‰ªñÈõªËÖ¶‰∏≠ÁöÑÂÄã‰∫∫Ë≥áÊñôÔºåÂ∞éËá¥ÂÖ∂Áà∂ÊØçÁöÑÈäÄË°åÂ∏≥Êà∂ÈÅ≠ÁõúÂà∑„ÄÇ"
        ],
        "sop": [
            "Âè™ÈÄèÈÅéÈÅäÊà≤ÂÆòÊñπÁÆ°ÈÅìË≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏ÊàñÁâ©ÂìÅ",
            "‰∏çË¶Å‰∏ãËºâ‰æÜË∑Ø‰∏çÊòéÁöÑÂ§ñÊéõÊàñ‰øÆÊîπÁ®ãÂºè",
            "‰øùË≠∑ÈÅäÊà≤Â∏≥ËôüÂØÜÁ¢ºÔºå‰∏çÈö®ÊÑèÊèê‰æõÁµ¶‰ªñ‰∫∫",
            "ÂÉπÊ†ºÊòéÈ°Ø‰ΩéÊñºÂ∏ÇÂ†¥ÁöÑ‰∫§ÊòìÂ§öÁÇ∫Ë©êÈ®ô",
            "‰∏çË¶ÅÁõ∏‰ø°ÂèØ‰ª•Á†¥Ëß£ÈÅäÊà≤Á≥ªÁµ±ÁöÑË™™Ê≥ï",
            "ÈÅäÊà≤ÂÖß‰∫§ÂèãÈúÄË¨πÊÖéÔºå‰∏çËºïÊòìÈÄèÈú≤ÂÄã‰∫∫Ë≥áË®ä",
            "‰ΩøÁî®ÈõôÈáçË™çË≠â‰øùË≠∑ÈáçË¶ÅÈÅäÊà≤Â∏≥Ëôü",
            "ÂÆöÊúüÊõ¥ÊèõÂØÜÁ¢º‰∏¶Ê™¢Êü•Â∏≥ËôüÂÆâÂÖ®Ë®≠ÁΩÆ",
            "‰∏çË¶Å‰ΩøÁî®ËàáÂÖ∂‰ªñÂπ≥Âè∞Áõ∏ÂêåÁöÑÂØÜÁ¢º",
            "Ëã•ÊúâÁñëÊÖÆÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "ÂÅáÊ±ÇËÅ∑Ë©êÈ®ô": {
        "description": "‰ª•ËôõÂÅáÂ∑•‰ΩúÊ©üÊúÉÁÇ∫Ë™òÈ§åÔºåÈ®ôÂèñÂÄã‰∫∫ÈäÄË°åÂ∏≥Êà∂ÊàñÈáëËûçÂç°ÁöÑË©êÈ®ô",
        "examples": [
            "‰∏ÄÂêçËàûËÄÖÂú®Á§æÁæ§Âπ≥Âè∞ÂàÜ‰∫´Ëá™Â∑±ÁöÑË°®ÊºîÂΩ±ÁâáÔºåÊî∂Âà∞Á∂≤Âèã„ÄåÂØßÈùúËá¥ÈÅ†„ÄçÁßÅË®äÔºåË°®Á§∫Ê¨£Ë≥ûÂÖ∂ËàûËπàÈ¢®Ê†ºÔºåÈÇÄË´ãÂèÉÂä†ÁßÅ‰∫∫ËÅöÊúÉË°®Êºî„ÄÇÈõôÊñπËΩâËá≥LINEÊ∫ùÈÄöÔºåÂ∞çÊñπ‰ª•ÊîØ‰ªòË®ÇÈáëÁÇ∫Áî±ÔºåË¶ÅÊ±ÇÊèê‰æõÈäÄË°åÂ∏≥Êà∂„ÄÇÊ≠§ÂæåÔºåÂ∞çÊñπÂ§±ËÅØÔºå‰ΩÜÂèóÂÆ≥ËÄÖÂ∏≥Êà∂Èô∏Á∫åÊúâ‰∏çÊòéÊ¨æÈ†ÖÂåØÂÖ•„ÄÇÊúÄÁµÇË¢´ÂëäÁü•Â∏≥Êà∂Â∑≤Ë¢´ÂàóÁÇ∫Ë≠¶Á§∫Â∏≥Êà∂ÔºåË≠¶ÊñπË™øÊü•ÁôºÁèæÈÄô‰∫õÊ¨æÈ†ÖÊ∂âÂèäÂÖ∂‰ªñË©êÈ®ôÊ°à‰ª∂ÔºåÂèóÂÆ≥ËÄÖÁöÑÂ∏≥Êà∂Ë¢´Áî®‰æÜÊ¥óÈå¢„ÄÇ"
        ],
        "sop": [
            "‰∏çË¶ÅÊèê‰æõÈäÄË°åÂ∏≥Êà∂Ë≥áÊñôÁµ¶ÈôåÁîü‰∫∫",
            "Â∏≥Êà∂Êúâ‰∏çÊòéÂåØÂÖ•Ê¨æÈ†ÖÔºåË´ãËÅØÁπ´ÈñãÊà∂ÈäÄË°å‰∏¶Á´ãÂç≥Â†±Ë≠¶",
            "Â∞çÊñºÈ´òËñ™„ÄÅ‰ΩéÈñÄÊ™ªÁöÑÂ∑•‰ΩúÈÇÄÁ¥Ñ‰øùÊåÅË≠¶Ë¶∫",
            "‰∏çË¶ÅËºïÊòìÁõ∏‰ø°ÂèØ‰ª•Âø´ÈÄüË≥∫Èå¢ÁöÑÂ∑•‰ΩúÊ©üÊúÉ",
            "‰∏çË¶ÅÂØÑÂá∫ÈáëËûçÂç°„ÄÅÊèêÊ¨æÂç°ÊàñÂ≠òÁ∞øÁµ¶‰ªñ‰∫∫",
            "‰∏çË¶ÅÂ∞áÂç°ÁâáÊîæÁΩÆÊñºÊåáÂÆöÁΩÆÁâ©Ê´É„ÄÅÈÉµÁÆ±‰æõ‰ªñ‰∫∫Êî∂Âèñ",
            "ÈÅøÂÖçÂçîÂä©‰ªñ‰∫∫Êìç‰ΩúATMÊàñÁ∂≤Ë∑ØÈäÄË°å",
            "Â∑•‰ΩúÂÖßÂÆπËã•Ê∂âÂèäÈáëËûç‰∫§ÊòìÊàñËΩâÂ∏≥ÔºåÂ§öÂçäÊòØË©êÈ®ô",
            "ÂæµÊâçÁÆ°ÈÅìÊáâ‰ª•Ê≠£Ë¶èÊ±ÇËÅ∑Âπ≥Âè∞ÁÇ∫‰∏ª",
            "Êúâ‰ªª‰ΩïÁñëÂïèÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öË´ÆË©¢"
        ]
    },
    "ÂÅáÊ™¢Ë≠¶Ë©êÈ®ô": {
        "description": "ÂÜíÂÖÖÂü∑Ê≥ïÊ©üÈóú‰∫∫Âì°ÔºàË≠¶ÂØü„ÄÅÊ™¢ÂØüÂÆò„ÄÅÊ≥ïÂÆòÁ≠âÔºâÈÄ≤Ë°åË©êÈ®ôÔºå‰ª•„ÄåË≠â‰ª∂ÈÅ≠ÂÜíÁî®„Äç„ÄÅ„ÄåÊ∂âÂèäÂàëÊ°à„ÄçÁ≠âËóâÂè£ÔºåË™òÂ∞éË¢´ÂÆ≥‰∫∫Êèê‰æõÈáëËûçË≥áË®äÊàñÂåØÊ¨æ",
        "examples": [
            "Ê∞ëÁúæÂ∞èÂäâÊé•Áç≤ÂÅáÂÜíÈ¶¨ÂÅïÈÜ´Èô¢‰∫∫Âì°ÈõªË©±ÔºåÂ∞çÊñπ‰ΩØÁ®±Êúâ‰∫∫ÊåÅÂ∞èÂäâË≠â‰ª∂‰ª£È†òÁÆ°Âà∂Ëó•ÂìÅÔºåÈúÄË¶ÅÊ†∏ÂØ¶Ë∫´ÂàÜ„ÄÇÁï∂Â∞èÂäâÂê¶Ë™çÊúâÂßîË®ó‰ª£È†òËó•ÂìÅ‰∏Ä‰∫ãÔºåÂÅáÂÜíÈÜ´Èô¢‰∫∫Âì°Èö®Âç≥ÂëäÁü•Â∞áÁî±Ê™¢Ë≠¶Êé•Êâã„ÄÇÈö®ÂæåÂÅáÂÜíË≠¶ÂØü„ÄÅÊ™¢ÂØüÂÆòÊé•ÈÄ£‰æÜÈõªÔºåÁæÖÁπîÁΩ™ÂêçÂæåÔºåË¶ÅÊ±ÇÂ∞èÂäâ‰∫§‰ªòÈáëËûçÂç°ËàáÂ∏≥Êà∂Ë≥áÊñô„ÄÇÂπ∏Â•ΩÂ∞èÂäâ‰øùÊåÅË≠¶Ë¶∫Ôºå‰∫ãÂæåÁ´ãÂç≥ÈÄöÂ†±165Ê™¢Ëàâ„ÄÇÊ≠§Ê°àËàáËøëÊúüÈÜ´ÁôÇÈô¢ÊâÄÁóÖÊÇ£ÂÄãË≥áÂ§ñÊ¥©ÊúâÈóúÔºåË©êÈ®ôÈõÜÂúòÂèØËÉΩÂèñÂæóÈÄô‰∫õÂ§ñÊ¥©ÂÄãË≥áÔºåÈÄ≤Ë°åÁ≤æÊ∫ñË©êÈ®ô„ÄÇ"
        ],
        "sop": [
            "Ê™¢Ë≠¶‰∏çÊúÉÁî®ÈõªË©±ÈÄöÁü•Ê∂âÊ°àÔºåÊúÉ‰ª•ÂÖ¨ÊñáÂÇ≥Âñö",
            "Ê™¢Ë≠¶‰∏çÊúÉË¶ÅÊ±ÇÊèê‰æõÈáëËûçÂ∏≥Êà∂„ÄÅÂ≠òÊë∫ÊàñÈáëËûçÂç°",
            "Ê™¢Ë≠¶‰∏çÊúÉË¶ÅÊ±ÇËß£Èô§ÂàÜÊúü‰ªòÊ¨æ",
            "Ê™¢Ë≠¶‰∏çÊúÉÁõ£ÁÆ°ÈäÄË°åÂ∏≥Êà∂ÊàñÊìç‰ΩúATM",
            "Ê™¢Ë≠¶‰∏çÊúÉË¶ÅÊ±Ç‰∫§‰ªòÁèæÈáëÊàñÂåØÊ¨æ",
            "Ê™¢Ë≠¶‰∏çÊúÉÁî®LINEË£Ω‰ΩúÁ≠ÜÈåÑ",
            "Ê™¢Ë≠¶‰∏çÊúÉ‰ª•ÈõªË©±ÂÇ≥ÈÄÅÂÖ¨Êñá",
            "Êé•Âà∞ÂèØÁñë‰æÜÈõªÔºåÊéõÊñ∑‰∏¶Êí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öÊü•Ë≠â",
            "Â∞ç‰æÜÈõªÈ°ØÁ§∫110ÊàñÊ¥æÂá∫ÊâÄÈõªË©±‰øùÊåÅÊá∑ÁñëÔºåÈÄô‰∫õËôüÁ¢ºÂèØËÉΩË¢´ÂÅΩÈÄ†",
            "ÈÜ´Èô¢Áµï‰∏çÊúÉËΩâÊé•Ê™¢Ë≠¶ËôïÁêÜÂÜíÁî®Ë∫´ÂàÜÊàñ‰ª£È†òËó•ÂìÅ‰∫ãÂÆú",
            "‰∏çÈÄèÈú≤ÂÄã‰∫∫Ë≥áË®äÔºå‰∏çÈªûÊìä‰∏çÊòéÈÄ£ÁµêÔºå‰∏çËºïÊòìÂåØÊ¨æ"
        ]
    },
    "ÈáëËûçÂ∏≥Êà∂Ë©êÈ®ô": {
        "description": "ÈÄèÈÅéÂêÑÁ®ÆÊâãÊÆµÈ®ôÂèñÊ∞ëÁúæÈáëËûçÂ∏≥Êà∂„ÄÅÈáëËûçÂç°ÊàñÁ∂≤Ë∑ØÈäÄË°åÂØÜÁ¢ºÔºåÁî®ÊñºÈùûÊ≥ï‰∫§ÊòìÊàñÊ¥óÈå¢",
        "examples": [
            "ÂèóÂÆ≥ËÄÖÁúãÂà∞‰∏ÄÂâá„ÄåÂá∫ÁßüÈáëËûçÂ∏≥Êà∂ÔºåËºïÈ¨ÜË≥∫ÁßüÈáë„ÄçÁöÑÂª£ÂëäÂæåÂøÉÂãïÔºåËàáÂ∞çÊñπËÅØÁπ´‰∏¶ÊåâÊåáÁ§∫Â∞áÊèêÊ¨æÂç°ÂíåÂ∏≥Êà∂Ë≥áË®äÊîæÁΩÆÂú®ÊåáÂÆöÁöÑËÆäÈõªÁÆ±‰∏≠„ÄÇË©êÈ®ôËÄÖÂèñÂæóÂ∏≥Êà∂ÊéßÂà∂Ê¨äÂæåÈÄ≤Ë°åÂ§ßÈáèÈùûÊ≥ï‰∫§ÊòìÔºåÂ∞éËá¥Â∏≥Êà∂Ë¢´ÈäÄË°åÂáçÁµêÔºåÂèóÂÆ≥ËÄÖ‰∏çÂÉÖÊú™ÂæóÂà∞ÊâøË´æÁöÑÁßüÈáëÔºåÈÇÑÈù¢Ëá®Ê≥ïÂæãËøΩË®¥È¢®Èö™„ÄÇ"
        ],
        "sop": [
            "Â∏≥Êà∂„ÄÅÊèêÊ¨æÂç°ÂèäÂØÜÁ¢ºÊòØÂÄã‰∫∫Ë≤°ÂãôÂÆâÂÖ®Ê†∏ÂøÉÔºåÂàáÂãøÂá∫ÁßüÊàñ‰∫§‰∫à‰ªñ‰∫∫",
            "‰ªª‰ΩïËÅ≤Á®±Âá∫ÁßüÂ∏≥Êà∂ÂèØË≥∫Èå¢ÁöÑÂª£ÂëäÔºåÈÉΩÊòØË©êÈ®ô",
            "‰∏çË¶ÅÂèóÈ´òÂ†±ÈÖ¨Ë™òÊÉëÂá∫ÂÄüÈáëËûçÂ∏≥Êà∂",
            "‰∏çË¶ÅËºï‰ø°ÂèØËºïÈ¨ÜË≥∫ÂèñÈ°çÂ§ñÊî∂ÂÖ•ÁöÑÂª£Âëä",
            "ÈäÄË°åÂÆ¢Êúç‰∏çÊúÉË¶ÅÊ±ÇÊèê‰æõÂÆåÊï¥Âç°ËôüÊàñÂØÜÁ¢º",
            "ÁôºÁèæÂ∏≥Êà∂ÊúâÁï∞Â∏∏Ê¥ªÂãïÔºåÊáâÁ´ãÂç≥ËÅØÁπ´ÈäÄË°åÊàñÊí•Êâì165Â∞àÁ∑ö",
            "‰∏çË¶ÅÂú®Êú™Á∂ìÁ¢∫Ë™çÁöÑÁ∂≤Á´ôËº∏ÂÖ•ÈáëËûçË≥áË®ä",
            "‰øùË≠∑ÂÄã‰∫∫ÈáëËûçË≥áË®äÔºå‰∏çË¶ÅÂêëÈôåÁîü‰∫∫ÈÄèÈú≤"
        ]
    },
    "Èá£È≠öÁ∞°Ë®äË©êÈ®ô": {
        "description": "ÈÄèÈÅéÂÅΩË£ùÊàêÂÆòÊñπÊ©üÊßãÊàñÁü•Âêç‰ºÅÊ•≠ÁöÑË®äÊÅØÔºåË™òÂ∞éÈªûÊìäÊÉ°ÊÑèÈÄ£ÁµêÔºåÈ®ôÂèñÂÄã‰∫∫Ë≥áÊñôÊàñÈáëËûçË≥áË®ä",
        "examples": [
            "Ê∞ëÁúæÂ∞èÂºµÊî∂Âà∞‰∏ÄÂâáËÅ≤Á®±‰æÜËá™‰∏≠ËèØÈõª‰ø°ÁöÑÁ∞°Ë®äÔºåÂÖßÂÆπÁÇ∫Ôºö„Äå[‰∏≠ËèØÈõª‰ø°]ÊÇ®Ê≠£Âú®Áî≥Ë´ãÁöÑÁ∂≤Ë∑ØÊúçÂãôÂõ†ÂÄãË≥áÈ©óË≠âÂ§±ÊïóÔºåË´ãÈªûÊìä‰∏ãÊñπÈÄ£ÁµêÈáçÊñ∞Ë£úÈ©ó...„ÄçÔºå‰∏¶ÈôÑ‰∏ä‰∏Ä‰∏≤Áü≠Á∂≤ÂùÄ„ÄÇÂ∞èÂºµ‰∏ÄÊôÇ‰∏çÂØüÈªûÊìäÈÄ£ÁµêÔºåÈÄ≤ÂÖ•‰∏ÄÂÄãËàá‰∏≠ËèØÈõª‰ø°ÂÆòÁ∂≤Ê•µÁÇ∫Áõ∏‰ººÁöÑÈ†ÅÈù¢Ôºå‰∏¶‰æùÁÖßÊåáÁ§∫Ëº∏ÂÖ•‰∫ÜË∫´ÂàÜË≠âÂ≠óËôü„ÄÅÈäÄË°åÂ∏≥ËôüÂèä‰ø°Áî®Âç°Ë≥áË®ä„ÄÇ‰∏ç‰πÖÂæåÔºå‰ªñ‰æøÊî∂Âà∞ÈäÄË°åÈÄöÁü•ÊúâÂ§öÁ≠Ü‰∏çÊòéÊ∂àË≤ªÔºåÊâçÈ©öË¶∫ÂèóÈ®ô„ÄÇ"
        ],
        "sop": [
            "Êî∂Âà∞‰ªª‰ΩïË¶ÅÊ±ÇÈªûÊìäÈÄ£Áµê‰∏¶Ëº∏ÂÖ•ÂÄã‰∫∫Ë≥áÊñôÁöÑÁ∞°Ë®äÔºåÂãôÂøÖÊèêÈ´òË≠¶Ë¶∫„ÄÇ",
            "‰∏çË¶ÅÈªûÊìä‰æÜÊ∫ê‰∏çÊòéÁöÑÁ∞°Ë®äÈÄ£Áµê„ÄÇ",
            "ÂÆòÊñπÊ©üÊßã‰∏çÊúÉÈÄèÈÅéÁ∞°Ë®äË¶ÅÊ±ÇÊ∞ëÁúæËº∏ÂÖ•ÊïèÊÑüÂÄãË≥áÊàñÈäÄË°åÂ∏≥Êà∂Ë≥áË®ä„ÄÇ",
            "‰ªîÁ¥∞Ê™¢Êü•Á∂≤ÂùÄÊòØÂê¶ÁÇ∫ÂÆòÊñπÁ∂≤ÂùÄÔºåÈá£È≠öÁ∂≤Á´ôÈÄöÂ∏∏ÊúÉÊúâÁ¥∞ÂæÆÂ∑ÆÁï∞„ÄÇ",
            "ÈñãÂïüÁ∞°Ë®äÂØ¶ËÅØÂà∂Ôºå‰∏¶Á¢∫Ë™çÁôºÈÄÅËôüÁ¢ºÊòØÂê¶ÁÇ∫ÂÆòÊñπËôüÁ¢º„ÄÇ",
            "Ëã•‰∏çÁ¢∫ÂÆöÁ∞°Ë®äÁúüÂÅΩÔºåÊáâÁõ¥Êé•ÂêëÂÆòÊñπÂÆ¢ÊúçÊü•Ë≠âÔºåËÄåÈùûÈªûÊìäÁ∞°Ë®ä‰∏≠ÈÄ£Áµê„ÄÇ",
            "ÂÆâË£ùÈò≤ÊØíËªüÈ´î‰∏¶ÂÆöÊúüÊõ¥Êñ∞ÔºåÂèØÂçîÂä©ÂÅµÊ∏¨ÊÉ°ÊÑèÁ∂≤Á´ô„ÄÇ",
            "ÊïôËÇ≤ÂÆ∂‰∏≠Èï∑Ëº©Ë≠òÂà•Èá£È≠öÁ∞°Ë®äÁöÑÊäÄÂ∑ß„ÄÇ",
            "Ëã•Â∑≤ÈªûÊìä‰∏¶Ëº∏ÂÖ•Ë≥áÊñôÔºåÊáâÁ´ãÂç≥ËÅØÁπ´ÈäÄË°åÂÅúÂç°‰∏¶Â†±Ë≠¶ËôïÁêÜ„ÄÇ"
        ]
    },
    "ÈªûÊï∏Ë≥ºË≤∑Ë©êÈ®ô": {
        "description": "Ë¶ÅÊ±ÇË¢´ÂÆ≥‰∫∫Ë≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏„ÄÅÁ¶ÆÂìÅÂç°Á≠âÔºå‰∏¶Êèê‰æõÂÖ∂Â∫èËôüÊàñÂØÜÁ¢ºÁöÑË©êÈ®ôÊâãÊ≥ï",
        "examples": [
            "üéÆ ËôõÊì¨ÂØ∂Áâ©ÊèõÁèæÈáëÁöÑÈ®ôÂ±Ä üéÆ\n\nÊàëÂú®„ÄäÁÜ±Ë°ÄÊ±üÊπñ„ÄãÈÅäÊà≤ÊâìÂà∞‰∫Ü‰∏Ä‰ª∂Áõ∏Áï∂Á®ÄÊúâÁΩïË¶ãÁöÑÂØ∂Áâ©ÔºåÂú®ÈÅäÊà≤ÂúàÂÖßÂê∏Âºï‰∫Ü‰∏çÂ∞ëÁé©ÂÆ∂ÁöÑÊ≥®ÊÑèÔºåÊúâ‰∏Ä‰ΩçÈÅäÊà≤Êö±Á®±„ÄåÊûóÂåóÂ∞èËàû„ÄçÁöÑÂ•ΩÂèãÁßÅË®äÊàëÔºåË™™‰ªñÂæàÊÉ≥Êî∂Ë≥ºÊàëÁöÑÂØ∂Áâ©„ÄÇ‰ªñË°®Á§∫ÂØ∂Áâ©Â∞ç‰ªñÁµÑË£ùË£ùÂÇôÈùûÂ∏∏ÈáçË¶ÅÔºåÈ°òÊÑè‰ª•8,500ÂÖÉÂÉπÊ†ºË≥ºÂÖ•„ÄÇÂõ†ÁÇ∫‰πãÂâçÊàëÂÄëÊõæÁµÑÈöäËÅäÈÅéÂ•ΩÂπæÊ¨°ÔºåÂ∞çÊñπÁúãËµ∑‰æÜ‰∏çÂÉèÈ®ôÂ≠êÔºåÊàë‰æøÁ≠îÊáâÂá∫ÂîÆÂØ∂Áâ©„ÄÇ\n\n‰∏çÈÅéÔºåÂ∞çÊñπË™™ÊúàÂ∫ïÊâçÈ†òËñ™Ê∞¥ÔºåÁÑ°Ê≥ïÈ¶¨‰∏ä‰ªòÊ¨æÔºåËÉΩÂê¶ÂÖà‰∫§‰ªòÂØ∂Áâ©ËÆì‰ªñÊèêÂâçÂ¢ûÂº∑Ë£ùÂÇôÔºåÁ≠âÂà∞ÊúàÂ∫ïÈ†òËñ™ÂæåÂÜçÂåØÊ¨æ„ÄÇÊàëÂøÉÊÉ≥ÔºåÂ§ßÂÆ∂ÈÉΩÊòØÂêå‰∏ÄÂÄãÈÅäÊà≤ÂÖ¨ÊúÉÁöÑËÄÅÁé©ÂÆ∂ÔºåÊúâ‰∏ÄÂÆöÁöÑ‰ø°‰ªªÂü∫Á§éÔºåÊ≤íÂ§öÊÉ≥Â∞±ÊääÂØ∂Áâ©‰∫§Áµ¶‰∫Ü‰ªñ„ÄÇ\n\n‰πãÂæåÔºåÊàëÂíå„ÄåÊûóÂåóÂ∞èËàû„Äç‰æùËàäÊØèÂ§©Âú®ÈÅäÊà≤‰∏≠‰∫íÂãïÔºå‰ªñË™áËÆöÊàëÈÇ£‰ª∂ÂØ∂Áâ©Âπ´‰∫Ü‰ªñÂ§ßÂøôÔºåËÆì‰ªñÂú®ÈÅäÊà≤‰∏≠Â¶ÇËôéÊ∑ªÁøº„ÄÇÁÑ∂ËÄåÔºåÂà∞‰∫ÜÁ¥ÑÂÆö‰ªòÊ¨æÊó•ÊúüÔºåÊàëÂçªÂßãÁµÇÊ≤íÊî∂Âà∞‰ªñÁöÑÂåØÊ¨æÊ∂àÊÅØ„ÄÇÂâõÈñãÂßãÔºåÊàëÊèêÈÜí‰ªñÂπæÊ¨°Ôºå‰ªñÁ∏ΩÊòØÂêÑÁ®ÆÁêÜÁî±Êé®ËÑ´ÔºåË¶ÅÂòõËñ™Ê∞¥Âª∂ÈÅ≤ÁôºÊîæ„ÄÅË¶ÅÂòõÂÆ∂Ë£°Ëá®ÊôÇÊúâÊÄ•Áî®ÔºåÁï¢Á´üÊàëÂÄë‰πüÁÆóÊòØÊúãÂèãÔºåÂ∞±ÂÜçÂØ¨ÈôêÂπæÂ§©Âêß„ÄÇ\n\nÊúâÂ§©ÔºåÊàëÁôºÁèæ‰ªñ‰∏çÂÜçÂõûÊàëË®äÊÅØÔºåÈÄ£ÈÅäÊà≤ËßíËâ≤‰πüÊ∂àÂ§±ÂæóÁÑ°ÂΩ±ÁÑ°Ëπ§ÔºåÊàëÈÄôÊâçÈ©öË¶∫ÔºåËá™Â∑±Ë¢´È®ô‰∫ÜÔºÅ\n\nüìä Ë≥áÊñô‰æÜÊ∫êÔºö165ÊâìË©êÂÑÄË°®Êùø"
        ],
        "sop": [
            "‚ö†Ô∏è Â∏∏Ë¶ãÁäØÁΩ™ÊâãÊ≥ïÂèäË©±Ë°ì ‚ö†Ô∏è",
            "1Ô∏è‚É£ ÈõôÊñπÁ¥ÑÂÆö‰∫§ÊòìÈÅäÊà≤Â∏≥Ëôü/ÈÅäÊà≤Ë£ùÂÇô/ÈªûÊï∏",
            "2Ô∏è‚É£ Ë¶ÅÊ±ÇËá≥ÈÅäÊà≤‰∫§ÊòìÂπ≥Âè∞Á∂≤Á´ô‰∫§ÊòìÔºåÂçªË¢´Á∂≤Á´ôÂëäÁü•Â∏≥Êà∂Âá∫ÈåØË¶ÅÊ±ÇÂÑ≤ÂÄºÊâçËÉΩÈÄÄÊ¨æ",
            "3Ô∏è‚É£ Â∞çÊñπÁ®±‰∏çÊòéÂéüÂõ†ÁÑ°Ê≥ï‰∫§ÊòìÂÇ≥ÈÄÅ‰∏ÄÂúãÈöõÊìî‰øùÂπ≥Âè∞‰∫§ÊòìÈÄ£ÁµêÔºåÂπ≥Âè∞ÂÆ¢ÊúçÁ®±Â∏≥Êà∂ÂáçÁµêÔºåÈúÄÂÑ≤ÂÄºÊâçËÉΩËß£Âáç",
            "4Ô∏è‚É£ Ë¶ÅÊ±ÇÂåØÊ¨æËá≥ÊåáÂÆöÂ∏≥Êà∂ÂÑ≤ÂÄº",
            "5Ô∏è‚É£ Ë¶ÅÊ±ÇË≥ºË≤∑ÈªûÊï∏Âç°ÂæåÊãçÁÖß",
            "",
            "üõ°Ô∏è Èò≤Ë©êÂ∞èÊíáÊ≠• üõ°Ô∏è",
            "ËôõÊì¨ÂØ∂Áâ©‰∫§ÊòìÔºåÊáâÈÅ∏ÊìáÂÆòÊñπË™çÂèØÁöÑÁ¨¨‰∏âÊñπÂπ≥Âè∞ÔºåÊâçÊúâ‰øùÈöú„ÄÇ",
            "",
            "üîç Ë©êÈ®ôË©±Ë°ìËß£Êûê üîç",
            "1. ËôõÊì¨ÈÅäÊà≤Â•ΩÂèãË°®ÈÅîË≥ºË≤∑ËôõÊì¨ÂØ∂Áâ©ÊÑèÈ°ò",
            "2. Ë™òÈ®ôÊèêÂâç‰∫§‰ªòËôõÊì¨ÂØ∂Áâ©ÔºåÂçªËóâÊïÖÂª∂ÈÅ≤‰ªòÊ¨æÔºå‰∏¶Â§±ËÅØ"
        ]
    }
}

# Âä†ËºâË©êÈ®ôË©±Ë°ìË≥áÊñôÂ∫´ (ÂèØÈÅ∏)
FRAUD_TACTICS_DB = "fraud_tactics.json"
fraud_tactics_data = {}

def load_fraud_tactics():
    global fraud_tactics_data
    try:
        with open(FRAUD_TACTICS_DB, 'r', encoding='utf-8') as f:
            fraud_tactics_data = json.load(f)
        logger.info(f"ÊàêÂäüÂæû {FRAUD_TACTICS_DB} Âä†ËºâË©êÈ®ôË©±Ë°ìÊï∏Êìö")
    except FileNotFoundError:
        logger.warning(f"Ë©êÈ®ôË©±Ë°ìÊñá‰ª∂ {FRAUD_TACTICS_DB} Êú™ÊâæÂà∞„ÄÇ")
        fraud_tactics_data = {} # Ensure it's an empty dict if file not found
    except json.JSONDecodeError:
        logger.error(f"Ëß£ÊûêË©êÈ®ôË©±Ë°ìÊñá‰ª∂ {FRAUD_TACTICS_DB} Â§±Êïó„ÄÇ")
        fraud_tactics_data = {} # Ensure it's an empty dict on parse error
    except Exception as e:
        logger.error(f"Âä†ËºâË©êÈ®ôË©±Ë°ìÊôÇÁôºÁîüÊú™Áü•ÈåØË™§: {e}")
        fraud_tactics_data = {}

load_fraud_tactics()

# Ë©êÈ®ôË©±Ë°ìË≥áÊñôÂ∫´
fraud_tactics = fraud_tactics_data

# Áç≤ÂèñÁî®Êà∂ÂÄã‰∫∫Ë≥áÊñô
def get_user_profile(user_id):
    try:
        profile = line_bot_api.get_profile(user_id)
        return profile
    except Exception as e:
        logger.error(f"Áç≤ÂèñÁî®Êà∂ {user_id} ÂÄã‰∫∫Ë≥áÊñôÂ§±Êïó: {e}")
        return None

# ÂàÜÊûêË©êÈ®ôÈ¢®Èö™‰∏¶Ëß£ÊûêÁµêÊûú
def parse_fraud_analysis(analysis_result):
    """
    ÂæûChatGPTÁöÑÂõûÊáâ‰∏≠Ëß£ÊûêÂá∫Ë©êÈ®ôÂàÜÊûêÁµêÊûú„ÄÇ
    È†êÊúüÊ†ºÂºèÔºö
    È¢®Èö™Á≠âÁ¥öÔºö[È´ò/‰∏≠/‰Ωé/ÁÑ°È¢®Èö™/‰∏çÁ¢∫ÂÆö]
    ÂèØËÉΩË©êÈ®ôÈ°ûÂûãÔºö[È°ûÂûã1, È°ûÂûã2, ... Êàñ ‰∏çÈÅ©Áî®]
    Ë™™ÊòéÔºö[ÂÖ∑È´îË™™Êòé]
    Âª∫Ë≠∞Ôºö[ÂÖ∑È´îÂª∫Ë≠∞] 
    Êñ∞ËààÊâãÊ≥ïÔºö[ÊòØ/Âê¶] (ÂèØÈÅ∏)
    """
    if not analysis_result:
        return {
            "risk_level": "‰∏çÁ¢∫ÂÆö",
            "fraud_type": "Êú™Áü•",
            "explanation": "ÁÑ°Ê≥ïÁç≤ÂèñÂàÜÊûêÁµêÊûú„ÄÇ",
            "suggestions": "Ë´ãÁ®çÂæåÂÜçË©¶ÊàñËÅØÁπ´ÂÆ¢Êúç„ÄÇ",
            "is_emerging": False
        }

    lines = analysis_result.strip().split('\n')
    result = {
        "risk_level": "‰∏çÁ¢∫ÂÆö",
        "fraud_type": "Êú™Áü•",
        "explanation": analysis_result, # Default to full analysis if parsing fails for explanation
        "suggestions": "Ë´ã‰øùÊåÅË≠¶ÊÉïÔºåÂ¶ÇÊúâÁñëÂïèÂèØË´ÆË©¢165ÂèçË©êÈ®ôÂ∞àÁ∑ö„ÄÇ",
        "is_emerging": False
    }

    for line in lines:
        if line.startswith("È¢®Èö™Á≠âÁ¥öÔºö"):
            result["risk_level"] = line.split("È¢®Èö™Á≠âÁ¥öÔºö")[1].strip()
        elif line.startswith("ÂèØËÉΩË©êÈ®ôÈ°ûÂûãÔºö"):
            result["fraud_type"] = line.split("ÂèØËÉΩË©êÈ®ôÈ°ûÂûãÔºö")[1].strip()
            if result["fraud_type"].lower() == "‰∏çÈÅ©Áî®" or result["fraud_type"].lower() == "ÁÑ°":
                 result["fraud_type"] = "ÈùûË©êÈ®ôÁõ∏Èóú"
        elif line.startswith("Ë™™ÊòéÔºö"):
            result["explanation"] = line.split("Ë™™ÊòéÔºö")[1].strip()
        elif line.startswith("Âª∫Ë≠∞Ôºö"):
            result["suggestions"] = line.split("Âª∫Ë≠∞Ôºö")[1].strip()
        elif line.startswith("Êñ∞ËààÊâãÊ≥ïÔºö"):
            is_emerging_text = line.split("Êñ∞ËààÊâãÊ≥ïÔºö")[1].strip().lower()
            result["is_emerging"] = (is_emerging_text == "ÊòØ")

    # Â¶ÇÊûúËß£ÊûêÂæåexplanationÈÇÑÊòØÂéüÂßãÂÆåÊï¥Ë®äÊÅØÔºå‰∏îÊúâÂñÆÁç®ÁöÑË™™ÊòéÂ≠óÊÆµÔºåÂâáÁî®ÂñÆÁç®ÁöÑË™™Êòé
    if result["explanation"] == analysis_result and "Ë™™ÊòéÔºö" in analysis_result:
        pass # Keep as is, maybe it was just one line of explanation
    elif "Ë™™ÊòéÔºö" not in analysis_result and "Âª∫Ë≠∞Ôºö" not in analysis_result : # if no specific fields, use the whole thing as explanation
         result["explanation"] = analysis_result
    
    # Â¶ÇÊûúË©êÈ®ôÈ°ûÂûãÂåÖÂê´Â§öÂÄãÔºåÂèñÁ¨¨‰∏ÄÂÄã‰∏ªË¶ÅÁöÑ
    if isinstance(result["fraud_type"], str) and ',' in result["fraud_type"]:
        result["fraud_type"] = result["fraud_type"].split(',')[0].strip()
    if isinstance(result["fraud_type"], str) and '„ÄÅ' in result["fraud_type"]:
        result["fraud_type"] = result["fraud_type"].split('„ÄÅ')[0].strip()


    return result

# ChatGPTÊ™¢Ê∏¨Ë©êÈ®ôË®äÊÅØÂáΩÊï∏
def detect_fraud_with_chatgpt(user_message, display_name="ÊúãÂèã", user_id=None):
    """‰ΩøÁî®ChatGPT APIÂàÜÊûêË®äÊÅØÊòØÂê¶ÁÇ∫Ë©êÈ®ô
    
    Args:
        user_message: Áî®Êà∂Ë®äÊÅØ
        display_name: Áî®Êà∂È°ØÁ§∫ÂêçÁ®±
        user_id: Áî®Êà∂IDÔºåÁî®ÊñºÁç≤ÂèñÊ≠∑Âè≤Â∞çË©±
        
    Returns:
        ÂàÜÊûêÁµêÊûúÁöÑÊñáÊú¨
    """
    try:
        # ÊßãÂª∫Âü∫Êú¨Á≥ªÁµ±ÊèêÁ§∫
        system_prompt = """‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÁöÑË©êÈ®ôÂàÜÊûêÂ∞àÂÆ∂ÔºåË´ãÂàÜÊûê‰ª•‰∏ãË®äÊÅØÊòØÂê¶ÂèØËÉΩÊòØË©êÈ®ôÔºö

Êèê‰æõÂàÜÊûêÁµêÊûúÊôÇÔºåË´ã‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºàÁî®‰∏≠ÊñáÂõûÁ≠îÔºâÔºö
{
"risk_level": "È´ò/‰∏≠/‰Ωé/ÁÑ°È¢®Èö™",
"fraud_type": "Ë©êÈ®ôÈ°ûÂûãÊàñ'ÈùûË©êÈ®ôÁõ∏Èóú'",
"explanation": "Ë©≥Á¥∞Ëß£ÈáãÁÇ∫‰ªÄÈ∫ºÈÄôÊòØÊàñ‰∏çÊòØË©êÈ®ôÔºà100-200Â≠óÔºâ",
"suggestions": "Áµ¶Áî®Êà∂ÁöÑÂª∫Ë≠∞ÔºàÂ¶ÇÊûúÊúâÈ¢®Èö™Ôºâ",
"is_emerging": true/falseÔºàÊòØÂê¶ÂèØËÉΩÊòØÊñ∞ÂûãË©êÈ®ôÊâãÊ≥ïÔºâ
}

ÂàÜÊûêÊôÇË´ãÁâπÂà•Ê≥®ÊÑèÔºö
1. ÊòØÂê¶Ë¶ÅÊ±ÇËΩâÂ∏≥„ÄÅÊèê‰æõÂÄã‰∫∫Ë≥áÊñôÊàñÈªûÊìäÂèØÁñëÈÄ£Áµê
2. ÊòØÂê¶Ë£ΩÈÄ†Á∑äÊÄ•ÊÑüÊàñÂ®ÅËÑÖ
3. ÊòØÂê¶Êúâ‰∏çÂêàÁêÜÁöÑË™òÊÉëÔºàÈ´òÂ†±ÈÖ¨„ÄÅ‰∏≠ÁçéÁ≠âÔºâ
4. ÊòØÂê¶ÂÅΩË£ùÊàêÂÆòÊñπÊ©üÊßãÊàñÁÜü‰∫∫
5. ÊòØÂê¶ÊúâÊãºÂØ´ÊàñË™ûÊ≥ïÈåØË™§

Ë´ãÂÆ¢ËßÄÂàÜÊûêÂÖßÂÆπÔºå‰∏çË¶ÅÈÅéÂ∫¶ÊïèÊÑüÔºå‰πü‰∏çË¶ÅÊîæÈÅéÂèØÁñëË∑°Ë±°„ÄÇ"""

        # Â¶ÇÊûúÊèê‰æõ‰∫Üuser_idÔºåÂòóË©¶Áç≤ÂèñÊ≠∑Âè≤Â∞çË©±‰ΩúÁÇ∫‰∏ä‰∏ãÊñá
        messages = [{"role": "system", "content": system_prompt}]
        
        if user_id:
            recent_history = firebase_manager.get_recent_interactions(user_id, limit=3)
            
            if recent_history and len(recent_history) > 0:
                # Ê∑ªÂä†Ê≠∑Âè≤‰∏ä‰∏ãÊñá‰ø°ÊÅØ
                context_prompt = "‰ª•‰∏ãÊòØÁî®Êà∂ÊúÄËøëÁöÑÂ∞çË©±Ê≠∑Âè≤ÔºåÂèØËÉΩÊúâÂä©Êñº‰Ω†ÁöÑÂàÜÊûêÔºö"
                
                for interaction in recent_history:
                    if 'message' in interaction and interaction['message']:
                        context_prompt += f"\nÁî®Êà∂: {interaction['message']}"
                    if 'response' in interaction and interaction['response']:
                        context_prompt += f"\nÊ©üÂô®‰∫∫: {interaction['response']}"
                
                context_prompt += "\n\nË´ãÊ†πÊìöÈÄô‰∫õÊ≠∑Âè≤Â∞çË©±ÂíåÁï∂ÂâçË®äÊÅØÈÄ≤Ë°åÂàÜÊûê„ÄÇ"
                
                messages.append({"role": "user", "content": context_prompt})
                logger.info(f"Ë©êÈ®ôÂàÜÊûê‰ΩøÁî®‰∫Ü {len(recent_history)} Ê¢ùÊ≠∑Âè≤Â∞çË©±Ë®òÈåÑ")
            else:
                logger.info("Ë©êÈ®ôÂàÜÊûêÁÑ°Ê≥ïÁç≤ÂèñÊ≠∑Âè≤Â∞çË©±Ôºå‰ΩøÁî®ÂñÆ‰∏ÄË®äÊÅØÂàÜÊûê")
        else:
            logger.info("Êú™Êèê‰æõuser_idÔºåË©êÈ®ôÂàÜÊûêÂ∞á‰∏ç‰ΩøÁî®Ê≠∑Âè≤Ë®òÈåÑ")
        
        # Ê∑ªÂä†Ë¶ÅÂàÜÊûêÁöÑÁï∂ÂâçË®äÊÅØ
        analysis_prompt = f"""Ë´ãÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö

{user_message}

ÈÄôÊòØ‰æÜËá™„Äå{display_name}„ÄçÁöÑË®äÊÅØ„ÄÇË´ã‰æùÁÖßÁ≥ªÁµ±ÊèêÁ§∫ÁöÑÊ†ºÂºèÊèê‰æõJSONÊ†ºÂºèÁöÑÂàÜÊûêÁµêÊûú„ÄÇ"""

        messages.append({"role": "user", "content": analysis_prompt})
        
        # Ë™øÁî®ChatGPT API
        logger.info(f"ÁôºÈÄÅË©êÈ®ôÂàÜÊûêË´ãÊ±ÇÁµ¶ChatGPTÔºåÂÖ±{len(messages)}Ê¢ùÊ∂àÊÅØ")
        response = openai.chat.completions.create(
            model=os.environ.get('OPENAI_MODEL', 'gpt-3.5-turbo'),
            messages=messages,
            temperature=0.2,  # ËºÉ‰ΩéÁöÑÊ∫´Â∫¶Ôºå‰ΩøÁµêÊûúÊõ¥Á¢∫ÂÆöÊÄß
            max_tokens=800
        )
        
        result = response.choices[0].message.content.strip()
        
        return result
    except Exception as e:
        logger.error(f"ChatGPT Ë©êÈ®ôÂàÜÊûêÈåØË™§: {e}")
        return "Êä±Ê≠âÔºåÊàëÁèæÂú®ÁÑ°Ê≥ïÂàÜÊûêÊÇ®ÁöÑË®äÊÅØ„ÄÇË´ãÁ®çÂæåÂÜçË©¶„ÄÇ"

# --- Begin: Add these new functions for the game ---
def send_potato_game_question(user_id, reply_token):
    """
    Sends a new "ÈÅ∏Âì™È°ÜÂúüË±Ü" game question to the user.
    """
    global user_game_state
    
    # ÂÑ™ÂÖàÂæûÈ†êË®≠È°åÂ∫´ÈÅ∏ÂèñÈ°åÁõÆ
    if potato_game_questions:
        # ÂæûÈ°åÂ∫´‰∏≠Èö®Ê©üÈÅ∏Âèñ‰∏ÄÈÅìÈ°åÁõÆ
        question = random.choice(potato_game_questions)
        
        # Ë©êÈ®ôË®äÊÅØÔºàÂÅáÂúüË±ÜÔºâ
        false_potato_text = question['fraud_message']
        fraud_type = question['fraud_type']
        explanation = question.get('explanation', 'ÈÄôÊòØ‰∏ÄÂâáË©êÈ®ôË®äÊÅØÔºåË´ã‰øùÊåÅË≠¶Ë¶∫„ÄÇ')
        
        # Ê™¢Êü•È°åÁõÆÊòØÂê¶Â∑≤ÊúâÈ†êË®≠ÈÅ∏È†Ö
        if 'options' in question and question['options'] and 'correct_option' in question:
            # ‰ΩøÁî®È°åÂ∫´‰∏≠ÁöÑÈ†êË®≠ÈÅ∏È†Ö
            options = question['options'].copy()
            correct_option = question['correct_option']
            
            # Èö®Ê©üÊâì‰∫ÇÈÅ∏È†ÖÈ†ÜÂ∫è
            random.shuffle(options)
            
            # ÈáçÊñ∞Êò†Â∞ÑÈÅ∏È†ÖID (ÂéüÊú¨ÂèØËÉΩÊòØA,B,CÔºåÁèæÂú®ÊèõÊàêÊñ∞ÁöÑÈ†ÜÂ∫è)
            option_mapping = {'A': options[0], 'B': options[1], 'C': options[2] if len(options) > 2 else None}
            
            # Ë®òÈåÑÊ≠£Á¢∫Á≠îÊ°àÁöÑÊñ∞‰ΩçÁΩÆ
            for option_id, option in option_mapping.items():
                if option and option['id'] == correct_option:
                    new_correct_option = option_id
                    break
            else:
                new_correct_option = 'A'  # È†êË®≠ÂÄºÔºåÊáâË©≤‰∏çÊúÉÁôºÁîü
                
            # È°ØÁ§∫ÈÅ∏È†ÖÁöÑÊñáÊú¨ÂÖßÂÆπ
            options_display_texts = [option['text'] for option in options if option]
            if len(options_display_texts) < 3:
                # Â¶ÇÊûúÈÅ∏È†Ö‰∏çË∂≥‰∏âÂÄãÔºåË£úÂÖÖ
                while len(options_display_texts) < 3:
                    options_display_texts.append("Ê≠§ÈÅ∏È†Ö‰∏çÈÅ©Áî®")
            
            # ‰øùÂ≠òÈÅäÊà≤ÁãÄÊÖãÔºåÂåÖÊã¨Êñ∞ÁöÑÈÅ∏È†ÖÈ†ÜÂ∫èÂíåÁ≠îÊ°à‰ΩçÁΩÆ
            user_game_state[user_id] = {
                'false_potato_original': false_potato_text,
                'fraud_type_for_explanation': fraud_type,
                'custom_explanation': explanation,
                'option_A_text': options_display_texts[0],
                'option_B_text': options_display_texts[1],
                'option_C_text': options_display_texts[2] if len(options_display_texts) > 2 else "ÁÑ°ÈÅ∏È†ÖC",
                'correct_option': new_correct_option,
                'using_predefined_options': True
            }
        else:
            # È°åÁõÆÊ≤íÊúâÈ†êË®≠ÈÅ∏È†ÖÔºå‰ΩøÁî®Âéü‰æÜÁöÑÈÇèËºØ
            # ÂâµÂª∫ÂÖ©ÂÄãÊòéÈ°ØÂÆâÂÖ®ÁöÑË®äÊÅØÔºàÁúüÂúüË±ÜÔºâ
            true_potato_texts = [
                "ÊèêÈÜíÊÇ®ÔºåÈäÄË°åÊ•≠Âãô‰∫∫Âì°Áµï‰∏çÊúÉË¶ÅÊ±ÇÊÇ®Êèê‰æõÁ∂≤Ë∑ØÈäÄË°åÂØÜÁ¢ºÊàñÊòØATMÊìç‰Ωú„ÄÇÂ¶ÇÊúâ‰ªª‰ΩïÁñëÂïèË´ãÊí•ÊâìÂÆòÊñπÂÆ¢ÊúçÈõªË©±Êü•Ë©¢Ôºå‰∏îÂãôÂøÖË¶™Ëá™Êí•ÊâìÔºå‰∏çË¶Å‰ΩøÁî®Â∞çÊñπÊèê‰æõÁöÑÈõªË©±ËôüÁ¢º„ÄÇ",
                "Ë≥ºÁâ©ÂâçË´ãÁ¢∫Ë™çÁ∂≤Á´ôÁöÑÂÆâÂÖ®ÊÄßÔºåÈÅ∏ÊìáÊúâhttpsÂíåÂÆâÂÖ®Ë™çË≠âÁöÑÂÆòÊñπÁ∂≤Á´ôÔºå‰∏¶ÈÄèÈÅéÁ¨¨‰∏âÊñπÊîØ‰ªòÊàñ‰ø°Áî®Âç°‰ªòÊ¨æ‰ª•Áç≤Âæó‰∫§Êòì‰øùÈöú„ÄÇÈÅáÂà∞Ë¶ÅÊ±ÇÁßÅ‰∏ã‰∫§ÊòìÊàñË¶ÅÊ±ÇÂÖà‰ªòÊ¨æÁöÑË≥£ÂÆ∂Ë´ãÁâπÂà•Â∞èÂøÉ„ÄÇ",
                "Êé•Âà∞ÈôåÁîü‰æÜÈõªÂÆ£Á®±ÊÇ®Ê∂âÂèäÂàëÊ°à„ÄÅÊ¥óÈå¢ÔºåÈúÄË¶ÅÁõ£ÁÆ°Â∏≥Êà∂ÊàñËΩâÂ∏≥Êìç‰ΩúÔºåË´ãÁ´ãÂç≥ÊéõÊñ∑„ÄÇÂè∏Ê≥ïÂñÆ‰Ωç‰∏çÊúÉÁî®ÈõªË©±Ë¶ÅÊ±ÇÊÇ®Êìç‰ΩúATMÊàñÈäÄË°åÂ∏≥Êà∂„ÄÇË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öÁ¢∫Ë™ç„ÄÇ",
                "Á∂≤Ë∑ØÊäïË≥áÂâçË´ãÊü•Ë≠âÂπ≥Âè∞ÂêàÊ≥ïÊÄßÔºå‰ªª‰ΩïÂÆ£Á®±„Äå‰øùË≠âÁç≤Âà©„Äç„ÄÅ„ÄåÈõ∂È¢®Èö™È´òÂ†±ÈÖ¨„ÄçÁöÑÊäïË≥áÈÉΩÊ•µÂèØËÉΩÊòØË©êÈ®ô„ÄÇÂêàÊ≥ïÊäïË≥áÁÆ°ÈÅì‰∏çÊúÉË¶ÅÊ±ÇÊÇ®ÂÆâË£ùÁâπÂÆöAPPÊàñÂä†ÂÖ•ÁâπÂÆöÈÄöË®äËªüÈ´îÁæ§ÁµÑ„ÄÇ",
                "‰øùË≠∑ÂÄã‰∫∫Ë≥áÊñôÂÆâÂÖ®Ôºå‰∏çÈö®ÊÑèÊèê‰æõË∫´ÂàÜË≠âÂ≠óËôü„ÄÅÈäÄË°åÂ∏≥ËôüÁ≠âË≥áË®ä„ÄÇÂ∞çÊñπÂ¶ÇÊúâË¶ÅÊ±ÇË≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏„ÄÅÁ¶ÆÂìÅÂç°Ôºå‰∏¶Ë¶ÅÊ±ÇÊèê‰æõÂç°ËôüÂ∫èËôüÔºåÂπæ‰πéÈÉΩÊòØË©êÈ®ôË°åÁÇ∫„ÄÇ"
            ]
            
            # ÂæûÂÆâÂÖ®Ë®äÊÅØ‰∏≠Èö®Ê©üÈÅ∏ÊìáÂÖ©Ââá
            selected_true_potatoes = random.sample(true_potato_texts, 2)
            
            # Êâì‰∫Ç‰∏âÂÄãÈÅ∏È†ÖÁöÑÈ†ÜÂ∫è
            options_display_texts = [false_potato_text] + selected_true_potatoes
            random.shuffle(options_display_texts)

            # ÊâæÂá∫Ë©êÈ®ôË®äÊÅØÂú®Êâì‰∫ÇÂæåÁöÑ‰ΩçÁΩÆ
            correct_option = None
            for i, text in enumerate(options_display_texts):
                if text == false_potato_text:
                    if i == 0:
                        correct_option = 'A'
                    elif i == 1:
                        correct_option = 'B'
                    else:
                        correct_option = 'C'
                    break

            user_game_state[user_id] = {
                'false_potato_original': false_potato_text,
                'fraud_type_for_explanation': fraud_type,
                'custom_explanation': explanation,
                'option_A_text': options_display_texts[0],
                'option_B_text': options_display_texts[1],
                'option_C_text': options_display_texts[2],
                'correct_option': correct_option,
                'using_predefined_options': False
            }
    else:
        # Â¶ÇÊûúÊ≤íÊúâÈ†êË®≠È°åÂ∫´ÔºåÂâáÂõûÈÄÄÂà∞ÂæûFirebase‰∏≠Áç≤Âèñ
        logger.warning("‰ΩøÁî®FirebaseË≥áÊñôÂ∫´‰ΩúÁÇ∫ÂÇôÈÅ∏È°åÁõÆ‰æÜÊ∫ê")
        report_data = firebase_manager.get_random_fraud_report_for_game()

        if not report_data:
            line_bot_api.reply_message(
                reply_token,
                TextSendMessage(text="Êä±Ê≠âÔºåÁõÆÂâçÈ°åÂ∫´Ë£°Ê≤íÊúâÈ°åÁõÆ‰∫ÜÔºåÁ®çÂæåÂÜçË©¶Ë©¶ÂêßÔºÅ")
            )
            return

        # Ë©êÈ®ôË®äÊÅØÔºàÂÅáÂúüË±ÜÔºâ
        false_potato_text = report_data['message']
        fraud_type = report_data['fraud_type']
        explanation = ""
        
        # ÂâµÂª∫ÂÖ©ÂÄãÊòéÈ°ØÂÆâÂÖ®ÁöÑË®äÊÅØÔºàÁúüÂúüË±ÜÔºâ
        true_potato_texts = [
            "ÊèêÈÜíÊÇ®ÔºåÈäÄË°åÊ•≠Âãô‰∫∫Âì°Áµï‰∏çÊúÉË¶ÅÊ±ÇÊÇ®Êèê‰æõÁ∂≤Ë∑ØÈäÄË°åÂØÜÁ¢ºÊàñÊòØATMÊìç‰Ωú„ÄÇÂ¶ÇÊúâ‰ªª‰ΩïÁñëÂïèË´ãÊí•ÊâìÂÆòÊñπÂÆ¢ÊúçÈõªË©±Êü•Ë©¢Ôºå‰∏îÂãôÂøÖË¶™Ëá™Êí•ÊâìÔºå‰∏çË¶Å‰ΩøÁî®Â∞çÊñπÊèê‰æõÁöÑÈõªË©±ËôüÁ¢º„ÄÇ",
            "Ë≥ºÁâ©ÂâçË´ãÁ¢∫Ë™çÁ∂≤Á´ôÁöÑÂÆâÂÖ®ÊÄßÔºåÈÅ∏ÊìáÊúâhttpsÂíåÂÆâÂÖ®Ë™çË≠âÁöÑÂÆòÊñπÁ∂≤Á´ôÔºå‰∏¶ÈÄèÈÅéÁ¨¨‰∏âÊñπÊîØ‰ªòÊàñ‰ø°Áî®Âç°‰ªòÊ¨æ‰ª•Áç≤Âæó‰∫§Êòì‰øùÈöú„ÄÇÈÅáÂà∞Ë¶ÅÊ±ÇÁßÅ‰∏ã‰∫§ÊòìÊàñË¶ÅÊ±ÇÂÖà‰ªòÊ¨æÁöÑË≥£ÂÆ∂Ë´ãÁâπÂà•Â∞èÂøÉ„ÄÇ",
            "Êé•Âà∞ÈôåÁîü‰æÜÈõªÂÆ£Á®±ÊÇ®Ê∂âÂèäÂàëÊ°à„ÄÅÊ¥óÈå¢ÔºåÈúÄË¶ÅÁõ£ÁÆ°Â∏≥Êà∂ÊàñËΩâÂ∏≥Êìç‰ΩúÔºåË´ãÁ´ãÂç≥ÊéõÊñ∑„ÄÇÂè∏Ê≥ïÂñÆ‰Ωç‰∏çÊúÉÁî®ÈõªË©±Ë¶ÅÊ±ÇÊÇ®Êìç‰ΩúATMÊàñÈäÄË°åÂ∏≥Êà∂„ÄÇË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑öÁ¢∫Ë™ç„ÄÇ",
            "Á∂≤Ë∑ØÊäïË≥áÂâçË´ãÊü•Ë≠âÂπ≥Âè∞ÂêàÊ≥ïÊÄßÔºå‰ªª‰ΩïÂÆ£Á®±„Äå‰øùË≠âÁç≤Âà©„Äç„ÄÅ„ÄåÈõ∂È¢®Èö™È´òÂ†±ÈÖ¨„ÄçÁöÑÊäïË≥áÈÉΩÊ•µÂèØËÉΩÊòØË©êÈ®ô„ÄÇÂêàÊ≥ïÊäïË≥áÁÆ°ÈÅì‰∏çÊúÉË¶ÅÊ±ÇÊÇ®ÂÆâË£ùÁâπÂÆöAPPÊàñÂä†ÂÖ•ÁâπÂÆöÈÄöË®äËªüÈ´îÁæ§ÁµÑ„ÄÇ",
            "‰øùË≠∑ÂÄã‰∫∫Ë≥áÊñôÂÆâÂÖ®Ôºå‰∏çÈö®ÊÑèÊèê‰æõË∫´ÂàÜË≠âÂ≠óËôü„ÄÅÈäÄË°åÂ∏≥ËôüÁ≠âË≥áË®ä„ÄÇÂ∞çÊñπÂ¶ÇÊúâË¶ÅÊ±ÇË≥ºË≤∑ÈÅäÊà≤ÈªûÊï∏„ÄÅÁ¶ÆÂìÅÂç°Ôºå‰∏¶Ë¶ÅÊ±ÇÊèê‰æõÂç°ËôüÂ∫èËôüÔºåÂπæ‰πéÈÉΩÊòØË©êÈ®ôË°åÁÇ∫„ÄÇ"
        ]
        
        # ÂæûÂÆâÂÖ®Ë®äÊÅØ‰∏≠Èö®Ê©üÈÅ∏ÊìáÂÖ©Ââá
        selected_true_potatoes = random.sample(true_potato_texts, 2)
        
        # Êâì‰∫Ç‰∏âÂÄãÈÅ∏È†ÖÁöÑÈ†ÜÂ∫è
        options_display_texts = [false_potato_text] + selected_true_potatoes
        random.shuffle(options_display_texts)

        # ÊâæÂá∫Ë©êÈ®ôË®äÊÅØÂú®Êâì‰∫ÇÂæåÁöÑ‰ΩçÁΩÆ
        correct_option = None
        for i, text in enumerate(options_display_texts):
            if text == false_potato_text:
                if i == 0:
                    correct_option = 'A'
                elif i == 1:
                    correct_option = 'B'
                else:
                    correct_option = 'C'
                break

        user_game_state[user_id] = {
            'false_potato_original': false_potato_text,
            'fraud_type_for_explanation': fraud_type,
            'custom_explanation': explanation,
            'option_A_text': options_display_texts[0],
            'option_B_text': options_display_texts[1],
            'option_C_text': options_display_texts[2],
            'correct_option': correct_option,
            'using_predefined_options': False
        }

    flex_message_content = BubbleContainer(
        body=BoxComponent(
            layout='vertical',
            contents=[
                TextComponent(text='ÈÅ∏Âì™È°ÜÂúüË±ÜÔºüü§î', weight='bold', size='xl', align='center', margin='md'),
                TextComponent(text='Ë´ãÊåáÂá∫‰∏ãÂàóÂì™‰∏ÄÂÄãÈÅ∏È†Ö„ÄåÊòØË©êÈ®ôË®äÊÅØ„ÄçÔºà‰πüÂ∞±ÊòØÂÅáÂúüË±ÜÔºâÔºü', wrap=True, margin='lg', size='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='ÈÅ∏È†Ö A:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_A_text'][:250] + '...' if len(user_game_state[user_id]['option_A_text']) > 250 else user_game_state[user_id]['option_A_text'], wrap=True, size='sm', margin='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='ÈÅ∏È†Ö B:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_B_text'][:250] + '...' if len(user_game_state[user_id]['option_B_text']) > 250 else user_game_state[user_id]['option_B_text'], wrap=True, size='sm', margin='sm'),
                SeparatorComponent(margin='lg'),
                TextComponent(text='ÈÅ∏È†Ö C:', weight='bold', size='md', margin='lg'),
                TextComponent(text=user_game_state[user_id]['option_C_text'][:250] + '...' if len(user_game_state[user_id]['option_C_text']) > 250 else user_game_state[user_id]['option_C_text'], wrap=True, size='sm', margin='sm'),
            ]
        ),
        footer=BoxComponent(
            layout='vertical',
            spacing='sm',
            contents=[
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='ÈÅ∏ A', data=f'action=potato_game_answer&chosen_option_id=A&uid={user_id}')
                ),
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='ÈÅ∏ B', data=f'action=potato_game_answer&chosen_option_id=B&uid={user_id}')
                ),
                ButtonComponent(
                    style='primary',
                    color='#FF8C00', 
                    height='sm',
                    action=PostbackAction(label='ÈÅ∏ C', data=f'action=potato_game_answer&chosen_option_id=C&uid={user_id}')
                )
            ]
        )
    )
    
    try:
        line_bot_api.reply_message(reply_token, FlexSendMessage(alt_text='ÈÅ∏Âì™È°ÜÂúüË±ÜÔºüÂ∞èÈÅäÊà≤', contents=flex_message_content))
    except Exception as e:
        logger.error(f"Error sending potato game question: {e}")
        line_bot_api.reply_message(reply_token, TextSendMessage(text="Êä±Ê≠âÔºåÈÅäÊà≤ËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ"))


def handle_potato_game_answer(user_id, reply_token, data_params):
    """
    Handles the user's answer in the "ÈÅ∏Âì™È°ÜÂúüË±Ü" game.
    """
    global user_game_state
    chosen_option_id = data_params.get('chosen_option_id')

    if user_id not in user_game_state or 'false_potato_original' not in user_game_state[user_id]:
        line_bot_api.reply_message(reply_token, TextSendMessage(text="Á≥üÁ≥ïÔºåÈÅäÊà≤ÁãÄÊÖãÂ•ΩÂÉè‰∏çË¶ã‰∫ÜÔºåÈ∫ªÁÖ©ÊÇ®ÈáçÊñ∞ÈñãÂßãÈÅäÊà≤ÂêßÔºÅ"))
        return

    game_data = user_game_state[user_id]
    false_potato_original_text = game_data['false_potato_original']
    fraud_type_for_explanation = game_data['fraud_type_for_explanation']
    custom_explanation = game_data.get('custom_explanation', '')
    correct_option = game_data.get('correct_option')
    
    chosen_text = ""
    if chosen_option_id == 'A':
        chosen_text = game_data['option_A_text']
    elif chosen_option_id == 'B':
        chosen_text = game_data['option_B_text']
    elif chosen_option_id == 'C':
        chosen_text = game_data['option_C_text']
    else:
        line_bot_api.reply_message(reply_token, TextSendMessage(text="ÈÅ∏ÊìáÂá∫ÈåØ‰∫ÜÔºåË´ãÈáçÊñ∞Áé©‰∏ÄÊ¨°Âì¶„ÄÇ"))
        return

    reply_messages = []
    
    # ‰ΩøÁî®Ëá™Ë®ÇËß£ÈáãÊàñÂæûÈÄöÁî®ÁâπÂæµÂ∫´Áç≤Âèñ
    if custom_explanation:
        fraud_features = f"‚ö†Ô∏è Ë©êÈ®ôÁâπÂæµË™™ÊòéÔºö\n{custom_explanation}"
    else:
        fraud_features = get_fraud_features(fraud_type_for_explanation, false_potato_original_text)
    
    explanation_intro = f"ÈÄôÂâáË®äÊÅØÂ±¨Êñº„Äê{fraud_type_for_explanation}„ÄëÈ°ûÂûãÁöÑË©êÈ®ôÊâãÊ≥ï„ÄÇ"
    explanation_detail = f"Ë©êÈ®ôË®äÊÅØÔºö\n„Äå{false_potato_original_text[:180]}...„Äç" 

    # Âà§Êñ∑Áî®Êà∂ÊòØÂê¶ÈÅ∏Êìá‰∫ÜÊ≠£Á¢∫ÁöÑÈÅ∏È†Ö
    is_correct = chosen_option_id == correct_option
    
    if is_correct: 
        result_text = f"üëç ÊÅ≠ÂñúÁ≠îÂ∞ç‰∫ÜÔºÅÊÇ®ÊàêÂäüË≠òÂà•Âá∫Ë©êÈ®ôË®äÊÅØÔºÅ\n\n{explanation_intro}\n\n{explanation_detail}\n\n{fraud_features}\n\nË®ò‰ΩèÔºöÊèêÈ´òË≠¶Ë¶∫Ôºå‰øùË≠∑Ëá™Â∑±ÂíåË¶™ÂèãÁöÑË≥áÁî¢ÂÆâÂÖ®ÔºÅ"
        reply_messages.append(TextSendMessage(text=result_text))
    else: 
        result_text = f"‚ùå Ë¶ÅÂ∞èÂøÉÔºÅÊÇ®ÈÅ∏ÁöÑ‰∏çÊòØË©êÈ®ôË®äÊÅØ„ÄÇ\n\n{explanation_intro}\n\nÊ≠£Á¢∫Á≠îÊ°àÊòØÈÅ∏È†Ö {correct_option}Ôºö\n„Äå{false_potato_original_text[:180]}...„Äç\n\n{fraud_features}\n\nÂà•ÁÅ∞ÂøÉÔºåÈÄèÈÅéÁ∑¥ÁøíÊÇ®ÊúÉË∂ä‰æÜË∂äÊìÖÈï∑Ë≠òÂà•Ë©êÈ®ôÔºÅ"
        reply_messages.append(TextSendMessage(text=result_text))

    quick_reply_items = QuickReply(items=[
        QuickReplyButton(action=PostbackAction(label="ÂÜçÁé©‰∏ÄÈ°å", data=f'action=start_potato_game&uid={user_id}')),
        QuickReplyButton(action=MessageAction(label="ÂàÜÊûêÂèØÁñëË®äÊÅØ", text="Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö")),
        QuickReplyButton(action=MessageAction(label="Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®"))
    ])
    
    reply_messages.append(TextSendMessage(text="Ë¶Å‰∏çË¶ÅÂÜç‰æÜ‰∏ÄÂ±ÄÔºåÊàñÊòØÂòóË©¶ÂÖ∂‰ªñÂäüËÉΩÔºü", quick_reply=quick_reply_items))
    
    try:
        line_bot_api.reply_message(reply_token, messages=reply_messages)
    except Exception as e:
        logger.error(f"Error sending potato game answer reply: {e}")

def get_fraud_features(fraud_type, fraud_message):
    """
    Ê†πÊìöË©êÈ®ôÈ°ûÂûãÊèê‰æõÂÖ∏ÂûãË©êÈ®ôÁâπÂæµË™™Êòé
    """
    common_features = "‚ö†Ô∏è Ë©êÈ®ôÂ∏∏Ë¶ãÁâπÂæµÔºö\n"
    
    # Ê†πÊìöË©êÈ®ôÈ°ûÂûãÊ∑ªÂä†ÁâπÂÆöÁâπÂæµ
    if "Ë≥ºÁâ©" in fraud_type:
        features = [
            "1. Ë¶ÅÊ±ÇÁßÅ‰∏ã‰∫§ÊòìÊàñÂåØÊ¨æÂà∞ÁßÅ‰∫∫Â∏≥Êà∂",
            "2. ÊÄ•ËëóÊàê‰∫§ÔºåË£ΩÈÄ†ÊÄ•Ëø´ÊÑü",
            "3. ÂÉπÊ†ºÊòéÈ°Ø‰ΩéÊñºÂ∏ÇÂ†¥Ë°åÊÉÖ",
            "4. Ë¶ÅÊ±Ç‰ΩøÁî®ÈùûÊ≠£Ë¶èÊîØ‰ªòÊñπÂºè",
            "5. Ë≥£ÂÆ∂Ë≥áË®äÊ®°Á≥ä‰∏çÊ∏Ö"
        ]
    elif "ÊäïË≥á" in fraud_type or "ÁêÜË≤°" in fraud_type:
        features = [
            "1. ‰øùË≠â„ÄåÁ©©Ë≥∫‰∏çË≥†„Äç„ÄÅ„ÄåÈ´òÂ†±ÈÖ¨„ÄÅ‰ΩéÈ¢®Èö™„Äç",
            "2. ËÅ≤Á®±Êúâ„ÄåÂÖßÈÉ®Ë≥áË®ä„ÄçÊàñ„ÄåÁç®ÂÆ∂ÊäïË≥áÁÆ°ÈÅì„Äç",
            "3. Ë¶ÅÊ±Ç‰∏ãËºâÁâπÂÆöAPPÊàñÂä†ÂÖ•ÁâπÂÆöÁæ§ÁµÑ",
            "4. ÂÇ¨‰øÉÁ´ãÂç≥ÊäïË≥áÔºåËÅ≤Á®±„ÄåÊ©üÊúÉÁ®çÁ∏±Âç≥ÈÄù„Äç",
            "5. Ë¶ÅÊ±ÇÂ∞áË≥áÈáëËΩâÂÖ•„ÄåÊäïË≥áÂ∞àÊà∂„Äç"
        ]
    elif "‰∫§Âèã" in fraud_type:
        features = [
            "1. Áü≠ÊôÇÈñìÂÖßËøÖÈÄüÁôºÂ±ïË¶™ÂØÜÈóú‰øÇ",
            "2. Ëá™Á®±È´òÁ§æÁ∂ìÂú∞‰Ωç‰ΩÜÁÑ°Ê≥ïË¶ãÈù¢",
            "3. Á∑®ÈÄ†ÂêÑÁ®ÆÁêÜÁî±Ë´ãÊ±ÇÈáëÈå¢ÂçîÂä©",
            "4. ËÅ≤Á®±ÊúâÁ∑äÊÄ•ÈÜ´ÁôÇË≤ªÁî®ÊàñÊÑèÂ§ñ‰∫ã‰ª∂",
            "5. ÊãíÁµïË¶ñË®äÈÄöË©±ÊàñË¶ãÈù¢"
        ]
    elif "Ê™¢Ë≠¶" in fraud_type or "ÂÖ¨Âãô" in fraud_type:
        features = [
            "1. ËÅ≤Á®±ÊÇ®Ê∂âÂèäÂàëÊ°àÊàñÊ¥óÈå¢",
            "2. Ë¶ÅÊ±ÇÁõ£ÁÆ°ÊÇ®ÁöÑÈäÄË°åÂ∏≥Êà∂",
            "3. Ë¶ÅÊ±ÇÊìç‰ΩúATMÊàñÁ∂≤ÈäÄ",
            "4. Ë¶ÅÊ±ÇË≥ºË≤∑ÈªûÊï∏Âç°ÊàñÁ¶ÆÂìÅÂç°",
            "5. Ë≠¶Âëä‰∏çÂæóÂêë‰ªñ‰∫∫ÈÄèÈú≤"
        ]
    elif "‰∏≠Áçé" in fraud_type:
        features = [
            "1. Êú™ÂèÉÂä†‰πü„Äå‰∏≠Áçé„Äç",
            "2. Ë¶ÅÊ±ÇÊîØ‰ªòÊâãÁ∫åË≤ª„ÄÅÁ®ÖÈáëÊâçËÉΩÈ†òÁçé",
            "3. ‰ΩøÁî®Ê®°Á≥äÁöÑÊ¥ªÂãïËæ¶Ê≥ï",
            "4. ÈÄöÁü•ÁÆ°ÈÅìÂèØÁñëÔºàÂ¶ÇÁ∞°Ë®äÔºâ",
            "5. Ë¶ÅÊ±ÇÊèê‰æõÈäÄË°åÂ∏≥ËôüÊàñÂÄãË≥á"
        ]
    else:
        # ÈÄöÁî®Ë©êÈ®ôÁâπÂæµ
        features = [
            "1. Ë£ΩÈÄ†Á∑äÊÄ•ÊÑüËàáÊÅêÊÖå",
            "2. Ë¶ÅÊ±ÇÊèê‰æõÊïèÊÑüÂÄã‰∫∫Ë≥áÊñô",
            "3. ÊèêÂá∫‰∏çÂêàÁêÜÊàñÂèØÁñëÁöÑË¶ÅÊ±Ç",
            "4. Ë™ûÊ≥ïÈåØË™§ÊàñÂèØÁñëÈÄ£Áµê",
            "5. Ë¶ÅÊ±ÇËΩâÂ∏≥„ÄÅÂåØÊ¨æÊàñË≥ºË≤∑ÈªûÊï∏"
        ]
    
    return common_features + "\n".join(features)

# --- End: Add these new functions ---

# Ê∑ªÂä†URLÂàÜÊûêÁµêÊûúÁöÑFlex MessageÊ†ºÂºèÂáΩÊï∏
def create_analysis_flex_message(analysis_data, display_name, message_to_analyze):
    """
    ÂâµÂª∫Ë©êÈ®ôÂàÜÊûêÁµêÊûúÁöÑFlex MessageÊ†ºÂºè
    
    Args:
        analysis_data: ÂàÜÊûêÁµêÊûúÊï∏Êìö
        display_name: Áî®Êà∂È°ØÁ§∫ÂêçÁ®±
        message_to_analyze: Ë¢´ÂàÜÊûêÁöÑË®äÊÅØ
        
    Returns:
        Flex MessageÂ∞çË±°
    """
    risk_level = analysis_data.get("risk_level", "‰∏çÁ¢∫ÂÆö")
    fraud_type = analysis_data.get("fraud_type", "Êú™Áü•")
    explanation = analysis_data.get("explanation", "ÂàÜÊûêÁµêÊûú‰∏çÂÆåÊï¥ÔºåË´ãË¨πÊÖéÂà§Êñ∑„ÄÇ")
    suggestions = analysis_data.get("suggestions", "Ë´ãÈö®ÊôÇ‰øùÊåÅË≠¶ÊÉï„ÄÇ")
    
    # Ê†πÊìöÈ¢®Èö™Á≠âÁ¥öË®≠ÁΩÆÈ°èËâ≤
    if risk_level in ["È´ò", "È´òÈ¢®Èö™"]:
        risk_color = "#FF0000"  # Á¥ÖËâ≤
        risk_emoji = "‚ö†Ô∏è"
    elif risk_level in ["‰∏≠", "‰∏≠È¢®Èö™"]:
        risk_color = "#FFA500"  # Ê©ôËâ≤
        risk_emoji = "‚ö†Ô∏è"
    elif risk_level in ["‰Ωé", "‰ΩéÈ¢®Èö™"]:
        risk_color = "#008000"  # Á∂†Ëâ≤
        risk_emoji = "‚úÖ"
    else:
        risk_color = "#808080"  # ÁÅ∞Ëâ≤
        risk_emoji = "‚ùì"
    
    # ÊßãÂª∫Flex Message
    bubble = BubbleContainer(
        header=BoxComponent(
            layout='vertical',
            contents=[
                TextComponent(
                    text=f"È¢®Èö™ÂàÜÊûêÁµêÊûú {risk_emoji}",
                    weight='bold',
                    size='xl',
                    color='#ffffff'
                )
            ],
            background_color=risk_color
        ),
        body=BoxComponent(
            layout='vertical',
            contents=[
                TextComponent(
                    text=f"ÊÇ®Â•ΩÔºå{display_name}",
                    weight='bold',
                    size='md',
                    wrap=True,
                    margin='md'
                ),
                TextComponent(
                    text=f"ÊàëÂ∑≤ÂàÜÊûêÊÇ®Êèê‰æõÁöÑ‰ø°ÊÅØÔºö",
                    size='sm',
                    wrap=True,
                    margin='md'
                ),
                TextComponent(
                    text=message_to_analyze[:60] + "..." if len(message_to_analyze) > 60 else message_to_analyze,
                    size='sm',
                    wrap=True,
                    margin='md',
                    color='#555555'
                ),
                BoxComponent(
                    layout='vertical',
                    margin='lg',
                    spacing='sm',
                    contents=[
                        BoxComponent(
                            layout='baseline',
                            contents=[
                                TextComponent(
                                    text='È¢®Èö™Á≠âÁ¥öÔºö',
                                    color='#aaaaaa',
                                    size='sm',
                                    flex=2
                                ),
                                TextComponent(
                                    text=risk_level,
                                    wrap=True,
                                    color=risk_color,
                                    size='sm',
                                    flex=5,
                                    weight='bold'
                                )
                            ]
                        ),
                        BoxComponent(
                            layout='baseline',
                            contents=[
                                TextComponent(
                                    text='Ë©êÈ®ôÈ°ûÂûãÔºö',
                                    color='#aaaaaa',
                                    size='sm',
                                    flex=2
                                ),
                                TextComponent(
                                    text=fraud_type,
                                    wrap=True,
                                    color='#666666',
                                    size='sm',
                                    flex=5
                                )
                            ]
                        )
                    ]
                ),
                SeparatorComponent(margin='lg'),
                BoxComponent(
                    layout='vertical',
                    margin='lg',
                    contents=[
                        TextComponent(
                            text='ÂàÜÊûêË™™Êòé',
                            weight='bold',
                            size='md',
                            margin='none'
                        ),
                        TextComponent(
                            text=explanation,
                            size='sm',
                            wrap=True,
                            margin='md'
                        )
                    ]
                ),
                BoxComponent(
                    layout='vertical',
                    margin='lg',
                    contents=[
                        TextComponent(
                            text='Âª∫Ë≠∞',
                            weight='bold',
                            size='md',
                            margin='none'
                        ),
                        TextComponent(
                            text=suggestions,
                            size='sm',
                            wrap=True,
                            margin='md'
                        )
                    ]
                )
            ]
        ),
        footer=BoxComponent(
            layout='vertical',
            spacing='sm',
            contents=[
                TextComponent(
                    text='Â¶ÇÊúâÁñëÊÖÆÔºåË´ãÊí•Êâì165ÂèçË©êÈ®ôÂ∞àÁ∑ö',
                    size='xs',
                    wrap=True,
                    align='center',
                    color='#aaaaaa'
                ),
                SeparatorComponent(margin='md'),
                ButtonComponent(
                    style='primary',
                    color='#1DB446',
                    action=MessageAction(label='ÂÜçÊ¨°ÂàÜÊûê', text='Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö')
                )
            ]
        )
    )
    
    return FlexSendMessage(alt_text='Ë©êÈ®ôÈ¢®Èö™ÂàÜÊûêÁµêÊûú', contents=bubble)

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)
    
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
        
    return 'OK'

@app.route("/", methods=['GET'])
def home():
    return "Line Bot Anti-Fraud is running!"

@app.route("/fraud-statistics", methods=['GET'])
def fraud_statistics():
    """È°ØÁ§∫Ë©êÈ®ôÁµ±Ë®àÊï∏ÊìöÈ†ÅÈù¢"""
    stats = firebase_manager.get_fraud_statistics()
    return render_template('statistics.html', stats=stats)

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_id = event.source.user_id
    profile = get_user_profile(user_id)
    display_name = profile.display_name if profile else "Êú™Áü•Áî®Êà∂"
    text_message = event.message.text
    reply_token = event.reply_token
    current_time = datetime.datetime.now()

    logger.info(f"Received message from {display_name} ({user_id}): {text_message}")

    # Ê™¢Êü•ÊòØÂê¶ÁÇ∫È¶ñÊ¨°Â∞çË©±ÁöÑÁî®Êà∂
    is_first_time = user_id not in first_time_chatters
    if is_first_time:
        first_time_chatters.add(user_id)
        logger.info(f"User {user_id} is chatting for the first time")

    # Êõ¥Êñ∞Áî®Êà∂ÊúÄÂæåËÅäÂ§©ÊôÇÈñì
    user_last_chat_time[user_id] = current_time

    # 0. Ê™¢Êü•ÊòØÂê¶Ê≠£Âú®Á≠âÂæÖÁî®Êà∂Â∞çÊüêË®äÊÅØÊèê‰æõÊæÑÊ∏Ö
    pending_state = user_pending_analysis.get(user_id)
    if pending_state and pending_state.get("waiting_for_clarification"):
        logger.info(f"User {user_id} is providing clarification for: {pending_state.get('original_message')}")
        clarification = text_message
        original_message_to_analyze = pending_state.get("original_message")
        
        # Â∞áÂéüÂßãË®äÊÅØËàáÁî®Êà∂ÁöÑÊæÑÊ∏ÖÂêà‰ΩµÂæåÈÄ≤Ë°åÂàÜÊûê
        combined_message = f"Áî®Êà∂ÂéüÂßãË®äÊÅØÊòØÔºö\n„Äå{original_message_to_analyze}„Äç\n\nÁî®Êà∂ÈáùÂ∞çÊ≠§Ë®äÊÅØÔºåË£úÂÖÖÁöÑÁñëÊÖÆÊàñË™™ÊòéÊòØÔºö\n„Äå{clarification}„Äç"
        logger.info(f"Combined message for analysis for user {user_id}: {combined_message}")

        analysis_result_text = detect_fraud_with_chatgpt(combined_message, display_name, user_id)
        analysis_data = parse_fraud_analysis(analysis_result_text)

        # ÂâµÂª∫‰∏¶ÁôºÈÄÅFlex MessageÂàÜÊûêÁµêÊûú
        flex_message = create_analysis_flex_message(analysis_data, display_name, combined_message)
        line_bot_api.reply_message(reply_token, flex_message)

        # ‰øùÂ≠ò‰∫íÂãïË®òÈåÑ
        risk_level = analysis_data.get("risk_level", "‰∏çÁ¢∫ÂÆö")
        fraud_type = analysis_data.get("fraud_type", "Êú™Áü•")
        firebase_manager.save_user_interaction(
            user_id, display_name, 
            f"Original: {original_message_to_analyze} | Clarification: {clarification}", 
            analysis_result_text, 
            is_fraud_related=(risk_level.lower() not in ["ÁÑ°È¢®Èö™", "‰∏çÁ¢∫ÂÆö", "ÈùûË©êÈ®ôÁõ∏Èóú", "‰Ωé", "‰ΩéÈ¢®Èö™"]),
            fraud_type=fraud_type, 
            risk_level=risk_level
        )
        
        if user_id in user_pending_analysis:
            del user_pending_analysis[user_id]
        user_last_chat_time[user_id] = current_time
        return

    # Ê™¢Êü•Áî®Êà∂ÊòØÂê¶Âú®ÈÅäÊà≤‰∏≠
    if user_id in user_game_state:
        logger.info(f"User {user_id} is in potato game state.")
        # Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈáçÁΩÆËá™ÂãïÂõûË¶ÜË®àÊôÇÂô® (‰æãÂ¶ÇË∂ÖÈÅé5ÂàÜÈêòÊ≤íÊúâ‰∫íÂãï)
        # ÈÄôÊÆµÈÇèËºØÂèØ‰ª•Ê†πÊìöÂØ¶ÈöõÈúÄÊ±Ç‰øùÁïôÊàñË™øÊï¥
        # if user_id in user_last_chat_time and (current_time - user_last_chat_time[user_id]) > AUTO_REPLY_RESET_INTERVAL:
        # logger.info(f"Resetting auto-reply for user {user_id} due to inactivity.")
        # # ÂèØ‰ª•Âú®ÈÄôË£°ÁôºÈÄÅ‰∏ÄÂÄãÊñ∞ÁöÑÂïèÂÄôË™ûÊàñÊèêÁ§∫
        # greeting_message = f"{display_name}ÊÇ®Â•ΩÔºÅÂèàË¶ãÈù¢‰∫ÜÔºåÊúâ‰ªÄÈ∫ºÂèØ‰ª•Âπ´ÊÇ®ÁöÑÂóéÔºüË©¶Ë©¶ÁúãËº∏ÂÖ•„ÄåÂäüËÉΩ„Äç‰∫ÜËß£ÊàëÊúÉÂÅö‰ªÄÈ∫ºÔºÅ"
        # line_bot_api.push_message(user_id, TextSendMessage(text=greeting_message))
        # firebase_manager.save_user_interaction(user_id, display_name, "Auto-reply reset", greeting_message, is_fraud_related=False)

        # Êõ¥Êñ∞Áî®Êà∂ÊúÄÂæåËÅäÂ§©ÊôÇÈñì (Âç≥‰æøÂè™ÊòØÁî®Êà∂ÁôºË®äÊÅØÔºåÂ∞öÊú™ÂõûË¶ÜÔºå‰πüÊõ¥Êñ∞)
        user_last_chat_time[user_id] = current_time
        
        # ËôïÁêÜÂäüËÉΩË©¢Âïè
        if any(keyword in text_message.lower() for keyword in function_inquiry_keywords):
            reply_text = f"{display_name}ÊÇ®Â•ΩÔºÅÊàëÊòØÈò≤Ë©êÈ®ôÂ∞èÂπ´ÊâãÔºåÊàëÁöÑÂäüËÉΩÂåÖÊã¨Ôºö\n\n" \
                        f"1Ô∏è‚É£ Ë©êÈ®ôÈ¢®Èö™ÂàÜÊûêÔºöÊàëÂèØ‰ª•ÂàÜÊûêÊÇ®Êî∂Âà∞ÁöÑÂèØÁñëË®äÊÅØÔºåË©ï‰º∞ÊòØÂê¶ÁÇ∫Ë©êÈ®ô\n\n" \
                        f"2Ô∏è‚É£ Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢ÔºöÊÇ®ÂèØ‰ª•Ëº∏ÂÖ•„ÄåË©êÈ®ôÈ°ûÂûãÂàóË°®„ÄçÊü•ÁúãÂêÑÁ®ÆÂ∏∏Ë¶ãË©êÈ®ô\n\n" \
                        f"3Ô∏è‚É£ „ÄåÈÅ∏Âì™È°ÜÂúüË±Ü„ÄçÂ∞èÈÅäÊà≤ÔºöÈÄöÈÅéÈÅäÊà≤Â≠∏ÁøíËæ®Ë≠òË©êÈ®ôË®äÊÅØ\n\n" \
                        f"Ë´ãÈÅ∏ÊìáÊÇ®ÊÉ≥ÂòóË©¶ÁöÑÂäüËÉΩÔºö"
            
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="ÂàÜÊûêÂèØÁñëË®äÊÅØ", text="Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö")),
                QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü")),
                QuickReplyButton(action=MessageAction(label="Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®"))
            ])
            
            line_bot_api.reply_message(reply_token, TextSendMessage(text=reply_text, quick_reply=quick_reply))
            firebase_manager.save_user_interaction(user_id, display_name, text_message, "ÂõûË¶ÜÂäüËÉΩË™™Êòé", is_fraud_related=False)
            return
        
        # ËôïÁêÜÈúÄË¶ÅËøΩÂïèÁöÑÊÉÖÊ≥Å (‰æãÂ¶ÇÁî®Êà∂ÊòéÁ¢∫Ë°®Á§∫Ë¢´Ë©êÈ®ô)
        if any(pattern in text_message.lower() for pattern in follow_up_patterns):
            follow_up_reply_text = (
                f"{display_name}ÊÇ®Â•ΩÔºÅË´ã‰∏çË¶ÅÊìîÂøÉÔºåÊàë‰∫ÜËß£ÊÇ®ÂèØËÉΩÊ≠£Âú®ÊìîÂøÉÈÅáÂà∞Ë©êÈ®ôÊÉÖÊ≥Å„ÄÇ\n\n"
                f"ÁÇ∫‰∫ÜËÉΩÊõ¥Ê∫ñÁ¢∫Âú∞Âπ´Âä©ÊÇ®ÂàÜÊûêÔºåË´ãÊÇ®ÂëäË®¥ÊàëÊõ¥Â§öË©≥Á¥∞ÊÉÖÊ≥ÅÔºö\n\n"
                f"‚Ä¢ ÊÇ®Êî∂Âà∞‰∫Ü‰ªÄÈ∫ºÂèØÁñëË®äÊÅØÊàñÈõªË©±Ôºü\n"
                f"‚Ä¢ Â∞çÊñπÊèêÂá∫‰∫Ü‰ªÄÈ∫ºË¶ÅÊ±ÇÔºü\n"
                f"‚Ä¢ ÊÇ®ÊòØÂê¶Â∑≤Á∂ìÊèê‰æõÂÄã‰∫∫Ë≥áÊñôÊàñÈÄ≤Ë°å‰ªòÊ¨æÔºü\n\n"
                f"Ë´ãÂ∞áÂèØÁñëÂÖßÂÆπÂàÜ‰∫´Áµ¶ÊàëÔºåÊàëÊúÉÁ´ãÂç≥ÁÇ∫ÊÇ®ÂàÜÊûêÈ¢®Èö™ÔºÅ\n\n"
                f"„ÄêÊ∫´È¶®ÊèêÈÜí„ÄëÔºöË´ã‰∏ÄÊ¨°ÊÄßÂ∞áÂÆåÊï¥ÊÉÖÊ≥ÅÊèèËø∞Ê∏ÖÊ•öÔºåÈÅøÂÖçÂàÜÊàêÂ§öÂâáÁü≠Ë®äÊÅØÁôºÈÄÅÔºåÈÄôÊ®£ÊàëÊâçËÉΩÊõ¥Ê∫ñÁ¢∫Âú∞ÁêÜËß£‰∏¶ÂàÜÊûêÊÇ®ÈÅáÂà∞ÁöÑÊÉÖÊ≥Å„ÄÇ"
            )
            
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="ÂàÜÊûêÂèØÁñëË®äÊÅØ", text="Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö")),
                QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü")),
                QuickReplyButton(action=MessageAction(label="Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®"))
            ])
            
            line_bot_api.reply_message(event.reply_token, TextSendMessage(text=follow_up_reply_text, quick_reply=quick_reply))
            firebase_manager.save_user_interaction(
                user_id, display_name, text_message, 
                "Responded to follow-up pattern with clarifying questions", 
                is_fraud_related=True 
            )
            return

    # ËôïÁêÜ„ÄåÈÅ∏Âì™È°ÜÂúüË±Ü„ÄçÈÅäÊà≤Ëß∏Áôº (Ê≥®ÊÑèÔºöÈÄôÈÉ®ÂàÜ‰ª£Á¢ºÂæûuser_game_stateÊ¢ù‰ª∂ÂÖßÁßªÂá∫)
    if any(keyword in text_message.lower() for keyword in potato_game_trigger_keywords):
        logger.info(f"User {user_id} triggered potato game.")
        firebase_manager.save_user_interaction(
            user_id, display_name, text_message, 
            "ÂïüÂãï„ÄåÈÅ∏Âì™È°ÜÂúüË±Ü„ÄçÈÅäÊà≤", is_fraud_related=False
        )
        send_potato_game_question(user_id, reply_token)
        return

    # ËôïÁêÜË©êÈ®ôÈ°ûÂûãÂàóË°®Êü•Ë©¢
    if text_message.lower() == "Ë©êÈ®ôÈ°ûÂûãÂàóË°®" or text_message.lower() == "Ë©êÈ®ôÈ°ûÂûã":
        logger.info(f"User {user_id} is querying fraud types list")
        types_text = "ÁõÆÂâçÂ∑≤Êî∂ÈõÜÁöÑË©êÈ®ôÈ°ûÂûãÊúâÔºö\n"
        for f_type, info in fraud_types.items():
            types_text += f"\n‚ö†Ô∏è {f_type}Ôºö\n{info['description']}\n"
        
        types_text += "\nÊÉ≥‰∫ÜËß£ÁâπÂÆöÈ°ûÂûãÔºåÂèØ‰ª•ÂïèÊàë„Äå‰ªÄÈ∫ºÊòØ[Ë©êÈ®ôÈ°ûÂûã]„ÄçÂñîÔºÅ"

        quick_reply_items = []
        for f_type in list(fraud_types.keys())[:4]:  # Âè™ÂèñÂâç4ÂÄãË©êÈ®ôÈ°ûÂûã‰ΩúÁÇ∫Âø´ÈÄüÂõûË¶Ü
            quick_reply_items.append(QuickReplyButton(action=MessageAction(label=f_type, text=f"‰ªÄÈ∫ºÊòØ{f_type}")))

        line_bot_api.reply_message(reply_token, TextSendMessage(text=types_text, quick_reply=QuickReply(items=quick_reply_items) if quick_reply_items else None))
        firebase_manager.save_user_interaction(user_id, display_name, text_message, "Provided list of fraud types", is_fraud_related=False)
        return
        
    # ËôïÁêÜÁâπÂÆöË©êÈ®ôÈ°ûÂûãË≥áË®äÊü•Ë©¢ (‰æãÂ¶Ç "‰ªÄÈ∫ºÊòØÁ∂≤Ë∑ØË≥ºÁâ©Ë©êÈ®ô")
    specific_type_query_match = re.match(r"^(‰ªÄÈ∫ºÊòØ|Êü•Ë©¢|ÊàëÊÉ≥‰∫ÜËß£|ÊàëÊÉ≥Áü•ÈÅì)(.+Ë©êÈ®ô)$", text_message.strip())
    if specific_type_query_match:
        query_type = specific_type_query_match.group(2).strip()
        logger.info(f"User {user_id} is querying about specific fraud type: {query_type}")
        
        matched_fraud_type = None
        for f_type, info in fraud_types.items():
            if query_type in f_type or f_type in query_type:
                matched_fraud_type = f_type
                break
        
        if matched_fraud_type:
            info = fraud_types[matched_fraud_type]
            response_text = f"‚ö†Ô∏è {matched_fraud_type} ‚ö†Ô∏è\n\n{info['description']}\n\n"
            
            if info.get('examples') and len(info['examples']) > 0:
                response_text += "üìã Ê°à‰æãÔºö\n" + info['examples'][0] + "\n\n"
            
            if info.get('sop') and len(info['sop']) > 0:
                response_text += "üõ°Ô∏è Èò≤ÁØÑÊñπÊ≥ïÔºö\n" + "\n".join(info['sop'][:5]) + "\n"
            
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="Êü•ÁúãÂÖ∂‰ªñË©êÈ®ôÈ°ûÂûã", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®")),
                QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü")),
                QuickReplyButton(action=MessageAction(label="ÂàÜÊûêÂèØÁñëË®äÊÅØ", text="Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö"))
            ])
            
            line_bot_api.reply_message(reply_token, TextSendMessage(text=response_text, quick_reply=quick_reply))
            firebase_manager.save_user_interaction(user_id, display_name, text_message, f"Provided info about {matched_fraud_type}", is_fraud_related=False)
            return
        else:
            # Êú™ÊâæÂà∞ÂåπÈÖçÁöÑË©êÈ®ôÈ°ûÂûãÔºåÁµ¶Âá∫‰∏ÄËà¨ÊÄßÂõûË¶Ü
            response_text = f"Êä±Ê≠âÔºåÊàëÁõÆÂâçÊ≤íÊúâÈóúÊñº„Äå{query_type}„ÄçÁöÑË©≥Á¥∞Ë≥áË®ä„ÄÇ\n\n‰ª•‰∏ãÊòØÊàëÂ∑≤Êî∂ÈõÜÁöÑË©êÈ®ôÈ°ûÂûãÔºåÊÇ®ÂèØ‰ª•Êü•Ë©¢ÈÄô‰∫õÔºö"
            for f_type in fraud_types.keys():
                response_text += f"\n- {f_type}"
            
            quick_reply = QuickReply(items=[
                QuickReplyButton(action=MessageAction(label="Êü•ÁúãË©êÈ®ôÈ°ûÂûãÂàóË°®", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®")),
                QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü"))
            ])
            
            line_bot_api.reply_message(reply_token, TextSendMessage(text=response_text, quick_reply=quick_reply))
            firebase_manager.save_user_interaction(user_id, display_name, text_message, "Responded to unknown fraud type query", is_fraud_related=False)
            return

    # Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë´ãÊ±ÇÂàÜÊûêÁöÑÊèêÁ§∫Ë™û
    analysis_prompts = ["Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö", "Âπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØ", "ÂàÜÊûêÈÄôÂâáË®äÊÅØ", "Âπ´ÊàëÂàÜÊûêË®äÊÅØ"]
    if any(text_message.strip() == prompt or text_message.strip() == prompt.rstrip("Ôºö") for prompt in analysis_prompts):
        logger.info(f"User {user_id} requested message analysis but didn't provide message content")
        prompt_reply = f"{display_name}ÔºåÊÇ®Â•ΩÔºÅË´ãÂ∞áÊÇ®ÊÉ≥Ë¶ÅÂàÜÊûêÁöÑÂèØÁñëË®äÊÅØÂÆåÊï¥ÁôºÈÄÅÁµ¶ÊàëÔºåÊàëÊúÉÁ´ãÂç≥ÁÇ∫ÊÇ®ÈÄ≤Ë°åË©êÈ®ôÈ¢®Èö™Ë©ï‰º∞„ÄÇ\n\n‰æãÂ¶ÇÔºö\n- ÈäÄË°åÈÄöÁü•ÊÇ®ÁöÑÂ∏≥Êà∂Áï∞Â∏∏ÈúÄË¶ÅÊìç‰ΩúATM\n- ‰∏çÊòéÁ∂≤ÊãçË≥£ÂÆ∂Ë¶ÅÊ±ÇÁßÅ‰∏ã‰∫§Êòì\n- ÈôåÁîü‰∫∫ÂÇ≥‰æÜÁöÑÊäïË≥áÁêÜË≤°Ë®äÊÅØ\nÁ≠âÁ≠â„ÄÇ"
        
        quick_reply = QuickReply(items=[
            QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü")),
            QuickReplyButton(action=MessageAction(label="Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®"))
        ])
        
        line_bot_api.reply_message(reply_token, TextSendMessage(text=prompt_reply, quick_reply=quick_reply))
        firebase_manager.save_user_interaction(user_id, display_name, text_message, "Responded to analysis request prompt", is_fraud_related=False)
        return

    # Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÂ∞çÊ∂àÊÅØÈÄ≤Ë°åË©êÈ®ôÂàÜÊûêÁöÑÈÇèËºØ
    def should_perform_fraud_analysis(text_message):
        # 1. Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´Â∏∏Ë¶ãÂïèÂÄôË©û
        common_greetings = ["‰Ω†Â•Ω", "Âó®", "ÂìàÂõâ", "Âòø", "hi", "hello", "hey", "Êó©ÂÆâ", "ÂçàÂÆâ", "ÊôöÂÆâ"]
        if text_message.lower() in common_greetings or (len(text_message) <= 5 and any(greeting in text_message.lower() for greeting in common_greetings)):
            return False
            
        # 2. Ê™¢Êü•ÊòØÂê¶ÊòØÂäüËÉΩÁõ∏ÈóúÊåá‰ª§
        if any(keyword in text_message.lower() for keyword in function_inquiry_keywords + potato_game_trigger_keywords) or "Ë©êÈ®ôÈ°ûÂûã" in text_message:
            return False
            
        # 3. Ê™¢Êü•ÊòØÂê¶ÊòØË∑üË∏™Ê®°ÂºèÁöÑÂïèÂè•
        if any(pattern in text_message.lower() for pattern in follow_up_patterns):
            return True
            
        # 4. Ê™¢Êü•ÊòØÂê¶ÊòØË´ãÊ±ÇÂàÜÊûêÁöÑÊòéÈ°ØÁâπÂæµ
        analysis_indicators = ["Âπ´ÊàëÂàÜÊûê", "Âπ´ÂøôÁúãÁúã", "ÈÄôÊòØ‰∏çÊòØË©êÈ®ô", "ÈÄôÊòØÁúüÁöÑÂóé", "ÈÄôÂèØÈù†Âóé", "ÂàÜÊûê‰∏Ä‰∏ã", "ÈÄôÊ®£ÊòØË©êÈ®ôÂóé"]
        if any(indicator in text_message for indicator in analysis_indicators):
            return True
            
        # 5. Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´ÁâπÂÆöË©êÈ®ôÁõ∏ÈóúÈóúÈçµË©û
        # Âè™Êúâ‰ΩøÁî®ËÄÖÊòéÁ¢∫Ë°®Á§∫ÈúÄË¶ÅÂàÜÊûêÔºåÊàñËÄÖÊñáÊú¨ÂåÖÂê´Â§öÂÄãË©êÈ®ôÈóúÈçµË©ûÊâçÈÄ≤Ë°åÂàÜÊûê
        fraud_related_keywords = ["Ë©êÈ®ô", "Ë¢´È®ô", "È®ôÂ≠ê", "ÂèØÁñë", "ËΩâÂ∏≥", "ÂåØÊ¨æ", "ÈäÄË°åÂ∏≥Ëôü", "ÂÄãË≥á", "Ë∫´‰ªΩË≠â", "ÂØÜÁ¢º", 
                                "ÈÄöÁü•", "‰∏≠Áçé", "Ë≤∏Ê¨æ", "ÊäïË≥á", "ÊÄ•ÈúÄ", "Âπ´ÊàëËôïÁêÜ", "ÊÄ•Áî®", "Ëß£Èô§Ë®≠ÂÆö", "ÊèêÊ¨æÂç°", 
                                "Áõ£ÁÆ°Â∏≥Êà∂", "Ëß£Âáç", "ÂÆâÂÖ®Â∏≥Êà∂", "Á∞ΩË≠â", "‰øùË≠âÈáë", "ÈÅïÊ≥ï", "Ê¥óÈå¢", "Ë≠¶ÂØü", "Ê™¢ÂØüÂÆò"]
                                
        # Ë¶ÅÊ±ÇËá≥Â∞ëÂåÖÂê´ÂÖ©ÂÄãË©êÈ®ôÁõ∏ÈóúÈóúÈçµË©û
        keyword_count = sum(1 for keyword in fraud_related_keywords if keyword in text_message)
        if keyword_count >= 2:
            return True
            
        # ÈóúÈçµËÆäÂåñÔºö‰∏çÂÜç‰ΩøÁî®„ÄåÊ∂àÊÅØÈï∑Â∫¶>20„Äç‰ΩúÁÇ∫Ëá™ÂãïÂàÜÊûêÁöÑÊ¢ù‰ª∂
        # Êõ¥ÊòéÁ¢∫ÁöÑÂà§Êñ∑ÊòØÁî®Êà∂ÊòØÂê¶ÂØ¶ÈöõË´ãÊ±ÇÂàÜÊûêË©êÈ®ôÈ¢®Èö™
            
        # 6. È†êË®≠‰∏çÈÄ≤Ë°åË©êÈ®ôÂàÜÊûêÔºåÂ∞áË®äÊÅØ‰ΩúÁÇ∫‰∏ÄËà¨ÈñíËÅäËôïÁêÜ
        return False

    # È†êË®≠‰ΩøÁî®ChatGPTÈÄ≤Ë°åÈñíËÅäÂõûÊáâÊàñË©êÈ®ôÂàÜÊûê
    logger.info(f"Message from {user_id}: {text_message} - Determining if fraud analysis is needed")
    
    # Âà§Êñ∑ÊòØÂê¶ÈúÄË¶ÅÈÄ≤Ë°åË©êÈ®ôÂàÜÊûê
    if should_perform_fraud_analysis(text_message):
        logger.info(f"Performing fraud analysis for message from {user_id}: {text_message}")
        # ‰ΩøÁî®ÁèæÊúâÁöÑË©êÈ®ôÂàÜÊûêÈÇèËºØÔºåÂÇ≥ÂÖ•user_id
        analysis_result_text = detect_fraud_with_chatgpt(text_message, display_name, user_id)
        analysis_data = parse_fraud_analysis(analysis_result_text)

        risk_level = analysis_data.get("risk_level", "‰∏çÁ¢∫ÂÆö")
        fraud_type = analysis_data.get("fraud_type", "Êú™Áü•")
        explanation = analysis_data.get("explanation", "ÂàÜÊûêÁµêÊûú‰∏çÂÆåÊï¥ÔºåË´ãË¨πÊÖéÂà§Êñ∑„ÄÇ")
        suggestions = analysis_data.get("suggestions", "Ë´ãÈö®ÊôÇ‰øùÊåÅË≠¶ÊÉï„ÄÇ")
        is_emerging = analysis_data.get("is_emerging", False)

        # ÂâµÂª∫‰∏¶ÁôºÈÄÅFlex MessageÂàÜÊûêÁµêÊûú
        flex_message = create_analysis_flex_message(analysis_data, display_name, text_message)
        line_bot_api.reply_message(reply_token, flex_message)

        if is_emerging and fraud_type != "ÈùûË©êÈ®ôÁõ∏Èóú":
            # Êñ∞Â¢ûË©êÈ®ôÊâãÊ≥ïË®òÈåÑÈÄöÁü•ÊîπÁÇ∫ÂñÆÁç®Êé®ÈÄÅÔºåÈÅøÂÖçÊ∑∑Ê∑ÜFlex Message
            emerging_text = "‚ö†Ô∏è ÈÄôÂèØËÉΩÊòØ‰∏ÄÁ®ÆÊñ∞ÁöÑË©êÈ®ôÊâãÊ≥ïÔºåÊàëÂ∑≤Á∂ìË®òÈåÑ‰∏ã‰æÜ‰∫ÜÔºåË¨ùË¨ùÊÇ®ÁöÑË≥áË®äÔºÅ"
            line_bot_api.push_message(user_id, TextSendMessage(text=emerging_text))
            firebase_manager.save_emerging_fraud_report(user_id, display_name, text_message, analysis_result_text)
            is_fraud_related = True
        elif fraud_type != "ÈùûË©êÈ®ôÁõ∏Èóú" and risk_level not in ["ÁÑ°È¢®Èö™", "‰Ωé"]: 
            is_fraud_related = True
        else:
            is_fraud_related = False
            
        # ‰øùÂ≠ò‰∫íÂãïË®òÈåÑÂà∞Firebase
        firebase_manager.save_user_interaction(
            user_id, display_name, text_message, analysis_result_text,
            is_fraud_related=is_fraud_related,
            fraud_type=fraud_type if is_fraud_related else None,
            risk_level=risk_level if is_fraud_related else None
        )
        return
    else:
        # ‰ΩøÁî®ChatGPTÈÄ≤Ë°åÈñíËÅäÂõûÊáâ
        logger.info(f"Using chat response for message from {user_id}: {text_message}")
        
        try:
            # Áç≤ÂèñÁî®Êà∂ÊúÄËøëÁöÑÂ∞çË©±Ê≠∑Âè≤
            recent_history = firebase_manager.get_recent_interactions(user_id, limit=5)
            
            # Ê∫ñÂÇôÂ∞çË©±Ê≠∑Âè≤Ê∂àÊÅØÂàóË°®
            chat_history = []
            
            # Á≥ªÁµ±ÊèêÁ§∫Ê∂àÊÅØ
            system_message = {
                "role": "system", 
                "content": "‰Ω†ÊòØ‰∏Ä‰ΩçÂêçÁÇ∫„ÄåÂúüË±Ü„ÄçÁöÑAIËÅäÂ§©Ê©üÂô®‰∫∫Ôºå‰Ω†ÁöÑÈ¢®Ê†ºÂèãÂñÑ„ÄÅÊ∫´Êöñ‰∏îË≤ºÂøÉ„ÄÇ‰Ω†ÈúÄË¶ÅÊ†πÊìö‰πãÂâçÁöÑÂ∞çË©±Ê≠∑Âè≤‰æÜÂõûÊáâÁî®Êà∂ÔºåÊèê‰æõÈÄ£Ë≤´‰∏îËá™ÁÑ∂ÁöÑÂ∞çË©±È´îÈ©ó„ÄÇ‰Ω†ÊòØÈò≤Ë©êÈ®ôÂ∞àÂÆ∂ÔºåÁï∂Áî®Êà∂Ë®éË´ñÂèØÁñëË®äÊÅØÊôÇÔºåË¶Å‰øùÊåÅË≠¶Ë¶∫„ÄÇ"
            }
            
            # Â¶ÇÊûúÊàêÂäüÁç≤ÂèñÂà∞Ê≠∑Âè≤Â∞çË©±ÔºåÂâá‰ΩøÁî®ÂÆÉÂÄë
            if recent_history:
                # Â∞áÊ≠∑Âè≤Â∞çË©±ËΩâÊèõÁÇ∫ChatGPTÊ†ºÂºè
                for interaction in recent_history:
                    # Áî®Êà∂Ê∂àÊÅØ
                    if 'message' in interaction and interaction['message']:
                        chat_history.append({
                            "role": "user",
                            "content": interaction['message']
                        })
                    
                    # Ê©üÂô®‰∫∫ÂõûÊáâ
                    if 'response' in interaction and interaction['response']:
                        chat_history.append({
                            "role": "assistant",
                            "content": interaction['response']
                        })
                
                logger.info(f"ÊàêÂäü‰ΩøÁî®Áî®Êà∂Ê≠∑Âè≤Â∞çË©±: {len(chat_history)} Ê¢ùÊ∂àÊÅØ")
            else:
                # Â¶ÇÊûúÊ≤íÊúâÊ≠∑Âè≤Â∞çË©±ÊàñÁôºÁîüÈåØË™§Ôºå‰ΩøÁî®Á©∫ÁöÑÊ≠∑Âè≤
                logger.info("ÁÑ°Ê≥ïÁç≤ÂèñÁî®Êà∂Ê≠∑Âè≤Â∞çË©±Ôºå‰ΩøÁî®Á©∫Ê≠∑Âè≤")
            
            # Ê∑ªÂä†Áï∂ÂâçÁî®Êà∂Ê∂àÊÅØ
            current_user_message = {
                "role": "user",
                "content": text_message
            }
            
            # ÊßãÂª∫ÂÆåÊï¥ÁöÑÊ∂àÊÅØÂàóË°®
            messages = [system_message] + chat_history + [current_user_message]
            
            # ÈôêÂà∂Ê∂àÊÅØÊï∏ÈáèÔºåÈÅøÂÖçË∂ÖÂá∫APIÈôêÂà∂
            if len(messages) > 10:
                # ‰øùÁïôÁ≥ªÁµ±Ê∂àÊÅØÂíåÊúÄËøëÁöÑÂ∞çË©±
                messages = [system_message] + messages[-9:]
            
            logger.info(f"‰ΩøÁî®Ë®òÊÜ∂ÂäüËÉΩÔºåÁ∏ΩÂÖ±Êèê‰æõ {len(messages)} Ê¢ùÊ∂àÊÅØÁµ¶ChatGPT")
            
            # ‰ΩøÁî®Êõ¥ÂèãÂñÑÁöÑÈñíËÅäÂõûÊáâ‰∏¶Â∏∂ÊúâË®òÊÜ∂ÂäüËÉΩ
            chat_response = openai.chat.completions.create(
                model=os.environ.get('OPENAI_MODEL', 'gpt-3.5-turbo'),
                messages=messages,
                temperature=0.7,
                max_tokens=200
            )
            
            chat_reply = chat_response.choices[0].message.content.strip()
            
            # Âè™Âú®È¶ñÊ¨°ËÅäÂ§©ÊôÇÊ∑ªÂä†ÂäüËÉΩ‰ªãÁ¥π
            if is_first_time:
                introduction = f"\n\nÊàëÊòØÈò≤Ë©êÈ®ôÊ©üÂô®‰∫∫„ÄåÂúüË±Ü„ÄçÔºåËÉΩÂπ´ÊÇ®Ôºö\n1Ô∏è‚É£ ÂàÜÊûêÂèØÁñëË®äÊÅØ\n2Ô∏è‚É£ Ê∏¨Ë©¶ÊÇ®ÁöÑÈò≤Ë©êÈ®ôËÉΩÂäõ\n3Ô∏è‚É£ Êü•Ë©¢ÂêÑÈ°ûË©êÈ®ôÊâãÊ≥ï"
                reply_text = chat_reply + introduction
            else:
                reply_text = chat_reply
            
            is_fraud_related = False
            
        except Exception as e:
            logger.error(f"ÈñíËÅäÂõûÊáâÈåØË™§: {e}")
            # Â¶ÇÊûúÈñíËÅäÂõûÊáâÂ§±ÊïóÔºå‰ΩøÁî®Á∞°ÂñÆÁöÑÂïèÂÄô
            greetings = ["ÊÇ®Â•ΩÔºÅ", "Âó®ÔºÅ", "ÂìàÂõâÔºÅ", "ÂæàÈ´òËààË¶ãÂà∞ÊÇ®ÔºÅ", "ÊÇ®Â•ΩÂëÄÔºÅ"]
            
            # Âè™Âú®È¶ñÊ¨°ËÅäÂ§©ÊôÇÊ∑ªÂä†ÂäüËÉΩ‰ªãÁ¥π
            if is_first_time:
                reply_text = f"{random.choice(greetings)}Êúâ‰ªÄÈ∫ºÊàëËÉΩÂπ´ÊÇ®ÁöÑÂóéÔºüÊÇ®ÂèØ‰ª•Ëº∏ÂÖ•„ÄåÂäüËÉΩ„Äç‰æÜ‰∫ÜËß£ÊàëËÉΩÂÅö‰ªÄÈ∫º„ÄÇ"
            else:
                reply_text = f"{random.choice(greetings)}Êúâ‰ªÄÈ∫ºÊàëËÉΩÂπ´ÊÇ®ÁöÑÂóéÔºü"
            
            is_fraud_related = False
    
    # Ê∑ªÂä†ÂäüËÉΩÊåâÈàïÂà∞ÊâÄÊúâÂõûË¶Ü
    quick_reply = QuickReply(items=[
        QuickReplyButton(action=MessageAction(label="ÂàÜÊûêÂèØÁñëË®äÊÅØ", text="Ë´ãÂπ´ÊàëÂàÜÊûêÈÄôÂâáË®äÊÅØÔºö")),
        QuickReplyButton(action=MessageAction(label="Èò≤Ë©êÈ®ôËÉΩÂäõÊ∏¨Ë©¶", text="ÈÅ∏Âì™È°ÜÂúüË±Ü")),
        QuickReplyButton(action=MessageAction(label="Ë©êÈ®ôÈ°ûÂûãÊü•Ë©¢", text="Ë©êÈ®ôÈ°ûÂûãÂàóË°®"))
    ])
    
    line_bot_api.reply_message(reply_token, TextSendMessage(text=reply_text, quick_reply=quick_reply))
    
    # ‰øùÂ≠ò‰∫íÂãïË®òÈåÑÂà∞Firebase
    firebase_manager.save_user_interaction(
        user_id, display_name, text_message, reply_text,
        is_fraud_related=is_fraud_related,
        fraud_type=fraud_type if is_fraud_related else None,
        risk_level=risk_level if is_fraud_related else None
    )

@handler.add(PostbackEvent)
def handle_postback(event):
    user_id = event.source.user_id
    reply_token = event.reply_token
    postback_data_str = event.postback.data
    
    logger.info(f"Êé•Êî∂Âà∞‰æÜËá™ {user_id} ÁöÑ Postback: {postback_data_str}")
    
    # Ëß£Êûê postback_data (e.g., "action=value&key=value")
    # Ensure robust parsing for various possible postback data formats
    try:
        data_params = dict(item.split("=", 1) for item in postback_data_str.split("&") if "=" in item)
    except ValueError:
        logger.error(f"ÁÑ°Ê≥ïËß£Êûê Postback data: {postback_data_str}")
        data_params = {} # Avoid crashing if data is malformed

    action = data_params.get('action')
    uid_from_data = data_params.get('uid')

    if uid_from_data and uid_from_data != user_id:
       logger.warning(f"User ID mismatch in postback: event.source.user_id={user_id}, data_params.uid={uid_from_data}. Using event.source.user_id.")
       # Prefer user_id from event source for security and consistency.

    profile = get_user_profile(user_id) # Get profile for display name if needed
    display_name = profile.display_name if profile and profile.display_name else "‰ΩøÁî®ËÄÖ"

    if action == 'potato_game_answer':
        logger.info(f"User {display_name}({user_id}) answered potato game.")
        # Log game interaction before handling answer
        chosen_option = data_params.get('chosen_option_id', 'N/A')
        firebase_manager.save_user_interaction(
            user_id, display_name, f"PotatoGame_Answer:{chosen_option}", 
            "ËôïÁêÜ„ÄåÈÅ∏Âì™È°ÜÂúüË±Ü„ÄçÈÅäÊà≤Á≠îÊ°à", is_fraud_related=False 
        )
        handle_potato_game_answer(user_id, reply_token, data_params)
        return
    elif action == 'start_potato_game':
        logger.info(f"User {display_name}({user_id}) wants to play potato game again.")
        firebase_manager.save_user_interaction(
            user_id, display_name, "PotatoGame_Restart", 
            "ÈáçÊñ∞ÈñãÂßã„ÄåÈÅ∏Âì™È°ÜÂúüË±Ü„ÄçÈÅäÊà≤", is_fraud_related=False
        )
        send_potato_game_question(user_id, reply_token)
        return
    
    # ‰Ω†ÂèØ‰ª•Âú®ÈÄôË£°Ê∑ªÂä†Êõ¥Â§öÁöÑ postback ËôïÁêÜÈÇèËºØ
    # ‰æãÂ¶ÇËôïÁêÜÂÖ∂‰ªñ Flex Message ÊåâÈàïÁöÑÈªûÊìä‰∫ã‰ª∂

    else:
        logger.warning(f"Êú™Áü•ÁöÑ Postback action: {action} from user {user_id}")
        # line_bot_api.reply_message(reply_token, TextSendMessage(text="Êî∂Âà∞‰∏ÄÂÄãÊàëÁÑ°Ê≥ïËôïÁêÜÁöÑÊåá‰ª§ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°„ÄÇ"))
        # Decided not to reply for unknown postbacks to avoid interrupting other flows or causing confusion.
        # If specific unhandled postbacks need a reply, add explicit conditions.

# ËºâÂÖ•Ë©êÈ®ôÈ°åÂ∫´
POTATO_GAME_QUESTIONS_DB = "potato_game_questions.json"
potato_game_questions = []

def load_potato_game_questions():
    global potato_game_questions
    try:
        # Ë®òÈåÑËºâÂÖ•ÂâçÁöÑË∑ØÂæë‰ø°ÊÅØ
        file_path = os.path.abspath(POTATO_GAME_QUESTIONS_DB)
        logger.info(f"ÂòóË©¶ÂæûË∑ØÂæëËÆÄÂèñÈ°åÂ∫´Êñá‰ª∂: {file_path}")
        logger.info(f"Áï∂ÂâçÂ∑•‰ΩúÁõÆÈåÑ: {os.getcwd()}")
        
        # Ê™¢Êü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
        if not os.path.exists(file_path):
            logger.error(f"Êñá‰ª∂‰∏çÂ≠òÂú®: {file_path}")
            potato_game_questions = []
            return
            
        with open(POTATO_GAME_QUESTIONS_DB, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
            # ËôïÁêÜ‰∏çÂêåÁöÑJSONÁµêÊßã
            all_questions = []
            
            if isinstance(data, dict) and "questions" in data:
                # ËôïÁêÜÈ†ÇÂ±§questions
                top_questions = data.get("questions", [])
                
                for q in top_questions:
                    # Ê™¢Êü•ÊòØÂê¶ÊúâÂµåÂ•óÁöÑquestionsÊï∏ÁµÑ
                    if isinstance(q, dict) and "questions" in q:
                        # Â∞áÂµåÂ•óÁöÑquestionsÊ∑ªÂä†Âà∞Á∏ΩÈ°åÂ∫´
                        nested_questions = q.get("questions", [])
                        all_questions.extend(nested_questions)
                        logger.info(f"ÁôºÁèæÂµåÂ•óÈ°åÁõÆÔºö{len(nested_questions)}È°å")
                    else:
                        # Â∞áÈ†ÇÂ±§È°åÁõÆÊ∑ªÂä†Âà∞Á∏ΩÈ°åÂ∫´
                        all_questions.append(q)
            
            potato_game_questions = all_questions
            
        # Á¢∫Ë™çÊñá‰ª∂ÂÖßÂÆπ
        first_three_questions = []
        for i, q in enumerate(potato_game_questions[:3]):
            first_three_questions.append(f"È°åÁõÆID: {q.get('id')}, Ë©êÈ®ôÈ°ûÂûã: {q.get('fraud_type')}")
            
        logger.info(f"ÊàêÂäüÂæû {POTATO_GAME_QUESTIONS_DB} Âä†ËºâË©êÈ®ôÈ°åÂ∫´ÔºåÂÖ± {len(potato_game_questions)} ÈÅìÈ°åÁõÆ")
        logger.info(f"Ââç‰∏âÂÄãÈ°åÁõÆ: {', '.join(first_three_questions)}")
        logger.info(f"È°åÂ∫´‰∏≠ÈÅ∏È†Ö‰ø°ÊÅØ: ÊúâÈ†êË®≠ÈÅ∏È†ÖÁöÑÈ°åÁõÆÊï∏Èáè: {sum(1 for q in potato_game_questions if 'options' in q and q['options'] and 'correct_option' in q)}")
    except FileNotFoundError:
        logger.warning(f"Ë©êÈ®ôÈ°åÂ∫´Êñá‰ª∂ {POTATO_GAME_QUESTIONS_DB} Êú™ÊâæÂà∞„ÄÇ")
        potato_game_questions = []
    except json.JSONDecodeError:
        logger.error(f"Ëß£ÊûêË©êÈ®ôÈ°åÂ∫´Êñá‰ª∂ {POTATO_GAME_QUESTIONS_DB} Â§±Êïó„ÄÇ")
        potato_game_questions = []
    except Exception as e:
        logger.error(f"Âä†ËºâË©êÈ®ôÈ°åÂ∫´ÊôÇÁôºÁîüÊú™Áü•ÈåØË™§: {e}")
        potato_game_questions = []

load_fraud_tactics()
load_potato_game_questions()  # Âä†ËºâÈ°åÂ∫´

if __name__ == "__main__":
    # Á¢∫‰øùÂú®ÊúçÂãôÂïüÂãïÊôÇÈáçÊñ∞Âä†ËºâÈ°åÂ∫´
    load_fraud_tactics()
    load_potato_game_questions()
    
    # ÊâìÂç∞È°åÂ∫´Âä†ËºâÁµêÊûú
    logger.info(f"ÊúçÂãôÂïüÂãïÊôÇËºâÂÖ•È°åÂ∫´Ôºöpotato_game_questions ÂåÖÂê´ {len(potato_game_questions)} ÈÅìÈ°åÁõÆ")
    logger.info(f"È°åÂ∫´‰∏≠ÊúâÈÅ∏È†ÖÁöÑÈ°åÁõÆÊï∏Èáè: {sum(1 for q in potato_game_questions if 'options' in q and q['options'] and 'correct_option' in q)}")
    if potato_game_questions:
        logger.info(f"È°åÂ∫´Ë∑ØÂæë: {os.path.abspath(POTATO_GAME_QUESTIONS_DB)}")
        logger.info(f"Â∑•‰ΩúÁõÆÈåÑ: {os.getcwd()}")
        
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port) 