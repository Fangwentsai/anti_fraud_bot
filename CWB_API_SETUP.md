# 中央氣象署 API 設定指南

## 📋 概述

我們的防詐騙LINE Bot現在整合了**中央氣象署開放資料平臺**的真實天氣API，可以提供準確的天氣預報資訊。

## 🔑 API金鑰申請

### 1. 前往中央氣象署開放資料平臺
- 網址：https://opendata.cwa.gov.tw/
- 點擊「會員註冊」或「登入」

### 2. 註冊帳號
- 填寫基本資料
- 驗證電子郵件
- 完成註冊

### 3. 申請API金鑰
- 登入後點擊「API金鑰管理」
- 點擊「新增API金鑰」
- 填寫申請資訊：
  - **應用名稱**：防詐騙LINE Bot
  - **應用說明**：提供天氣查詢功能的防詐騙機器人
  - **使用目的**：教育/公益用途
- 提交申請並等待審核

### 4. 獲取API金鑰
- 審核通過後，在「API金鑰管理」頁面可以看到您的金鑰
- 格式類似：`CWA-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX`

## ⚙️ 環境設定

### 本地開發環境
```bash
# 設定環境變數
export CWB_API_KEY="您的API金鑰"

# 或者在 .env 檔案中設定
echo "CWB_API_KEY=您的API金鑰" >> .env
```

### Render.com 生產環境
1. 登入 Render.com 控制台
2. 進入您的服務設定
3. 點擊「Environment」標籤
4. 新增環境變數：
   - **Key**: `CWB_API_KEY`
   - **Value**: `您的API金鑰`
5. 點擊「Save Changes」

## 📊 使用的API

### F-C0032-001 - 一般天氣預報
- **功能**：今明36小時天氣預報
- **涵蓋範圍**：全台22個縣市
- **更新頻率**：每6小時更新
- **資料內容**：
  - 天氣現象 (Wx)
  - 降雨機率 (PoP)
  - 最高溫度 (MaxT)
  - 最低溫度 (MinT)
  - 舒適度指數 (CI)

## 🌍 支援城市

| 用戶輸入 | API標準名稱 | 用戶輸入 | API標準名稱 |
|---------|------------|---------|------------|
| 台北 | 臺北市 | 台中 | 臺中市 |
| 新北 | 新北市 | 台南 | 臺南市 |
| 桃園 | 桃園市 | 高雄 | 高雄市 |
| 基隆 | 基隆市 | 新竹 | 新竹市 |
| 苗栗 | 苗栗縣 | 彰化 | 彰化縣 |
| 南投 | 南投縣 | 雲林 | 雲林縣 |
| 嘉義 | 嘉義縣 | 屏東 | 屏東縣 |
| 宜蘭 | 宜蘭縣 | 花蓮 | 花蓮縣 |
| 台東 | 臺東縣 | 澎湖 | 澎湖縣 |
| 金門 | 金門縣 | 連江 | 連江縣 |

## 🔧 測試API整合

### 運行測試腳本
```bash
python3 test_real_weather_api.py
```

### 測試天氣查詢
```bash
python3 -c "from weather_service import handle_weather_query; print(handle_weather_query('台北天氣', '測試用戶'))"
```

## 📈 API使用限制

### 免費方案
- **每日請求次數**：1,000次
- **每分鐘請求次數**：10次
- **適用範圍**：個人開發、教育用途

### 商業方案
- 如需更高的請求限制，可申請商業方案
- 詳情請參考官方網站

## 🛡️ 降級機制

當API無法使用時，系統會自動：
1. 記錄錯誤日誌
2. 切換到模擬天氣資料
3. 在回應中標註「模擬資料」
4. 提醒用戶參考官方氣象資訊

## 🔍 故障排除

### 常見問題

#### 1. API金鑰無效
```
錯誤：401 Unauthorized
解決：檢查API金鑰是否正確設定
```

#### 2. 請求次數超限
```
錯誤：429 Too Many Requests
解決：等待一段時間後重試，或升級API方案
```

#### 3. 城市名稱不支援
```
錯誤：找不到城市資料
解決：檢查城市名稱是否在支援列表中
```

#### 4. 網路連線問題
```
錯誤：Connection timeout
解決：檢查網路連線，系統會自動降級到模擬資料
```

## 📞 技術支援

- **中央氣象署開放資料平臺**：https://opendata.cwa.gov.tw/
- **API文件**：https://opendata.cwa.gov.tw/dist/opendata-swagger.html
- **客服信箱**：opendata@cwa.gov.tw

## 🎉 效果對比

### 設定API金鑰前（模擬資料）
```
@用戶 🌤️ 台北 今日天氣
📅 2025-05-24 週六
☁️ 天氣：晴天
🌡️ 溫度：18°C - 25°C
💧 濕度：60%
☔ 降雨機率：20%
📡 資料來源：模擬資料
⚠️ 此為模擬資料，實際天氣請參考中央氣象署
```

### 設定API金鑰後（真實資料）
```
@用戶 🌤️ 台北 今日天氣
📅 2025-05-24 週六
☁️ 天氣：多雲時晴
🌡️ 溫度：18°C - 25°C
💧 濕度：65%
☔ 降雨機率：20%
⏰ 時段：06:00 - 18:00
📡 資料來源：中央氣象署
⏰ 更新時間：2025-05-24 11:30:15
ℹ️ 實際天氣以中央氣象署為準
``` 